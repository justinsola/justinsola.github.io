// Generated by scripts/build-grid-editor.js from files in src/. Do not edit directly.
function _regeneratorValues(e){if(null!=e){var t=e["function"==typeof Symbol&&Symbol.iterator||"@@iterator"],r=0;if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}throw new TypeError(_typeof(e)+" is not iterable")}function _regenerator(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function i(r,n,o,i){var c=n&&n.prototype instanceof Generator?n:Generator,u=Object.create(c.prototype);return _regeneratorDefine2(u,"_invoke",function(r,n,o){var i,c,u,f=0,p=o||[],y=!1,G={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,r){return i=t,c=0,u=e,G.n=r,a}};function d(r,n){for(c=r,u=n,t=0;!y&&f&&!o&&t<p.length;t++){var o,i=p[t],d=G.p,l=i[2];r>3?(o=l===n)&&(u=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=e):i[0]<=d&&((o=r<2&&d<i[1])?(c=0,G.v=n,G.n=i[1]):d<l&&(o=r<3||i[0]>n||n>l)&&(i[4]=r,i[5]=n,G.n=l,c=0))}if(o||r>1)return a;throw y=!0,n}return function(o,p,l){if(f>1)throw TypeError("Generator is already running");for(y&&1===p&&d(p,l),c=p,u=l;(t=c<2?e:u)||!y;){i||(c?c<3?(c>1&&(G.n=-1),d(c,u)):G.n=u:G.v=u);try{if(f=2,i){if(c||(o="next"),t=i[o]){if(!(t=t.call(i,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,c<2&&(c=0)}else 1===c&&(t=i.return)&&t.call(i),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=e}else if((t=(y=G.n<0)?u:r.call(n,G))!==a)break}catch(t){i=e,c=1,u=t}finally{f=1}}return{value:t,done:y}}}(r,o,i),!0),u}var a={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}t=Object.getPrototypeOf;var c=[][n]?t(t([][n]())):(_regeneratorDefine2(t={},n,function(){return this}),t),u=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(c);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,GeneratorFunctionPrototype):(e.__proto__=GeneratorFunctionPrototype,_regeneratorDefine2(e,o,"GeneratorFunction")),e.prototype=Object.create(u),e}return GeneratorFunction.prototype=GeneratorFunctionPrototype,_regeneratorDefine2(u,"constructor",GeneratorFunctionPrototype),_regeneratorDefine2(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName="GeneratorFunction",_regeneratorDefine2(GeneratorFunctionPrototype,o,"GeneratorFunction"),_regeneratorDefine2(u),_regeneratorDefine2(u,o,"Generator"),_regeneratorDefine2(u,n,function(){return this}),_regeneratorDefine2(u,"toString",function(){return"[object Generator]"}),(_regenerator=function(){return{w:i,m:f}})()}function _regeneratorDefine2(e,r,n,t){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}_regeneratorDefine2=function(e,r,n,t){function o(r,n){_regeneratorDefine2(e,r,function(e){return this._invoke(r,n,e)})}r?i?i(e,r,{value:n,enumerable:!t,configurable:!t,writable:!t}):e[r]=n:(o("next",0),o("throw",1),o("return",2))},_regeneratorDefine2(e,r,n,t)}function asyncGeneratorStep(n,t,e,r,o,a,c){try{var i=n[a](c),u=i.value}catch(n){return void e(n)}i.done?t(u):Promise.resolve(u).then(r,o)}function _asyncToGenerator(n){return function(){var t=this,e=arguments;return new Promise(function(r,o){var a=n.apply(t,e);function _next(n){asyncGeneratorStep(a,r,o,_next,_throw,"next",n)}function _throw(n){asyncGeneratorStep(a,r,o,_next,_throw,"throw",n)}_next(void 0)})}}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,o)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){_defineProperty(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toConsumableArray(r){return _arrayWithoutHoles(r)||_iterableToArray(r)||_unsupportedIterableToArray(r)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(r){if("undefined"!=typeof Symbol&&null!=r[Symbol.iterator]||null!=r["@@iterator"])return Array.from(r)}function _arrayWithoutHoles(r){if(Array.isArray(r))return _arrayLikeToArray(r)}function _classCallCheck(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(t){var i=_toPrimitive(t,"string");return"symbol"==_typeof(i)?i:i+""}function _toPrimitive(t,r){if("object"!=_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}function _slicedToArray(r,e){return _arrayWithHoles(r)||_iterableToArrayLimit(r,e)||_unsupportedIterableToArray(r,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}function _arrayWithHoles(r){if(Array.isArray(r))return r}function _createForOfIteratorHelper(r,e){var t="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=_unsupportedIterableToArray(r))||e&&r&&"number"==typeof r.length){t&&(r=t);var _n=0,F=function(){};return{s:F,n:function(){return _n>=r.length?{done:!0}:{done:!1,value:r[_n++]}},e:function(r){throw r},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,u=!1;return{s:function(){t=t.call(r)},n:function(){var r=t.next();return a=r.done,r},e:function(r){u=!0,o=r},f:function(){try{a||null==t.return||t.return()}finally{if(u)throw o}}}}function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}function _typeof(o){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}!function(root){"use strict";if(root){if(void 0===root.globalThis)try{Object.defineProperty(root,"globalThis",{value:root,configurable:!0,enumerable:!1,writable:!0})}catch(err){root.globalThis=root}!function(root){if(root){if(void 0===root.globalThis)try{Object.defineProperty(root,"globalThis",{value:root,configurable:!0,enumerable:!1,writable:!0})}catch(err){root.globalThis=root}var Global=root.globalThis||root;if("function"!=typeof Global.Promise){function isObjectOrFunction(value){return value&&("object"===_typeof(value)||"function"==typeof value)}function Promise(fn){if(!(this instanceof Promise))throw new TypeError("Promise must be called with new");if("function"!=typeof fn)throw new TypeError("Promise resolver must be a function");this._state=0,this._value=void 0,this._handlers=[],doResolve(fn,this)}function doResolve(fn,self){var done=!1;try{fn(function(value){done||(done=!0,resolve(self,value))},function(reason){done||(done=!0,reject(self,reason))})}catch(err){done||reject(self,err)}}function resolve(self,value){if(self===value)return reject(self,new TypeError("A promise cannot resolve itself"));if(isObjectOrFunction(value)){var then;try{then=value.then}catch(err){return reject(self,err)}if("function"==typeof then){var called=!1;try{then.call(value,function(val){called||(called=!0,resolve(self,val))},function(reason){called||(called=!0,reject(self,reason))})}catch(err){called||reject(self,err)}return}}self._state=1,self._value=value,finale(self)}function reject(self,reason){0===self._state&&(self._state=2,self._value=reason,finale(self))}function finale(self){for(var i=0;i<self._handlers.length;i++)handle(self,self._handlers[i]);self._handlers=[]}function Handler(onFulfilled,onRejected,resolve,reject){this.onFulfilled="function"==typeof onFulfilled?onFulfilled:null,this.onRejected="function"==typeof onRejected?onRejected:null,this.resolve=resolve,this.reject=reject}function handle(self,handler){0!==self._state?setTimeout(function(){var cb=1===self._state?handler.onFulfilled:handler.onRejected;if(cb)try{var result=cb(self._value);handler.resolve(result)}catch(err){handler.reject(err)}else 1===self._state?handler.resolve(self._value):handler.reject(self._value)},0):self._handlers.push(handler)}Promise.prototype.then=function(onFulfilled,onRejected){var self=this;return new Promise(function(resolveNext,rejectNext){handle(self,new Handler(onFulfilled,onRejected,resolveNext,rejectNext))})},Promise.prototype.catch=function(onRejected){return this.then(null,onRejected)},Promise.resolve=function(value){return value instanceof Promise?value:new Promise(function(resolve){resolve(value)})},Promise.reject=function(reason){return new Promise(function(_resolve,reject){reject(reason)})},Promise.all=function(iterable){return new Promise(function(resolveAll,rejectAll){if(iterable&&void 0!==iterable.length){var results=[],remaining=iterable.length;if(0!==remaining)for(var i=0;i<iterable.length;i++)resolver(i)(iterable[i]);else resolveAll(results)}else rejectAll(new TypeError("Promise.all expects an array"));function resolver(i){return function(value){Promise.resolve(value).then(function(val){results[i]=val,0===(remaining-=1)&&resolveAll(results)},rejectAll)}}})},Global.Promise=Promise}if("function"!=typeof Global.fetch){var supportsHeaders="function"==typeof Global.Headers;function parseHeaders(raw){var map={};if(!raw)return map;for(var pairs=raw.trim().split(/\r?\n/),i=0;i<pairs.length;i++){var line=pairs[i],index=line.indexOf(":");if(index>-1){var key=line.slice(0,index).trim().toLowerCase(),value=line.slice(index+1).trim();map[key]=value}}return map}function FetchResponse(xhr,url){this._xhr=xhr,this.type="basic",this.url="responseURL"in xhr&&xhr.responseURL?xhr.responseURL:url,this.status=void 0===xhr.status?0:xhr.status,this.ok=this.status>=200&&this.status<300,this.statusText=xhr.statusText||"",this.headers=supportsHeaders?new Headers(parseHeaders(xhr.getAllResponseHeaders())):parseHeaders(xhr.getAllResponseHeaders())}FetchResponse.prototype.text=function(){var body="response"in this._xhr?this._xhr.response:this._xhr.responseText;return null==body&&(body=""),Global.Promise.resolve(String(body))},FetchResponse.prototype.json=function(){return this.text().then(function(text){return text?JSON.parse(text):null})},Global.fetch=function(url,options){return options=options||{},new Global.Promise(function(resolve,reject){var request=new XMLHttpRequest;if(request.open(options.method||"GET",url,!0),"include"===options.credentials&&(request.withCredentials=!0),options.headers)if("function"==typeof options.headers.forEach)options.headers.forEach(function(value,key){request.setRequestHeader(key,value)});else for(var key in options.headers)Object.prototype.hasOwnProperty.call(options.headers,key)&&request.setRequestHeader(key,options.headers[key]);request.onload=function(){resolve(new FetchResponse(request,url))},request.onerror=function(){reject(new TypeError("Network request failed"))},request.ontimeout=function(){reject(new TypeError("Network request failed"))};try{request.send(options.body||null)}catch(err){reject(err)}})}}}}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:this);var isNode="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,resolveSrc=function(){return""};if(isNode){var path=require("path");resolveSrc=function(moduleName){var parts=__dirname.split(path.sep),idx=parts.lastIndexOf("src"),srcRoot=-1===idx?path.join(__dirname,"src"):parts.slice(0,idx+1).join(path.sep);return path.join(srcRoot,moduleName)}}"undefined"!=typeof globalThis&&(globalThis.isNode=isNode,isNode&&(globalThis.resolveSrc=resolveSrc)),isNode&&(module.exports={isNode:isNode,resolveSrc:resolveSrc}),"undefined"!=typeof module&&void 0===globalThis.isNode&&require("./src/env.js"),globalThis.isNode?module.exports={parseProbability:parseProbability,roundProbability:roundProbability}:(globalThis.parseProbability=parseProbability,globalThis.roundProbability=roundProbability),globalThis.isNode?module.exports={updateWarningText:updateWarningText}:globalThis.updateWarningText=updateWarningText;resolveSrc=globalThis.resolveSrc;"undefined"!=typeof module&&"function"!=typeof resolveSrc&&(resolveSrc=require("./src/env.js").resolveSrc);var DEFAULT_CELL_SVG='\n      <svg viewBox="0 0 485 522" xmlns="http://www.w3.org/2000/svg" overflow="hidden" width="100" height="120" preserveAspectRatio="xMidYMid meet" aria-label="Cell icon" role="img">\n        <title>Cell icon</title>\n        <g transform="translate(-666 -99)">\n          <path d="M909 105.5 1036.86 237.4 1036.86 136.697 1084.85 136.697 1084.85 286.906 1145.5 349.473 1084.85 349.473 1084.85 615.5 733.151 615.5 733.151 349.473 672.5 349.473Z" stroke="#000000" stroke-width="11" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd" />\n        </g>\n      </svg>',tokenUtils=globalThis.isNode?require(resolveSrc("token-utils.js")):globalThis,gridUtils=globalThis.isNode?require(resolveSrc("grid-utils.js")):globalThis,randomizer=globalThis.isNode?require(resolveSrc("scenario-randomizer.js")):globalThis,scenarioUtils=globalThis.isNode?require(resolveSrc("scenario.js")):globalThis,updateWarningTextLocal="function"==typeof globalThis.updateWarningText?globalThis.updateWarningText:globalThis.isNode?require(resolveSrc("warning-utils.js")).updateWarningText:function(){},NeighborhoodQuestion=function(){function NeighborhoodQuestion(surveyQuestionDiv){_classCallCheck(this,NeighborhoodQuestion),this.outerDiv=surveyQuestionDiv,this.rowCount=null,this.columnCount=null,this.optionsData=null,this.centerLabelText=null,this.isExperimental=null,this.experimentalTraits=null,this.experimentalScenarios=null,this.traitArray=null,this.scenarioName=null,this.scenarioWeight=null,this.scenarioProportions=null,this.cellImageHTML=DEFAULT_CELL_SVG,this.backgroundImageURL=null,this.cellWidth=100,this.cellHeight=120,this.gridContainer=null,this.gridWrapper=null,this.useTokens=!1,this.tokenBank=null,this.tokenBankWrapper=null,this.tokenCountReadout=null,this.keyboardTokenSelection=null,this.clearKeyboardSelection=null,this.initialTokenOptions=null,this.lockedCells=[],this.interactionEnabled=!0,this.centerCellRowIndex=null,this.centerCellColumnIndex=null,this.includeCenterCell=!0,this.imageLoadId=0,this.skipBehavior="remind",this.missingCode="_missing_",this.errorCode="_error_",this.realizedOptionOrder=[],this.optionShuffleSeed=null}return _createClass(NeighborhoodQuestion,[{key:"addQuestionText",value:function(questionText){this.outerDiv.innerHTML="";var questionDiv=document.createElement("div");questionDiv.className="question",questionDiv.innerHTML=sanitizeHTML(questionText),this.outerDiv.appendChild(questionDiv)}},{key:"addTokenBank",value:function(options,columnCount,rowCount){var quotas=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,includeCenterCell=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],lockedCells=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[];this.useTokens&&"function"==typeof tokenUtils.addTokenBank&&tokenUtils.addTokenBank(this,options,columnCount,rowCount,quotas,includeCenterCell,lockedCells)}},{key:"startGridContainer",value:function(columnCount,rowCount){return gridUtils.startGridContainer(this,columnCount,rowCount)}},{key:"setStyles",value:function(gap,padding,fontSize,width,height){gridUtils.setStyles(this,gap,padding,fontSize,width,height)}},{key:"selectWeightedScenario",value:function(){return!1===this.isExperimental||"function"!=typeof randomizer.selectWeightedScenario?null:randomizer.selectWeightedScenario(this)}},{key:"randomizeExperimentalTraits",value:function(){!1!==this.isExperimental?"function"==typeof randomizer.randomizeExperimentalTraits&&randomizer.randomizeExperimentalTraits(this):this.traitArray=null}},{key:"buildCenterCell",value:function(cellContainer){gridUtils.buildCenterCell(this,cellContainer)}},{key:"addCellImage",value:function(cellContainer,id){gridUtils.addCellImage(this,cellContainer,id)}},{key:"addExperimentalLabel",value:function(cellContainer){gridUtils.addExperimentalLabel(this,cellContainer)}},{key:"addDropdownAndLabel",value:function(cellContainer,rowIndex,columnIndex){gridUtils.addDropdownAndLabel(this,cellContainer,rowIndex,columnIndex)}},{key:"buildNeighborCell",value:function(cellContainer,rowIndex,columnIndex){gridUtils.buildNeighborCell(this,cellContainer,rowIndex,columnIndex)}},{key:"calculateCenterCellRow",value:function(){return null===this.centerCellRowIndex?Math.ceil(this.rowCount/2)-1:this.centerCellRowIndex}},{key:"calculateCenterCellColumn",value:function(){return null===this.centerCellColumnIndex?Math.ceil(this.columnCount/2)-1:this.centerCellColumnIndex}},{key:"isLockedCell",value:function(rowIndex,columnIndex){return this.lockedCells.some(function(c){return c.row===rowIndex&&c.col===columnIndex})}},{key:"populateGrid",value:function(gridContainer){gridUtils.populateGrid(this,gridContainer)}},{key:"addNextButton",value:function(qualtricsQuestionObject){var buttonWrapper=document.createElement("div");buttonWrapper.style.textAlign="center";var customNextButton=document.createElement("button");customNextButton.textContent="Next",customNextButton.className="preview-next-button",customNextButton.style.marginTop="20px",customNextButton.style.padding="10px 20px",customNextButton.style.fontSize="16px",customNextButton.style.display="inline-block",buttonWrapper.appendChild(customNextButton),this.outerDiv.appendChild(buttonWrapper),customNextButton.addEventListener("click",function(){this.buttonEventListener(qualtricsQuestionObject)}.bind(this))}},{key:"makeLabelArray",value:function(){for(var cells=this.outerDiv.querySelectorAll(".grid-container .cell-container"),labels=[],i=0;i<cells.length;i++){var value=this.readCellState(cells[i]).value;labels.push(value)}return labels}},{key:"exportSelections",value:function(){return{chosenLabels:this.makeLabelArray(),scenarioName:this.scenarioName,scenarioWeight:this.scenarioWeight,scenarioProportions:this.scenarioProportions,traitAssignments:this.traitArray}}},{key:"recordSelectionsToQualtrics",value:function(){if("undefined"!=typeof Qualtrics&&Qualtrics&&Qualtrics.SurveyEngine&&"function"==typeof Qualtrics.SurveyEngine.setEmbeddedData){var labels=this.makeLabelArray();Qualtrics.SurveyEngine.setEmbeddedData("neighborhood_question_chosen_labels",labels.join("|")),this.isExperimental&&(Qualtrics.SurveyEngine.setEmbeddedData("neighborhood_question_experimental_scenario_name",this.scenarioName),Qualtrics.SurveyEngine.setEmbeddedData("neighborhood_question_experimental_scenario_weight",this.scenarioWeight),Qualtrics.SurveyEngine.setEmbeddedData("neighborhood_question_experimental_proportions",Array.isArray(this.scenarioProportions)?this.scenarioProportions.join("|"):""),Qualtrics.SurveyEngine.setEmbeddedData("neighborhood_question_experimental_labels",Array.isArray(this.traitArray)?this.traitArray.join("|"):""))}}},{key:"buttonEventListener",value:function(qualtricsQuestionObject){var _this=this,cells=this.outerDiv.querySelectorAll(".grid-container .cell-container"),submit=function(){qualtricsQuestionObject&&(_this.recordSelectionsToQualtrics(),qualtricsQuestionObject.clickNextButton())};if(this.interactionEnabled){for(var unfilled=!1,i=0;i<cells.length;i++){if(!cells[i].querySelector(".center-cell-label"))if(!this.readCellState(cells[i]).filled){unfilled=!0;break}}if(unfilled){var title=document.getElementById("confirmModalTitle"),desc=document.getElementById("confirmModalDesc"),reminderMessage="Some cells are unfilled. You may need to scroll to see all cells. Click Cancel to finish filling in cells or Continue to submit partly empty.",forceMessage="All cells must be filled before continuing.";this.skipBehavior===NeighborhoodQuestion.SKIP_ALLOW?submit():this.skipBehavior===NeighborhoodQuestion.SKIP_FORCE?(title&&(title.textContent="Incomplete grid"),desc&&(desc.textContent=forceMessage),showConfirmModal(null,null,{force:!0})):(title&&(title.textContent="Incomplete grid"),desc&&(desc.textContent=reminderMessage),showConfirmModal(submit,function(){}))}else submit()}else submit()}},{key:"applyPriorSelections",value:function(selections){var _this2=this;if(Array.isArray(selections)){for(var cells=this.outerDiv.querySelectorAll(".grid-container .cell-container"),_loop=function(){var cell=cells[i];if(cell.querySelector(".center-cell-label"))return 0;var val=selections[i];if(!val)return 0;var lockedEl=cell.querySelector(".locked-cell");if(lockedEl)return lockedEl.textContent=val,lockedEl.dataset&&(lockedEl.dataset.value=val),0;if(_this2.useTokens){var dropTarget=cell.querySelector(".token-drop");if(dropTarget&&_this2.tokenBank){var token=Array.from(_this2.tokenBank.querySelectorAll(".token")).find(function(t){return t.dataset.value===val});if(token){if(dropTarget.firstChild){var existing=dropTarget.firstChild;existing.dataset.unlimitedClone?existing.remove():tokenUtils.adjustTokenCount(_this2,existing.dataset.value,1),dropTarget.innerHTML=""}"true"===token.dataset.unlimited?dropTarget.appendChild(tokenUtils.createDraggableToken(val,!0)):tokenUtils.adjustTokenCount(_this2,val,-1)>=0&&dropTarget.appendChild(tokenUtils.createDraggableToken(val))}}}else{var selectEl=cell.querySelector("select");if(selectEl){if(!Array.from(selectEl.options||[]).some(function(opt){return opt.value===val}))return 0;selectEl.value=val,selectEl.dataset.prevValue=val,_this2.selectedCounts[val]=(_this2.selectedCounts[val]||0)+1;var labelDiv=cell.querySelector(".selected-label"),selectContainer=cell.querySelector(".select-menu");labelDiv&&(labelDiv.innerText=val,_this2.isExperimental&&_this2.interactionEnabled?labelDiv.style.display="block":labelDiv.style.display=_this2.interactionEnabled?"none":"block"),selectContainer&&_this2.interactionEnabled&&(selectContainer.style.display="block")}else{var radioInputs=cell.querySelectorAll('input[type="radio"]');if(radioInputs.length){var matched=!1;Array.from(radioInputs).forEach(function(input){var match=input.value===val;match&&(matched=!0),input.checked=match}),matched||Array.from(radioInputs).forEach(function(input){input.checked=!1})}}}},i=0;i<cells.length&&i<selections.length;i++)_loop();this.showQuotaWarnings()}}},{key:"readCellState",value:function(cell){var result={value:this.missingCode,filled:!1};if(!cell)return result;var centerLabel=cell.querySelector(".center-cell-label");if(centerLabel)return{value:centerLabel.textContent,filled:!0};var assigned=cell.querySelector(".pre-assigned-label"),assignedText=assigned&&assigned.textContent?assigned.textContent.trim():"",locked=cell.querySelector(".locked-cell");if(locked){var cleaned=(locked.dataset&&locked.dataset.value||locked.textContent||"").trim();return cleaned?{value:cleaned,filled:!0}:{value:this.missingCode,filled:!0}}if(cell.classList&&cell.classList.contains("fixed-trait-cell"))return assignedText?{value:assignedText,filled:!0}:{value:this.missingCode,filled:!0};if(!this.interactionEnabled)return assignedText?{value:assignedText,filled:!0}:result;if(this.useTokens){var token=cell.querySelector(".token-drop .token");return token?{value:(token.dataset?token.dataset.value:null)||token.textContent||this.missingCode,filled:!0}:result}var selectEl=cell.querySelector("select");if(selectEl){var val=selectEl.value;return{value:val||this.missingCode,filled:!!val}}var radioInputs=cell.querySelectorAll('input[type="radio"]');if(radioInputs.length){var checked=Array.from(radioInputs).find(function(r){return r.checked}),_val=checked?checked.value:"";return{value:_val||this.missingCode,filled:!!_val}}return assignedText?{value:assignedText,filled:!0}:result}},{key:"renderQuestion",value:function(questionText,columnCount,rowCount,dropdownOptionsInput){var centerLabelText=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,includeCenterCell=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],centerColumn=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,centerRow=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,isExperimental=arguments.length>8&&void 0!==arguments[8]&&arguments[8],experimentalTraits=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,experimentalScenarios=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,qualtricsQuestionObject=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,cellImageHTML=arguments.length>12&&void 0!==arguments[12]?arguments[12]:null,backgroundImageURL=arguments.length>13&&void 0!==arguments[13]?arguments[13]:null,priorSelections=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null,useTokens=arguments.length>15&&void 0!==arguments[15]&&arguments[15],quotas=arguments.length>16&&void 0!==arguments[16]?arguments[16]:null,lockedCells=arguments.length>17&&void 0!==arguments[17]?arguments[17]:[],interactionEnabled=!(arguments.length>18&&void 0!==arguments[18])||arguments[18],skipBehavior=arguments.length>19&&void 0!==arguments[19]?arguments[19]:NeighborhoodQuestion.SKIP_REMIND,missingCode=arguments.length>20&&void 0!==arguments[20]?arguments[20]:"_missing_",errorCode=arguments.length>21&&void 0!==arguments[21]?arguments[21]:"_error_",optionShuffleSeed=arguments.length>22&&void 0!==arguments[22]?arguments[22]:null,persistedOptionOrder=arguments.length>23&&void 0!==arguments[23]?arguments[23]:null,qualtricsPresent=!!qualtricsQuestionObject;this.interactionEnabled=!1!==interactionEnabled,this.interactionEnabled&&qualtricsPresent&&qualtricsQuestionObject.hideNextButton(),this.imageLoadId++,this.cellImageHTML=cellImageHTML||DEFAULT_CELL_SVG,this.backgroundImageURL=backgroundImageURL,this.cellWidth=0,this.cellHeight=0,this.useTokens=this.interactionEnabled&&useTokens,this.tokenBankWrapper&&(this.tokenBankWrapper.remove(),this.tokenBankWrapper=null),this.tokenBank=null,this.tokenCountReadout=null,this.keyboardTokenSelection=null,this.clearKeyboardSelection=null,this.initialTokenOptions=null,this.useTokens||(this.realizedOptionOrder=Array.isArray(dropdownOptionsInput)?dropdownOptionsInput.slice():[]);var sanitizedQuotas=Array.isArray(quotas)&&quotas.length?quotas.slice():null;this.quotas=sanitizedQuotas,this.selectedCounts={},this.skipBehavior=skipBehavior,this.missingCode=missingCode,this.errorCode=errorCode,this.addQuestionText(questionText),this.includeCenterCell=includeCenterCell,this.lockedCells=Array.isArray(lockedCells)?lockedCells:[];var normalizedSeed="string"==typeof optionShuffleSeed?optionShuffleSeed.trim():optionShuffleSeed;this.optionShuffleSeed=normalizedSeed&&String(normalizedSeed).length?String(normalizedSeed):null;var orderOverride=null;Array.isArray(persistedOptionOrder)?orderOverride=normalizeOrderList(persistedOptionOrder,dropdownOptionsInput):"string"==typeof persistedOptionOrder&&persistedOptionOrder.trim()&&(orderOverride=normalizeOrderList(persistedOptionOrder.split(",").map(function(s){return s.trim()}),dropdownOptionsInput)),this.useTokens&&this.addTokenBank(dropdownOptionsInput,columnCount,rowCount,sanitizedQuotas,this.includeCenterCell,this.lockedCells);var gridContainer=this.startGridContainer(columnCount,rowCount);this.optionsData=dropdownOptionsInput.slice();var qList=Array.isArray(this.quotas)&&this.quotas.length?this.quotas.slice():null,pairs=this.optionsData.map(function(opt,idx){return{opt:opt,quota:qList?qList[idx]:void 0}});if(orderOverride){var orderMap=new Map;orderOverride.forEach(function(opt,idx){orderMap.set(String(opt),idx)}),pairs.sort(function(a,b){return(orderMap.has(String(a.opt))?orderMap.get(String(a.opt)):Number.MAX_SAFE_INTEGER)-(orderMap.has(String(b.opt))?orderMap.get(String(b.opt)):Number.MAX_SAFE_INTEGER)}),this.realizedOptionOrder=pairs.map(function(p){return p.opt})}else if(this.optionShuffleSeed){for(var rng=function(seed){for(var str=String(seed),h=1779033703^str.length,i=0;i<str.length;i+=1)h=(h=Math.imul(h^str.charCodeAt(i),3432918353))<<13|h>>>19;return function(){return h=Math.imul(h^h>>>16,2246822507),h=Math.imul(h^h>>>13,3266489909),((h^=h>>>16)>>>0)/4294967296}}(this.optionShuffleSeed),i=pairs.length-1;i>0;i-=1){var j=Math.floor(rng()*(i+1)),tmp=pairs[i];pairs[i]=pairs[j],pairs[j]=tmp}this.realizedOptionOrder=pairs.map(function(p){return p.opt})}else pairs.sort(function(){return Math.random()-.5}),this.realizedOptionOrder=pairs.map(function(p){return p.opt});this.optionsData=pairs.map(function(p){return p.opt}),qList&&(this.quotas=pairs.map(function(p){return p.quota})),this.centerLabelText=centerLabelText,this.centerCellColumnIndex=null===centerColumn?Math.ceil(columnCount/2)-1:Math.min(Math.max(centerColumn-1,0),columnCount-1),this.centerCellRowIndex=null===centerRow?Math.ceil(rowCount/2)-1:Math.min(Math.max(centerRow-1,0),rowCount-1),this.isExperimental=isExperimental,this.experimentalTraits=experimentalTraits,this.experimentalScenarios=experimentalScenarios,isExperimental&&this.randomizeExperimentalTraits(),this.populateGrid(gridContainer),priorSelections&&this.applyPriorSelections(priorSelections),this.showQuotaWarnings(),this.measureCellSize(this.imageLoadId),this.checkAndWarnAttributeFit([].concat(_toConsumableArray(dropdownOptionsInput),_toConsumableArray(experimentalTraits||[]),[centerLabelText])),this.centerGrid(),this.interactionEnabled?this.addNextButton(qualtricsQuestionObject):qualtricsPresent&&this.recordSelectionsToQualtrics()}},{key:"renderDefault",value:function(){var questionText,isExperimental=arguments.length>0&&void 0!==arguments[0]&&arguments[0];questionText=isExperimental?"Who has which ice cream? Fill in the grid:":"Who lives where? Fill in the grid:";var scenarios=scenarioUtils.normalizeScenarioWeights([{name:"All chocolate",proportions:[1,0,0],weight:30},{name:"Even mix",proportions:[1,1,1],weight:30},{name:"No chocolate",proportions:[0,60,40],weight:40}]);this.renderQuestion(questionText,3,3,["Dwarves","Elves","Hobbits","Rohirrim"],null,!0,null,null,isExperimental,["Chocolate","Vanilla","Mint Chip"],scenarios,null,null,null,null,!1,null,null)}},{key:"measureCellSize",value:function(id){gridUtils.measureCellSize(this,id)}},{key:"checkAndWarnAttributeFit",value:function(attributes){var fontSize=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;gridUtils.checkAndWarnAttributeFit(this,attributes,fontSize)}},{key:"centerGrid",value:function(){gridUtils.centerGrid(this)}},{key:"getCurrentCounts",value:function(){if(this.useTokens&&"function"==typeof tokenUtils.getCurrentCounts)return tokenUtils.getCurrentCounts(this);var counts={};return this.outerDiv.querySelectorAll(".cell-container select[data-cell-index]").forEach(function(selectEl){selectEl&&selectEl.value&&(counts[selectEl.value]=(counts[selectEl.value]||0)+1)}),counts}},{key:"showQuotaWarnings",value:function(){var _this3=this,warningDiv=document.getElementById("warnings");if(this.useTokens&&"function"==typeof tokenUtils.showQuotaWarnings)tokenUtils.showQuotaWarnings(this);else if(Array.isArray(this.quotas)&&Array.isArray(this.optionsData)&&this.quotas.length===this.optionsData.length){var counts=this.getCurrentCounts(),overages=[],totalQuota=0;this.optionsData.forEach(function(opt,idx){var rawQuota=_this3.quotas[idx],quota="number"==typeof rawQuota&&rawQuota>0?rawQuota:0;totalQuota+=quota;var used=counts[opt]||0;used>quota&&overages.push("".concat(opt," (").concat(used,"/").concat(quota,")"))});var cellCount=this.columnCount*this.rowCount-(this.includeCenterCell?1:0)-(Array.isArray(this.lockedCells)?this.lockedCells.length:0),overspec=totalQuota>cellCount,warnings=[];overspec&&warnings.push("Note that there are more tokens than grid cells"),overages.length&&warnings.push("Quota exceeded: ".concat(overages.join(", "))),warningDiv&&(warningDiv.dataset.quotaWarnings=warnings.join(" | "),warningDiv.dataset.overspec=overspec?"true":"false",updateWarningTextLocal(warningDiv))}else warningDiv&&(warningDiv.dataset.quotaWarnings="",warningDiv.dataset.overspec="false",updateWarningTextLocal(warningDiv))}}])}();NeighborhoodQuestion.DEFAULT_CELL_SVG=DEFAULT_CELL_SVG,NeighborhoodQuestion.INPUTS_VERSION=7,NeighborhoodQuestion.SKIP_ALLOW="allow",NeighborhoodQuestion.SKIP_REMIND="remind",NeighborhoodQuestion.SKIP_FORCE="force",globalThis.isNode&&(module.exports={NeighborhoodQuestion:NeighborhoodQuestion,DEFAULT_CELL_SVG:DEFAULT_CELL_SVG,INPUTS_VERSION:7,SKIP_ALLOW:NeighborhoodQuestion.SKIP_ALLOW,SKIP_REMIND:NeighborhoodQuestion.SKIP_REMIND,SKIP_FORCE:NeighborhoodQuestion.SKIP_FORCE});resolveSrc=globalThis.resolveSrc;if("undefined"!=typeof module&&void 0===globalThis.isNode)resolveSrc=require("./src/env.js").resolveSrc;var updateWarningTextFn="function"==typeof globalThis.updateWarningText?globalThis.updateWarningText:globalThis.isNode?require(resolveSrc("warning-utils.js")).updateWarningText:function(){};globalThis.isNode?module.exports={addTokenBank:addTokenBank,getCurrentCounts:getCurrentCounts,showQuotaWarnings:showQuotaWarnings,adjustTokenCount:adjustTokenCount,createDraggableToken:createDraggableToken,updateTokenCountReadout:updateTokenCountReadout}:(globalThis.addTokenBank=addTokenBank,globalThis.getCurrentCounts=getCurrentCounts,globalThis.showQuotaWarnings=showQuotaWarnings,globalThis.adjustTokenCount=adjustTokenCount,globalThis.createDraggableToken=createDraggableToken,globalThis.updateTokenCountReadout=updateTokenCountReadout);resolveSrc=globalThis.resolveSrc;if("undefined"!=typeof module&&"function"!=typeof resolveSrc)resolveSrc=require("./src/env.js").resolveSrc;globalThis.isNode?module.exports={addExperimentalLabel:addExperimentalLabel}:globalThis.addExperimentalLabel=addExperimentalLabel;resolveSrc=globalThis.resolveSrc;if("undefined"!=typeof module&&"function"!=typeof resolveSrc)resolveSrc=require("./src/env.js").resolveSrc;var sanitizeHTMLFn="function"==typeof globalThis.sanitizeHTML?globalThis.sanitizeHTML:null;if("undefined"!=typeof module&&"function"!=typeof sanitizeHTMLFn){var _require4=require(resolveSrc("sanitize.js"));sanitizeHTMLFn=_require4.sanitizeHTML}"function"!=typeof sanitizeHTMLFn&&(sanitizeHTMLFn=function(html){return("function"==typeof globalThis.sanitizeHTML?globalThis.sanitizeHTML:function(x){return String(x||"")})(html)});var FALLBACK_CELL_SVG='\n      <svg viewBox="0 0 485 522" xmlns="http://www.w3.org/2000/svg" overflow="hidden" width="100" height="120" preserveAspectRatio="xMidYMid meet" aria-label="Cell icon" role="img">\n        <title>Cell icon</title>\n        <g transform="translate(-666 -99)">\n          <path d="M909 105.5 1036.86 237.4 1036.86 136.697 1084.85 136.697 1084.85 286.906 1145.5 349.473 1084.85 349.473 1084.85 615.5 733.151 615.5 733.151 349.473 672.5 349.473Z" stroke="#000000" stroke-width="11" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd" />\n        </g>\n      </svg>',nodeShowQuotaWarnings=null;if(globalThis.isNode)try{var _require5=require(resolveSrc("token-utils.js"));nodeShowQuotaWarnings=_require5.showQuotaWarnings}catch(err){nodeShowQuotaWarnings=null}var adjustTokenCountFn="function"==typeof globalThis.adjustTokenCount?globalThis.adjustTokenCount:globalThis.isNode?require(resolveSrc("token-utils.js")).adjustTokenCount:function(){},createDraggableTokenFn="function"==typeof globalThis.createDraggableToken?globalThis.createDraggableToken:globalThis.isNode?require(resolveSrc("token-utils.js")).createDraggableToken:function(){},addExperimentalLabelFn="function"==typeof globalThis.addExperimentalLabel?globalThis.addExperimentalLabel:globalThis.isNode?require(resolveSrc("experimental-label.js")).addExperimentalLabel:function(){};updateWarningTextFn="function"==typeof globalThis.updateWarningText?globalThis.updateWarningText:globalThis.isNode?require(resolveSrc("warning-utils.js")).updateWarningText:function(){};globalThis.isNode?module.exports={startGridContainer:startGridContainer,setStyles:setStyles,buildCenterCell:buildCenterCell,addCellImage:addCellImage,addDropdownAndLabel:addDropdownAndLabel,buildNeighborCell:buildNeighborCell,populateGrid:populateGrid,measureCellSize:measureCellSize,checkAndWarnAttributeFit:checkAndWarnAttributeFit,centerGrid:centerGrid,setBackgroundWarning:setBackgroundWarning,addExperimentalLabel:addExperimentalLabelFn}:(globalThis.startGridContainer=startGridContainer,globalThis.setStyles=setStyles,globalThis.buildCenterCell=buildCenterCell,globalThis.addCellImage=addCellImage,globalThis.addDropdownAndLabel=addDropdownAndLabel,globalThis.buildNeighborCell=buildNeighborCell,globalThis.populateGrid=populateGrid,globalThis.measureCellSize=measureCellSize,globalThis.checkAndWarnAttributeFit=checkAndWarnAttributeFit,globalThis.centerGrid=centerGrid,globalThis.setBackgroundWarning=setBackgroundWarning),globalThis.isNode?module.exports={selectWeightedScenario:selectWeightedScenario,randomizeExperimentalTraits:randomizeExperimentalTraits}:(globalThis.selectWeightedScenario=selectWeightedScenario,globalThis.randomizeExperimentalTraits=randomizeExperimentalTraits),"undefined"!=typeof module&&"function"==typeof require&&require("./src/env.js");var FormInputs=_createClass(function FormInputs(){_classCallCheck(this,FormInputs),this.questionTextInput=document.getElementById("questionTextInput"),this.columnInput=document.getElementById("columnInput"),this.rowInput=document.getElementById("rowInput"),this.dropdownOptionsInput=document.getElementById("dropdownOptionsInput"),this.optionQuotaInput=document.getElementById("optionQuotaInput"),this.enableQuotasCheckbox=document.getElementById("enableQuotas"),this.quotaInputContainer=document.getElementById("quotaInputContainer"),this.enableCenterCell=document.getElementById("enableCenterCell"),this.centerLabelInput=document.getElementById("centerCellTextInput"),this.centerCellRowInput=document.getElementById("centerCellRowInput"),this.centerCellColumnInput=document.getElementById("centerCellColumnInput"),this.defaultCellCheckbox=document.getElementById("defaultCellCheckbox"),this.experimentalRadioInput=document.getElementById("experimentalDesignSelector"),this.blankNeighborhoodRadio=document.getElementById("blankNeighborhoodDesignSelector"),this.experimentalTraitsInput=document.getElementById("experimentalTraits"),this.cellImageFileInput=document.getElementById("cellImageFile"),this.cellImageSVGInput=document.getElementById("cellImageSVG"),this.cellImageURLInput=document.getElementById("cellImageURL"),this.cellImageMethodSelect=document.getElementById("cellImageMethod"),this.backgroundImageURLInput=document.getElementById("backgroundImageURL"),this.optionShuffleSeed=document.getElementById("optionShuffleSeed"),this.optionShuffleOrder=document.getElementById("optionShuffleOrder"),this.dragDropCheckbox=document.getElementById("dragDropCheckbox"),this.userInteractionCheckbox=document.getElementById("userInteractionCheckbox"),this.gridGapRange=document.getElementById("gridGapRange"),this.gridGapInput=document.getElementById("gridGapInput"),this.gridPaddingRange=document.getElementById("gridPaddingRange"),this.gridPaddingInput=document.getElementById("gridPaddingInput"),this.labelFontSizeRange=document.getElementById("labelFontSizeRange"),this.labelFontSizeInput=document.getElementById("labelFontSizeInput"),this.cellWidthRange=document.getElementById("cellWidthRange"),this.cellWidthInput=document.getElementById("cellWidthInput"),this.cellHeightRange=document.getElementById("cellHeightRange"),this.cellHeightInput=document.getElementById("cellHeightInput"),this.previewWidthInput=document.getElementById("previewWidthInput"),this.previewHeightInput=document.getElementById("previewHeightInput"),this.skipBehaviorSelect=document.getElementById("skipBehaviorSelect"),this.followUpCheckbox=document.getElementById("followUpCheckbox"),this.followUpQIDsInput=document.getElementById("followUpQIDsInput"),this.confirmButtonText=document.getElementById("confirmButtonText")},[{key:"allInputs",value:function(){return[this.questionTextInput,this.columnInput,this.rowInput,this.dropdownOptionsInput,this.optionQuotaInput,this.enableQuotasCheckbox,this.enableCenterCell,this.centerLabelInput,this.centerCellRowInput,this.centerCellColumnInput,this.experimentalRadioInput,this.blankNeighborhoodRadio,this.experimentalTraitsInput,this.cellImageFileInput,this.cellImageSVGInput,this.cellImageURLInput,this.cellImageMethodSelect,this.defaultCellCheckbox,this.backgroundImageURLInput,this.dragDropCheckbox,this.optionShuffleSeed,this.optionShuffleOrder,this.userInteractionCheckbox,this.gridGapRange,this.gridGapInput,this.gridPaddingRange,this.gridPaddingInput,this.labelFontSizeRange,this.labelFontSizeInput,this.cellWidthRange,this.cellWidthInput,this.cellHeightRange,this.cellHeightInput,this.previewWidthInput,this.previewHeightInput,this.skipBehaviorSelect,this.followUpCheckbox,this.followUpQIDsInput,this.confirmButtonText].filter(Boolean)}}]);globalThis.isNode?module.exports={FormInputs:FormInputs}:globalThis.FormInputs=FormInputs,"undefined"!=typeof module&&"function"==typeof require&&void 0===globalThis.isNode&&require("../env.js"),globalThis.isNode?module.exports={makeDropdownOptionList:makeDropdownOptionList,parseQuotaList:parseQuotaList,getCellImageHTML:getCellImageHTML,getBackgroundImageURL:getBackgroundImageURL}:(globalThis.makeDropdownOptionList=makeDropdownOptionList,globalThis.parseQuotaList=parseQuotaList,globalThis.getCellImageHTML=getCellImageHTML,globalThis.getBackgroundImageURL=getBackgroundImageURL),globalThis.isNode?module.exports={displayError:displayError,highlightInput:highlightInput,clearInputHighlights:clearInputHighlights,clearError:clearError}:(globalThis.displayError=displayError,globalThis.highlightInput=highlightInput,globalThis.clearInputHighlights=clearInputHighlights,globalThis.clearError=clearError);var qMessages=globalThis.isNode?require(resolveSrc("validation/messages.js")):globalThis,qMakeList=(globalThis.isNode?require(resolveSrc("validation/utils.js")):globalThis).makeDropdownOptionList;globalThis.isNode?module.exports={validateQuestion:validateQuestion}:globalThis.validateQuestion=validateQuestion;var scMessages=globalThis.isNode?require(resolveSrc("validation/messages.js")):globalThis;parseProbability="function"==typeof globalThis.parseProbability?globalThis.parseProbability:globalThis.isNode?require(resolveSrc("probability-utils.js")).parseProbability:function(){return NaN};globalThis.isNode?module.exports={validateScenarios:validateScenarios}:globalThis.validateScenarios=validateScenarios;var tMessages=globalThis.isNode?require(resolveSrc("validation/messages.js")):globalThis,tvParseList=(globalThis.isNode?require(resolveSrc("validation/utils.js")):globalThis).parseQuotaList;globalThis.isNode?module.exports={validateQuotas:validateQuotas}:globalThis.validateQuotas=validateQuotas;var icMessages=globalThis.isNode?require(resolveSrc("validation/messages.js")):globalThis,clearHighlights=icMessages.clearInputHighlights,questionValidator=globalThis.isNode?require(resolveSrc("validation/question-validations.js")).validateQuestion:globalThis.validateQuestion,quotaValidator=globalThis.isNode?require(resolveSrc("validation/token-validations.js")).validateQuotas:globalThis.validateQuotas,scenarioValidator=globalThis.isNode?require(resolveSrc("validation/scenario-validations.js")).validateScenarios:globalThis.validateScenarios,exportsObj={validateInputs:validateInputs,displayError:icMessages.displayError,highlightInput:icMessages.highlightInput,clearInputHighlights:icMessages.clearInputHighlights,clearError:icMessages.clearError};globalThis.isNode?module.exports=exportsObj:Object.assign(globalThis,exportsObj);resolveSrc=globalThis.resolveSrc;"undefined"!=typeof module&&"function"!=typeof resolveSrc&&(resolveSrc=require("../env.js").resolveSrc);var checks=globalThis.isNode?require(resolveSrc("validation/input-checks.js")):globalThis,validate=checks.validateInputs,showError=checks.displayError,clearErr=checks.clearError,_ref4=globalThis.isNode?require(resolveSrc("validation/utils.js")):globalThis,pvMakeList=_ref4.makeDropdownOptionList,pvParseList=_ref4.parseQuotaList,pvGetCellImageHTML=_ref4.getCellImageHTML,pvGetBackgroundImageURL=_ref4.getBackgroundImageURL,parseScenariosDefault=globalThis.isNode?require(resolveSrc("scenario.js")).parseExperimentalScenarios:function(){return[]},previewUpdateId=0;if(globalThis.isNode?module.exports={handleInputChange:handleInputChange}:globalThis.handleInputChange=handleInputChange,globalThis.isNode){var _checks=require(resolveSrc("validation/input-checks.js")),utils=require(resolveSrc("validation/utils.js")),preview=require(resolveSrc("validation/preview.js")),messages=require(resolveSrc("validation/messages.js")),question=require(resolveSrc("validation/question-validations.js")),token=require(resolveSrc("validation/token-validations.js")),scenario=require(resolveSrc("validation/scenario-validations.js"));module.exports=_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},_checks),utils),preview),messages),question),token),scenario)}resolveSrc=globalThis.resolveSrc;if("undefined"!=typeof module&&"function"!=typeof resolveSrc)resolveSrc=require("./src/env.js").resolveSrc;var probabilityUtils=globalThis.isNode?require(resolveSrc("probability-utils.js")):"function"==typeof globalThis.parseProbability&&"function"==typeof globalThis.roundProbability?{parseProbability:globalThis.parseProbability,roundProbability:globalThis.roundProbability}:null,roundProbabilityValue=(parseProbability=probabilityUtils?probabilityUtils.parseProbability:"function"==typeof globalThis.parseProbability?globalThis.parseProbability:function(){return NaN},probabilityUtils?probabilityUtils.roundProbability:"function"==typeof globalThis.roundProbability?globalThis.roundProbability:function(value){var decimals=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(!Number.isFinite(value))return 0;var factor=Math.pow(10,decimals);return Math.round((value+Number.EPSILON)*factor)/factor});globalThis.MAX_SCENARIOS=10,globalThis.isNode?(module.exports={MAX_SCENARIOS:10,suggestProbabilities:suggestProbabilities,normalizeScenarioWeights:normalizeScenarioWeights,parseExperimentalScenarios:parseExperimentalScenarios,checkProbabilitySums:checkProbabilitySums,toggleWeightInputs:toggleWeightInputs,updateScenarioProbabilityInputs:updateScenarioProbabilityInputs,persistScenarioProbabilities:persistScenarioProbabilities,addScenario:addScenario,removeScenario:removeScenario,resetScenarioCount:resetScenarioCount},globalThis.persistScenarioProbabilities=persistScenarioProbabilities):(globalThis.normalizeScenarioWeights=normalizeScenarioWeights,globalThis.resetScenarioCount=resetScenarioCount,globalThis.addScenario=addScenario,globalThis.removeScenario=removeScenario,globalThis.parseExperimentalScenarios=parseExperimentalScenarios,globalThis.toggleWeightInputs=toggleWeightInputs,globalThis.updateScenarioProbabilityInputs=updateScenarioProbabilityInputs,globalThis.persistScenarioProbabilities=persistScenarioProbabilities,globalThis.updateTraitProbabilityInputs=updateTraitProbabilityInputs,globalThis.checkProbabilitySums=checkProbabilitySums),"undefined"!=typeof globalThis&&"function"!=typeof globalThis.sanitizeHTML&&(globalThis.sanitizeHTML=sanitizeHTML),globalThis.isNode&&(module.exports={sanitizeHTML:sanitizeHTML}),"undefined"!=typeof module&&void 0===globalThis.isNode&&require("./src/env.js");var AppState=_createClass(function AppState(){_classCallCheck(this,AppState),this.portfolio=[],this.currentTask=0});globalThis.isNode&&(module.exports=AppState);var _resetScenarioCount=globalThis.resetScenarioCount,_normalizeScenarioWeights=globalThis.normalizeScenarioWeights,_DEFAULT_CELL_SVG=(globalThis.updateScenarioProbabilityInputs,void 0!==NeighborhoodQuestion?NeighborhoodQuestion.DEFAULT_CELL_SVG:void 0),_INPUTS_VERSION=void 0!==NeighborhoodQuestion?NeighborhoodQuestion.INPUTS_VERSION:void 0;resolveSrc=globalThis.resolveSrc;if("undefined"!=typeof module&&"function"!=typeof resolveSrc&&(resolveSrc=require("./src/env.js").resolveSrc),globalThis.isNode){var _require7=require(resolveSrc("scenario.js"));_resetScenarioCount=_require7.resetScenarioCount,_normalizeScenarioWeights=_require7.normalizeScenarioWeights,_require7.updateScenarioProbabilityInputs;var _require8=require(resolveSrc("neighborhood-question.js"));_DEFAULT_CELL_SVG=_require8.DEFAULT_CELL_SVG,_INPUTS_VERSION=_require8.INPUTS_VERSION,globalThis.INPUTS_VERSION=_INPUTS_VERSION}var parseProbability="function"==typeof globalThis.parseProbability?globalThis.parseProbability:globalThis.isNode?require(resolveSrc("probability-utils.js")).parseProbability:function(){return NaN},quotaInputReader="function"==typeof globalThis.readQuotaInputs?globalThis.readQuotaInputs:void 0;if(!quotaInputReader&&globalThis.isNode)try{var _require9=require(resolveSrc("quota-ui.js"));quotaInputReader=_require9.readQuotaInputs}catch(err){quotaInputReader=void 0}globalThis.isNode&&(module.exports={serializeInputs:serializeInputs,deserializeInputs:deserializeInputs,serializeCurrentInputs:serializeCurrentInputs,deserializeCurrentInputs:deserializeCurrentInputs,downloadInputs:downloadInputs,uploadInputs:uploadInputs,triggerFileInput:triggerFileInput,resetTuningInputs:resetTuningInputs,resetInputs:resetInputs,confirmResetInputs:confirmResetInputs,carryForwardLayoutsMatch:carryForwardLayoutsMatch});resolveSrc=globalThis.resolveSrc;if("undefined"!=typeof module&&"function"!=typeof resolveSrc&&"function"==typeof require)resolveSrc=require("./src/env.js").resolveSrc;var AppStateClass="function"==typeof AppState?AppState:globalThis.AppState;"undefined"!=typeof module&&"function"!=typeof AppStateClass&&"function"==typeof require&&(AppStateClass=require(resolveSrc("app-state.js")),globalThis.AppState=AppStateClass),"function"==typeof AppStateClass&&(globalThis.appState=globalThis.appState||new AppStateClass);var state=globalThis.appState,storage=null;try{"undefined"!=typeof localStorage&&(storage=localStorage)}catch(err){storage=null}var CURRENT_KEY="griddyPortfolioCurrent";globalThis.isNode&&(module.exports={initPortfolio:initPortfolio,addTask:addTask,renameTask:renameTask,deleteTask:deleteTask,loadTask:loadTask,downloadPortfolio:downloadPortfolio,uploadPortfolio:uploadPortfolio,triggerPortfolioInput:triggerPortfolioInput,_persistPortfolio:persistPortfolio,_loadPortfolioFromStorage:loadPortfolioFromStorage,_getState:function(){return{portfolio:state.portfolio,currentTask:state.currentTask}}}),"function"!=typeof globalThis.getNextBtn&&(globalThis.getNextBtn=function(){return document.querySelector("#NextButton")}),"function"!=typeof globalThis.setupFollowUpQIDs&&(globalThis.setupFollowUpQIDs=function(_ref5){var gridSelector=_ref5.gridSelector,_ref5$likertQIDs=_ref5.likertQIDs,likertQIDs=void 0===_ref5$likertQIDs?[]:_ref5$likertQIDs,_ref5$confirmLabel=_ref5.confirmLabel,confirmLabel=void 0===_ref5$confirmLabel?"Confirm grid":_ref5$confirmLabel,_ref5$skipModal=_ref5.skipModal,skipModal=void 0===_ref5$skipModal?defaultSkipModal:_ref5$skipModal,grid=document.querySelector(gridSelector);if(grid){globalThis.Qualtrics&&globalThis.Qualtrics.SurveyEngine&&"function"==typeof globalThis.Qualtrics.SurveyEngine.hideNextButton&&Qualtrics.SurveyEngine.hideNextButton();var nextBtn=getNextBtn();likertQIDs.forEach(function(qid){var el=document.getElementById(qid);el&&(el.style.visibility="hidden",el.style.opacity="0")});var btn=document.createElement("button");btn.type="button",btn.textContent=confirmLabel,btn.className="follow-up-qids-button",grid.insertAdjacentElement("afterend",btn),btn.addEventListener("click",_asyncToGenerator(_regenerator().m(function _callee(){var dropdowns,blank,proceed,_t;return _regenerator().w(function(_context){for(;;)switch(_context.n){case 0:if(dropdowns=grid.querySelectorAll("select"),blank=!1,dropdowns.forEach(function(sel){sel.value||(blank=!0)}),proceed=!0,!blank){_context.n=2;break}return _context.n=1,skipModal();case 1:_t=_context.v,proceed="skip"===_t;case 2:if(proceed){_context.n=3;break}return _context.a(2);case 3:globalThis.Qualtrics&&globalThis.Qualtrics.SurveyEngine&&"function"==typeof globalThis.Qualtrics.SurveyEngine.showNextButton&&Qualtrics.SurveyEngine.showNextButton(),likertQIDs.forEach(function(qid){var el=document.getElementById(qid);el&&(el.style.visibility="",el.style.opacity="")}),btn.disabled=!0,nextBtn&&setTimeout(function(){nextBtn.scrollIntoView({block:"center",behavior:"smooth"})},150);case 4:return _context.a(2)}},_callee)})))}}),globalThis.isNode&&(module.exports={setupFollowUpQIDs:globalThis.setupFollowUpQIDs,getNextBtn:globalThis.getNextBtn});resolveSrc=globalThis.resolveSrc;if("undefined"!=typeof module&&"function"!=typeof resolveSrc&&"function"==typeof require)resolveSrc=require("./src/env.js").resolveSrc;var sanitizeHTMLImpl="function"==typeof globalThis.sanitizeHTML?globalThis.sanitizeHTML:void 0;if("function"!=typeof sanitizeHTMLImpl&&"undefined"!=typeof module&&"function"==typeof require)sanitizeHTMLImpl=require(resolveSrc("sanitize.js")).sanitizeHTML,"function"!=typeof globalThis.sanitizeHTML&&(globalThis.sanitizeHTML=sanitizeHTMLImpl);var sanitizeHTMLForExport="function"==typeof globalThis.sanitizeHTML?globalThis.sanitizeHTML:sanitizeHTMLImpl;"function"!=typeof globalThis.sanitizeHTML&&"function"==typeof sanitizeHTMLForExport&&(globalThis.sanitizeHTML=sanitizeHTMLForExport);AppStateClass="function"==typeof AppState?AppState:globalThis.AppState;"undefined"!=typeof module&&"function"!=typeof AppStateClass&&"function"==typeof require&&(AppStateClass=require(resolveSrc("app-state.js")),globalThis.AppState=AppStateClass),"function"==typeof AppStateClass&&(globalThis.appState=globalThis.appState||new AppStateClass);var quotaReader="function"==typeof globalThis.readQuotaInputs?globalThis.readQuotaInputs:void 0;if("function"!=typeof quotaReader&&"undefined"!=typeof module&&"function"==typeof require)try{var _require11=require(resolveSrc("quota-ui.js"));quotaReader=_require11.readQuotaInputs}catch(err){quotaReader=void 0}var helperDependencyMap={_createClass:["_defineProperties"],_defineProperties:["_toPropertyKey"],_toPropertyKey:["_toPrimitive"],_toPrimitive:["_typeof"]},knownHelperOrder=["_typeof","_toPrimitive","_toPropertyKey","_defineProperty","_defineProperties","_createClass","_classCallCheck"],cachedHelperSources=knownHelperOrder.reduce(function(acc,name){var source=function(name){try{var helper=new Function("return typeof ".concat(name,' === "function" ? ').concat(name," : undefined;"))();return"function"==typeof helper?helper.toString():null}catch(err){return null}}(name);return source&&(acc[name]=source),acc},{}),namespaceFallbacks={gridUtils:["startGridContainer","setStyles","buildCenterCell","addCellImage","addExperimentalLabel","addDropdownAndLabel","buildNeighborCell","populateGrid","measureCellSize","checkAndWarnAttributeFit","centerGrid"],tokenUtils:["addTokenBank","createDraggableToken","adjustTokenCount","getCurrentCounts","showQuotaWarnings","updateTokenCountReadout"],randomizer:["selectWeightedScenario","randomizeExperimentalTraits"],scenarioUtils:["normalizeScenarioWeights"]},FormInputsRef=globalThis.FormInputs||(globalThis.isNode?require(resolveSrc("form-inputs.js")).FormInputs:void 0),followUpIntegrations=globalThis.setupFollowUpQIDs&&globalThis.getNextBtn?{setupFollowUpQIDs:globalThis.setupFollowUpQIDs,getNextBtn:globalThis.getNextBtn}:globalThis.isNode?require(resolveSrc("follow-up-qids.js")):{},setupFnSource="function"==typeof followUpIntegrations.setupFollowUpQIDs?followUpIntegrations.setupFollowUpQIDs.toString():"function setupFollowUpQIDs() {}",nextFnSource="function"==typeof followUpIntegrations.getNextBtn?followUpIntegrations.getNextBtn.toString():'function getNextBtn() { return document.querySelector("#NextButton"); }';globalThis.isNode&&(module.exports={buildQualtricsJSString:buildQualtricsJSString,buildQualtricsHTMLString:buildQualtricsHTMLString});resolveSrc=globalThis.resolveSrc;if("undefined"!=typeof module&&"function"!=typeof resolveSrc&&"function"==typeof require)resolveSrc=require("./src/env.js").resolveSrc;AppStateClass="function"==typeof AppState?AppState:globalThis.AppState;"undefined"!=typeof module&&"function"!=typeof AppStateClass&&"function"==typeof require&&(AppStateClass=require(resolveSrc("app-state.js")),globalThis.AppState=AppStateClass);var flashCopiedRef="function"==typeof globalThis.flashCopied?globalThis.flashCopied:null,writeTextToClipboardRef="function"==typeof globalThis.writeTextToClipboard?globalThis.writeTextToClipboard:null;if(!("undefined"==typeof module||"function"!=typeof require||flashCopiedRef&&writeTextToClipboardRef)){var _utils=require(resolveSrc("export-utils.js"));flashCopiedRef||"function"!=typeof _utils.flashCopied||(flashCopiedRef=_utils.flashCopied,"function"!=typeof globalThis.flashCopied&&(globalThis.flashCopied=flashCopiedRef)),writeTextToClipboardRef||"function"!=typeof _utils.writeTextToClipboard||(writeTextToClipboardRef=_utils.writeTextToClipboard,"function"!=typeof globalThis.writeTextToClipboard&&(globalThis.writeTextToClipboard=writeTextToClipboardRef))}"function"==typeof AppStateClass&&(globalThis.appState=globalThis.appState||new AppStateClass),globalThis.isNode&&(module.exports=_objectSpread(_objectSpread(_objectSpread({sanitizeFileName:sanitizeFileName,copyCitation:function(btn){var div=document.getElementById("citationText");if(!div)return Promise.resolve(!1);var text=div.innerText||div.textContent||"",clipboardWriter=writeTextToClipboard;return"function"!=typeof clipboardWriter?Promise.resolve(!1):clipboardWriter(text,"Copy the citation manually").then(function(copied){return copied&&flashCopied(btn),copied})}},require(resolveSrc("qualtrics-builder.js"))),require(resolveSrc("export-utils.js"))),require(resolveSrc("follow-up-qids.js")))),"undefined"!=typeof module&&"function"==typeof require&&void 0===globalThis.isNode&&require("./src/env.js");var sanitizeFileName="function"==typeof globalThis.sanitizeFileName?globalThis.sanitizeFileName:function(name){var sanitized=String(name).replace(/[^a-z0-9_-]/gi,"_");return sanitized.length>0?sanitized:"untitled"};globalThis.isNode&&(module.exports={flashCopied:flashCopied,showCopyModal:showCopyModal,abortIfProbWarnings:abortIfProbWarnings,copyQualtricsHTML:copyQualtricsHTML,copyQualtricsJS:copyQualtricsJS,downloadQualtricsFiles:downloadQualtricsFiles,writeTextToClipboard:writeTextToClipboard});var lastFocusedElement=null;globalThis.isNode&&(module.exports={showConfirmModal:showConfirmModal,hideConfirmModal:hideConfirmModal});var currentScenarioIndex=0;syncCurrentScenarioIndex();var currentQuestion=null;resolveSrc=globalThis.resolveSrc;"undefined"!=typeof module&&"function"!=typeof resolveSrc&&(resolveSrc=require("./src/env.js").resolveSrc);var MAX_SCENARIOS_CONST=globalThis.isNode?require(resolveSrc("scenario.js")).MAX_SCENARIOS:globalThis.MAX_SCENARIOS;globalThis.updateScenarioLimitUI||(globalThis.updateScenarioLimitUI=updateScenarioLimitUILocal),globalThis.isNode||(globalThis.updateScenarioLimitUI=updateScenarioLimitUILocal,globalThis.renumberScenarioLabels=renumberScenarioLabels,globalThis.updateScenarioNavVisibility=updateScenarioNavVisibility,globalThis.highlightCurrentScenario=highlightCurrentScenario,globalThis.setCurrentScenarioIndex=setCurrentScenarioIndex,globalThis.duplicateScenario=duplicateScenario,globalThis.moveScenario=moveScenario,globalThis.initScenarioDragAndDrop=initScenarioDragAndDrop,globalThis.nextScenario=nextScenario,globalThis.prevScenario=prevScenario,globalThis.randomizeScenario=randomizeScenario,globalThis.getCurrentScenarioIndex=getCurrentScenarioIndex,globalThis.__setCurrentQuestion=__setCurrentQuestion),globalThis.isNode&&(module.exports={updateScenarioLimitUI:updateScenarioLimitUILocal,renumberScenarioLabels:renumberScenarioLabels,updateScenarioNavVisibility:updateScenarioNavVisibility,highlightCurrentScenario:highlightCurrentScenario,setCurrentScenarioIndex:setCurrentScenarioIndex,duplicateScenario:duplicateScenario,moveScenario:moveScenario,initScenarioDragAndDrop:initScenarioDragAndDrop,nextScenario:nextScenario,prevScenario:prevScenario,randomizeScenario:randomizeScenario,getCurrentScenarioIndex:getCurrentScenarioIndex,__setCurrentQuestion:__setCurrentQuestion}),globalThis.isNode?module.exports={updateQuotaInputs:updateQuotaInputs,readQuotaInputs:readQuotaInputs}:(globalThis.updateQuotaInputs=updateQuotaInputs,globalThis.readQuotaInputs=readQuotaInputs);resolveSrc=globalThis.resolveSrc;if("undefined"!=typeof module&&"function"!=typeof resolveSrc&&"function"==typeof require)resolveSrc=require("./src/env.js").resolveSrc;var FormInputsClass=globalThis.FormInputs||(globalThis.isNode?require(resolveSrc("form-inputs.js")).FormInputs:void 0),scenarioUI=globalThis.isNode?require(resolveSrc("scenario-ui.js")):globalThis,modalUtils=globalThis.isNode?require(resolveSrc("modal-utils.js")):{},DEFAULT_SKIP_BEHAVIOR=globalThis.NeighborhoodQuestion&&globalThis.NeighborhoodQuestion.SKIP_REMIND||"remind";globalThis.isNode||document.addEventListener("DOMContentLoaded",function(){"function"==typeof globalThis.addScenario&&globalThis.addScenario(),globalThis.toggleWeightInputs&&globalThis.toggleWeightInputs(),initTabs(),scenarioUI.initScenarioDragAndDrop(),addTabLinkListeners(),initFollowUpFieldToggle(),initScenarioEqualProbabilityToggle();var howtoFrame=document.querySelector("#howto iframe");howtoFrame&&howtoFrame.addEventListener("load",function(){addTabLinkListeners(howtoFrame.contentDocument||howtoFrame.contentWindow.document)}),"function"==typeof globalThis.buildAndUpdatePreview&&globalThis.buildAndUpdatePreview(),scenarioUI.highlightCurrentScenario(),showCitationText(),"function"==typeof globalThis.initPortfolio&&globalThis.initPortfolio();var sel=document.getElementById("taskSelect");sel&&sel.addEventListener("change",function(e){return loadTask(parseInt(e.target.value,10))});var defaultTab=document.getElementById("tab-save");defaultTab&&!document.querySelector(".tab-link.active")&&defaultTab.click()}),globalThis.isNode&&(module.exports={initTabs:initTabs,runPowerCalc:runPowerCalc,parsePriorSelections:parsePriorSelections,setScenarioVisibility:setScenarioVisibility,showConfirmModal:modalUtils.showConfirmModal,hideConfirmModal:modalUtils.hideConfirmModal,syncRangeWithNumber:syncRangeWithNumber,duplicateScenario:scenarioUI.duplicateScenario,moveScenario:scenarioUI.moveScenario,initScenarioDragAndDrop:scenarioUI.initScenarioDragAndDrop,highlightCurrentScenario:scenarioUI.highlightCurrentScenario,showCitationText:showCitationText,updateScenarioNavVisibility:scenarioUI.updateScenarioNavVisibility,addCellImageToggleListener:addCellImageToggleListener,addCenterCellToggleListener:addCenterCellToggleListener,initFollowUpFieldToggle:initFollowUpFieldToggle,updateFollowUpFieldVisibility:updateFollowUpFieldVisibility,initScenarioEqualProbabilityToggle:initScenarioEqualProbabilityToggle,addUserInteractionToggleListener:addUserInteractionToggleListener,buildAndUpdatePreview:buildAndUpdatePreview,setCurrentScenarioIndex:scenarioUI.setCurrentScenarioIndex,nextScenario:scenarioUI.nextScenario,prevScenario:scenarioUI.prevScenario,randomizeScenario:scenarioUI.randomizeScenario,getCurrentScenarioIndex:scenarioUI.getCurrentScenarioIndex,__setCurrentQuestion:scenarioUI.__setCurrentQuestion}),"undefined"!=typeof module&&void 0===globalThis.isNode&&require("./src/env.js");var logFile="error-log.txt";globalThis.isNode?module.exports={setErrorLogFile:setErrorLogFile,logError:logError,clearErrorLog:clearErrorLog}:(globalThis.setErrorLogFile=setErrorLogFile,globalThis.logError=logError,globalThis.clearErrorLog=clearErrorLog);var g="undefined"!=typeof window?window:globalThis;g.NeighborhoodQuestion=NeighborhoodQuestion,g.FormInputs=FormInputs,g.DEFAULT_CELL_SVG=DEFAULT_CELL_SVG,g.appState=globalThis.appState,g.AppState=AppState,g.copyQualtricsJS=copyQualtricsJS,g.copyQualtricsHTML=copyQualtricsHTML,g.downloadQualtricsFiles=downloadQualtricsFiles,g.downloadInputs=downloadInputs,g.uploadInputs=uploadInputs,g.serializeInputs=serializeInputs,g.deserializeInputs=deserializeInputs,g.serializeCurrentInputs=serializeCurrentInputs,g.deserializeCurrentInputs=deserializeCurrentInputs,g.downloadPortfolio=downloadPortfolio,g.uploadPortfolio=uploadPortfolio,g.triggerPortfolioInput=triggerPortfolioInput,g.addScenario=addScenario,g.removeScenario=removeScenario,g.setCurrentScenarioIndex=setCurrentScenarioIndex,g.duplicateScenario=duplicateScenario,g.moveScenario=moveScenario,g.initScenarioDragAndDrop=initScenarioDragAndDrop,g.triggerFileInput=triggerFileInput,g.showConfirmModal=showConfirmModal,g.hideConfirmModal=hideConfirmModal,g.parsePriorSelections=parsePriorSelections,g.showCitationText=showCitationText,g.resetTuningInputs=resetTuningInputs,g.resetInputs=resetInputs,g.confirmResetInputs=confirmResetInputs,g.runPowerCalc=runPowerCalc,g.initPortfolio=initPortfolio,g.addTask=addTask,g.renameTask=renameTask,g.deleteTask=deleteTask,g.loadTask=loadTask,g.saveCurrent=saveCurrent,g.sanitizeHTML=sanitizeHTML,g.nextScenario=nextScenario,g.prevScenario=prevScenario,g.randomizeScenario=randomizeScenario,g.exportSelections=function(){return void 0!==currentQuestion&&currentQuestion?currentQuestion.exportSelections():null},g.buildAndUpdatePreview=buildAndUpdatePreview,g.logError=logError,g.setErrorLogFile=setErrorLogFile,g.clearErrorLog=clearErrorLog,g.buildQualtricsHTMLString=buildQualtricsHTMLString,g.buildQualtricsJSString=buildQualtricsJSString,"undefined"!=typeof document&&document.addEventListener("DOMContentLoaded",function(){var helpEl=document.querySelector("#helpDetails .howto-content"),qualEl=document.querySelector("#howto .howto-content"),tasks=[];helpEl&&helpEl.textContent.includes("@@HELP_DOC@@")&&tasks.push(function(){return fetchAndRender(helpEl,"docs/help.md")}),qualEl&&qualEl.textContent.includes("@@QUALTRICS_DOC@@")&&tasks.push(function(){return fetchAndRender(qualEl,"docs/qualtrics-howto.md")}),tasks.length&&(window.marked?Promise.resolve():new Promise(function(resolve,reject){var script=document.createElement("script");script.src="https://cdn.jsdelivr.net/npm/marked/marked.min.js",script.onload=function(){return resolve()},script.onerror=function(){return reject(new Error("Failed to load marked"))},document.head.appendChild(script)})).then(function(){return Promise.all(tasks.map(function(fn){return fn()}))}).catch(function(){tasks.forEach(function(fn){return fn()})})})}function parseProbability(token){if(null==token)return NaN;if(!(token=String(token).trim()))return NaN;var numPattern=/[-+]?(?:\d+(?:\.\d*)?|\.\d+)(?:[eE][-+]?\d+)?/,percent=token.match(new RegExp("^(".concat(numPattern.source,")\\s*%$")));if(percent){var n=parseFloat(percent[1]);return isNaN(n)?NaN:n/100}var frac=token.match(new RegExp("^(".concat(numPattern.source,")\\s*\\/\\s*(").concat(numPattern.source,")$")));if(frac){var num=parseFloat(frac[1]),den=parseFloat(frac[2]);return isNaN(num)||isNaN(den)||0===den?NaN:num/den}var plain=token.match(new RegExp("^".concat(numPattern.source,"$")));return plain?parseFloat(plain[0]):NaN}function roundProbability(value){var decimals=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(!Number.isFinite(value))return 0;var factor=Math.pow(10,decimals);return Math.round((value+Number.EPSILON)*factor)/factor}function updateWarningText(warningDiv){if(warningDiv){var parts=[warningDiv.dataset.attrWarnings||"",warningDiv.dataset.quotaWarnings||"",warningDiv.dataset.probWarnings||"",warningDiv.dataset.bgWarning||""].filter(function(p){return p});warningDiv.textContent=parts.join(" | "),"true"===warningDiv.dataset.overspec?warningDiv.style.fontStyle="italic":warningDiv.style.fontStyle="normal"}}function normalizeOrderList(order,options){if(!Array.isArray(order)||!Array.isArray(options))return null;if(order.length!==options.length)return null;var optionCounts=new Map;options.forEach(function(opt){var key=String(opt);optionCounts.set(key,(optionCounts.get(key)||0)+1)});var normalizedOrder=order.map(function(opt){return String(opt)}),orderCounts=new Map;normalizedOrder.forEach(function(opt){orderCounts.set(opt,(orderCounts.get(opt)||0)+1)});var _step,_iterator=_createForOfIteratorHelper(optionCounts.entries());try{for(_iterator.s();!(_step=_iterator.n()).done;){var _step$value=_slicedToArray(_step.value,2),key=_step$value[0],expected=_step$value[1];if(orderCounts.get(key)!==expected)return null}}catch(err){_iterator.e(err)}finally{_iterator.f()}return normalizedOrder}function formatTokenText(value,unlimited,remaining){return unlimited?String(null!=value?value:""):"".concat(value," (").concat(remaining,")")}function updateTokenAvailability(token,unlimited,remaining){if(token){if(unlimited)return token.draggable=!0,token.classList.remove("disabled-option"),token.tabIndex=0,token.setAttribute("aria-disabled","false"),void token.setAttribute("aria-label","".concat(token.dataset.value," token (unlimited uses)"));var disabled=remaining<=0;token.draggable=!disabled,token.classList.toggle("disabled-option",disabled),token.tabIndex=disabled?-1:0,token.setAttribute("aria-disabled",disabled?"true":"false"),token.setAttribute("aria-label","".concat(token.dataset.value," token (").concat(remaining," remaining)"))}}function markBankTokens(q,value,className){q&&q.tokenBank&&q.tokenBank.querySelectorAll(".token").forEach(function(token){token.dataset.value===value&&token.classList.add(className)})}function updateTokenCountReadout(q){var countsOverride=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(q&&q.tokenCountReadout)if(q.useTokens){var counts=countsOverride||getCurrentCounts(q),options=Array.isArray(q.optionsData)&&q.optionsData.length?q.optionsData:Array.isArray(q.initialTokenOptions)?q.initialTokenOptions:[];if(options.length){var parts=options.map(function(opt,idx){var used=counts[opt]||0,rawQuota=Array.isArray(q.quotas)?q.quotas[idx]:void 0,quota="number"==typeof rawQuota&&Number.isFinite(rawQuota)&&rawQuota>=0?Math.floor(rawQuota):null;return null!==quota?"".concat(opt,": ").concat(used,"/").concat(quota):"".concat(opt,": ").concat(used)});q.tokenCountReadout.textContent=parts.join("  ")}else q.tokenCountReadout.textContent=""}else q.tokenCountReadout.textContent=""}function addTokenBank(q,options,columnCount,rowCount){var quotas=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(q&&!1!==q.useTokens&&q.outerDiv){var optionList=Array.isArray(options)?options:[],unlimited=!Array.isArray(quotas)||!quotas.length,counts={};unlimited||optionList.forEach(function(opt,i){var raw=quotas[i],quota="number"==typeof raw&&Number.isFinite(raw)&&raw>0?Math.floor(raw):0;counts[opt]=Math.max(0,quota)});var wrapper=document.createElement("div");wrapper.className="token-bank-wrapper";var bank=document.createElement("div");bank.className="token-bank",bank.setAttribute("role","list"),optionList.forEach(function(opt){var token=document.createElement("div");if(token.className="token",token.id="token-"+Math.random().toString(36).slice(2),token.dataset.value=opt,token.setAttribute("role","button"),token.setAttribute("aria-pressed","false"),unlimited)token.dataset.unlimited="true",token.textContent=formatTokenText(opt,!0,0),updateTokenAvailability(token,!0,0);else{var count=counts[opt]||0;token.dataset.remaining=String(count),token.textContent=formatTokenText(opt,!1,count),updateTokenAvailability(token,!1,count)}token.addEventListener("dragstart",function(event){event&&event.dataTransfer&&event.dataTransfer.setData("text/plain",token.id)}),token.addEventListener("keydown",function(event){" "===event.key||"Spacebar"===event.key||"Enter"===event.key?(event.preventDefault(),token.classList.contains("disabled-option")?clearSelection():selectToken(token)):"Escape"===event.key&&clearSelection()}),token.addEventListener("click",function(){token.classList.contains("disabled-option")?clearSelection():selectToken(token)}),bank.appendChild(token)});var readout=document.createElement("div");readout.className="token-count-readout",readout.setAttribute("role","status"),readout.setAttribute("aria-live","polite"),wrapper.appendChild(bank),wrapper.appendChild(readout),q.outerDiv.appendChild(wrapper),q.tokenBank=bank,q.tokenBankWrapper=wrapper,q.tokenCountReadout=readout,q.initialTokenOptions=optionList.slice(),q.clearKeyboardSelection=clearSelection,clearSelection(),updateTokenCountReadout(q)}function clearSelection(){q.keyboardTokenSelection=null,bank.querySelectorAll(".token").forEach(function(token){token.classList.remove("token-keyboard-selected"),token.setAttribute("aria-pressed","false")})}function selectToken(token){token&&!token.classList.contains("disabled-option")?q.keyboardTokenSelection&&q.keyboardTokenSelection.value===token.dataset.value&&(q.keyboardTokenSelection.unlimited?"true"===token.dataset.unlimited:"true"!==token.dataset.unlimited)?clearSelection():(clearSelection(),token.classList.add("token-keyboard-selected"),token.setAttribute("aria-pressed","true"),q.keyboardTokenSelection={value:token.dataset.value,unlimited:"true"===token.dataset.unlimited}):clearSelection()}}function adjustTokenCount(q,value,delta){if(!q||!1===q.useTokens||!q.tokenBank)return null;var token=Array.from(q.tokenBank.querySelectorAll(".token")).find(function(t){return t.dataset.value===value});if(!token||"true"===token.dataset.unlimited)return null;var next=(parseInt(token.dataset.remaining||"0",10)||0)+delta;if(delta<0&&next<0)return-1;var remaining=Math.max(0,next);return token.dataset.remaining=String(remaining),token.textContent=formatTokenText(value,!1,remaining),updateTokenAvailability(token,!1,remaining),0===remaining&&q.keyboardTokenSelection&&q.keyboardTokenSelection.value===value&&!q.keyboardTokenSelection.unlimited&&"function"==typeof q.clearKeyboardSelection&&q.clearKeyboardSelection(),remaining}function createDraggableToken(value){var unlimitedClone=arguments.length>1&&void 0!==arguments[1]&&arguments[1],token=document.createElement("div");return token.className="token",token.textContent=formatTokenText(value,!!unlimitedClone,0),token.dataset.value=value,unlimitedClone&&(token.dataset.unlimitedClone="true"),token.id="token-"+Math.random().toString(36).slice(2),token.draggable=!0,token.tabIndex=-1,token.setAttribute("aria-hidden","true"),token.addEventListener("dragstart",function(event){event&&event.dataTransfer&&event.dataTransfer.setData("text/plain",token.id)}),token}function getCurrentCounts(q){if(!q)return{};var counts={};q.useTokens?q.outerDiv.querySelectorAll(".token-drop .token").forEach(function(t){var v=t.dataset&&t.dataset.value?t.dataset.value:null;v&&(counts[v]=(counts[v]||0)+1)}):q.outerDiv.querySelectorAll(".cell-container select").forEach(function(sel){""!==sel.value&&(counts[sel.value]=(counts[sel.value]||0)+1)});return counts}function showQuotaWarnings(q){if(q&&!1!==q.useTokens){var warningDiv=document.getElementById("warnings"),counts=getCurrentCounts(q);if(updateTokenCountReadout(q,counts),function(q){q&&(q.tokenBank&&q.tokenBank.querySelectorAll(".token").forEach(function(token){token.classList.remove("over-quota"),token.classList.remove("needs-allocation")}),q.outerDiv&&q.outerDiv.querySelectorAll(".token-drop").forEach(function(drop){drop.classList.remove("over-quota")}))}(q),Array.isArray(q.quotas)&&q.quotas.length&&q.quotas.length===(Array.isArray(q.optionsData)?q.optionsData.length:0)){var msgs=[],total=0;q.optionsData.forEach(function(opt,i){var rawQuota=q.quotas[i],quota="number"==typeof rawQuota&&Number.isFinite(rawQuota)&&rawQuota>0?Math.floor(rawQuota):0;total+=quota;var used=counts[opt]||0;quota>0&&used<quota&&markBankTokens(q,opt,"needs-allocation"),used>quota&&(msgs.push("".concat(opt," (").concat(used,"/").concat(quota,")")),markBankTokens(q,opt,"over-quota"),function(q,value,className){q&&q.outerDiv&&q.outerDiv.querySelectorAll(".token-drop").forEach(function(drop){var placed=drop.querySelector(".token");placed&&placed.dataset.value===value&&drop.classList.add(className)})}(q,opt,"over-quota"))});var cellCount=q.columnCount*q.rowCount-(q.includeCenterCell?1:0)-(Array.isArray(q.lockedCells)?q.lockedCells.length:0),overspec=total>cellCount,warnings=[];overspec&&warnings.push("Note that there are more tokens than grid cells"),msgs.length&&warnings.push("Quota exceeded: ".concat(msgs.join(", "))),warningDiv&&(warningDiv.dataset.quotaWarnings=warnings.join(" | "),warningDiv.dataset.overspec=overspec?"true":"false",updateWarningTextFn(warningDiv))}else warningDiv&&(warningDiv.dataset.quotaWarnings="",warningDiv.dataset.overspec="false",updateWarningTextFn(warningDiv))}else{q&&q.tokenCountReadout&&(q.tokenCountReadout.textContent="");var _warningDiv=document.getElementById("warnings");_warningDiv&&(_warningDiv.dataset.quotaWarnings="",_warningDiv.dataset.overspec="false",updateWarningTextFn(_warningDiv))}}function addExperimentalLabel(q,cellContainer){if(q&&q.isExperimental&&cellContainer){var select=cellContainer.querySelector("select[data-cell-index]"),drop=cellContainer.querySelector(".token-drop[data-cell-index]"),staticMarker=cellContainer.querySelector(".static-index-marker[data-cell-index]"),idxEl=select||drop||staticMarker;if(idxEl){var idx=parseInt(idxEl.dataset.cellIndex,10);if(Number.isInteger(idx)&&!(idx<0)&&Array.isArray(q.traitArray)){var labelText=q.traitArray[idx];if("string"==typeof labelText){var contentContainer=cellContainer.getElementsByClassName("content-container")[0]||cellContainer,prev=contentContainer.querySelector(".pre-assigned-label");prev&&prev.remove();var assignedLabel=document.createElement("div");assignedLabel.classList.add("pre-assigned-label"),assignedLabel.textContent=labelText,cellContainer.classList.add("has-preassigned-label");var lockedCell=cellContainer.querySelector(".locked-cell");lockedCell&&lockedCell.dataset&&(lockedCell.dataset.value=labelText),(cellContainer.classList.contains("fixed-trait-cell")||lockedCell)&&assignedLabel.classList.add("fixed-trait-label"),contentContainer.prepend(assignedLabel)}}}}}function showQuotaWarningsFn(q){q&&("function"!=typeof q.showQuotaWarnings?"function"!=typeof globalThis.showQuotaWarnings?"function"==typeof nodeShowQuotaWarnings&&nodeShowQuotaWarnings(q):globalThis.showQuotaWarnings(q):q.showQuotaWarnings())}function spawnTokenValue(q,value,unlimited){if(!q||null==value)return null;if(unlimited)return createDraggableTokenFn(value,!0);var remaining=adjustTokenCountFn(q,value,-1);return"number"!=typeof remaining||remaining<0?null:createDraggableTokenFn(value)}function removeTokenFromDropTarget(q,dropTarget){if(!dropTarget)return!1;var existing=dropTarget.querySelector(".token");if(!existing)return!1;var value=existing.dataset?existing.dataset.value:null;return existing.dataset&&"true"===existing.dataset.unlimitedClone?existing.remove():(existing.remove(),null!=value&&adjustTokenCountFn(q,value,1)),!0}function placeTokenElement(q,dropTarget,tokenElement){if(!dropTarget||!tokenElement)return!1;var existing=dropTarget.querySelector(".token");if(existing&&existing!==tokenElement){var value=existing.dataset?existing.dataset.value:null;existing.dataset&&"true"===existing.dataset.unlimitedClone?existing.remove():(existing.remove(),null!=value&&adjustTokenCountFn(q,value,1))}return dropTarget.appendChild(tokenElement),!0}function setBackgroundWarning(){var message=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",warningDiv=document.getElementById("warnings");warningDiv&&(warningDiv.dataset.bgWarning=message,updateWarningTextFn(warningDiv))}function startGridContainer(q,columnCount,rowCount){q.columnCount=columnCount,q.rowCount=rowCount;var gridWrapper=document.createElement("div");if(gridWrapper.className="grid-wrapper",q.backgroundImageURL){var loader=new Image;loader.addEventListener("load",function(){gridWrapper.style.backgroundImage="url("+q.backgroundImageURL+")",setBackgroundWarning("")}),loader.addEventListener("error",function(){gridWrapper.style.backgroundImage="",setBackgroundWarning("Warning: background image failed to load.")}),loader.src=q.backgroundImageURL}else setBackgroundWarning("");var gridContainer=document.createElement("div");return gridContainer.className="grid-container",gridContainer.id="grid-id",gridContainer.style.gridTemplateColumns="repeat("+columnCount+", "+q.cellWidth+"px)",gridContainer.style.gridTemplateRows="repeat("+rowCount+", "+q.cellHeight+"px)",gridWrapper.appendChild(gridContainer),q.outerDiv.appendChild(gridWrapper),q.gridWrapper=gridWrapper,q.gridContainer=gridContainer,gridContainer}function setStyles(q,gap,padding,fontSize,width,height){q.gridContainer&&(q.gridContainer.style.gap=gap+"px",q.gridContainer.style.gridTemplateColumns="repeat("+q.columnCount+", "+width+"px)",q.gridContainer.style.gridTemplateRows="repeat("+q.rowCount+", "+height+"px)"),q.gridWrapper&&(q.gridWrapper.style.padding=padding+"px"),q.outerDiv.querySelectorAll(".cell-container").forEach(function(h){h.style.width=width+"px",h.style.height=height+"px"}),q.outerDiv.querySelectorAll(".cell-image-wrapper").forEach(function(h){h.style.width=width+"px",h.style.height=height+"px"}),q.outerDiv.querySelectorAll(".selected-label, .pre-assigned-label").forEach(function(l){l.style.fontSize=fontSize+"rem"}),q.cellWidth=width,q.cellHeight=height}function buildCenterCell(q,cellContainer){var cellDiv=document.createElement("div");cellDiv.className="cell center-cell",cellDiv.id="center-cell-id";var centerLabel=document.createElement("div");centerLabel.className="center-cell-label",q.centerLabelText?centerLabel.innerHTML=sanitizeHTMLFn(q.centerLabelText):centerLabel.innerHTML="Your<br>House",cellDiv.appendChild(centerLabel),cellContainer.appendChild(cellDiv)}function addCellImage(q,cellContainer,id){var wrapper=document.createElement("div");wrapper.classList.add("cell-image-wrapper");var safeHTML=sanitizeHTMLFn(q.cellImageHTML);safeHTML.trim()||(safeHTML=sanitizeHTMLFn(globalThis.NeighborhoodQuestion&&globalThis.NeighborhoodQuestion.DEFAULT_CELL_SVG||FALLBACK_CELL_SVG)),wrapper.innerHTML=safeHTML;var loadId=id,img=wrapper.querySelector("img");img&&(img.complete||img.addEventListener("load",function(){loadId===q.imageLoadId&&measureCellSize(q,loadId)}),img.addEventListener("error",function(){loadId===q.imageLoadId&&(wrapper.innerHTML=sanitizeHTMLFn(globalThis.NeighborhoodQuestion&&globalThis.NeighborhoodQuestion.DEFAULT_CELL_SVG||FALLBACK_CELL_SVG),measureCellSize(q,loadId))})),cellContainer.appendChild(wrapper)}function addDropdownAndLabel(q,cellContainer,rowIndex,columnIndex){var contentContainer=document.createElement("div");contentContainer.classList.add("content-container");var selectContainer=document.createElement("div");selectContainer.classList.add("select-menu");var selectElement=document.createElement("select"),i=rowIndex*q.columnCount+columnIndex;selectElement.setAttribute("data-cell-index",i),selectElement.setAttribute("aria-label","Select attribute for cell "+(i+1));var initialOption=document.createElement("option");initialOption.value="",initialOption.disabled=!0,initialOption.selected=!0,initialOption.textContent="Select",selectElement.appendChild(initialOption),q.optionsData.forEach(function(optionText){var optionElement=document.createElement("option");optionElement.value=optionText,optionElement.text=optionText,selectElement.appendChild(optionElement)}),selectContainer.appendChild(selectElement),contentContainer.appendChild(selectContainer);var selectedLabel=document.createElement("div");selectedLabel.className="selected-label",selectedLabel.style.display="none",contentContainer.appendChild(selectedLabel),cellContainer.appendChild(contentContainer),selectElement.addEventListener("change",function(){var prev=selectElement.dataset.prevValue;prev&&(q.selectedCounts[prev]=(q.selectedCounts[prev]||1)-1);var val=selectElement.value;q.selectedCounts[val]=(q.selectedCounts[val]||0)+1,selectElement.dataset.prevValue=val,selectedLabel.innerText=val;var showSummary=!(!val||q.isExperimental&&q.interactionEnabled);q.isExperimental&&q.interactionEnabled?(selectedLabel.style.display=val?"block":"none",selectContainer.style.display="block"):(selectedLabel.style.display=showSummary?"block":"none",q.interactionEnabled&&(selectContainer.style.display="none")),showQuotaWarningsFn(q)}.bind(q)),q.isExperimental||cellContainer.addEventListener("click",function(event){"select"!==event.target.tagName.toLowerCase()&&(selectContainer.style.display="block",selectElement.focus(),selectedLabel.style.display="none")})}function buildNeighborCell(q,cellContainer,rowIndex,columnIndex){var i=rowIndex*q.columnCount+columnIndex;if(q.isLockedCell(rowIndex,columnIndex)){addCellImage(q,cellContainer,q.imageLoadId);var contentContainer=document.createElement("div");contentContainer.classList.add("content-container");var marker=document.createElement("div");marker.classList.add("static-index-marker"),marker.dataset.cellIndex=i,marker.hidden=!0,contentContainer.appendChild(marker);var locked=document.createElement("div");return locked.classList.add("locked-cell"),contentContainer.appendChild(locked),cellContainer.classList.add("fixed-trait-cell"),cellContainer.appendChild(contentContainer),void addExperimentalLabelFn(q,cellContainer)}if(addCellImage(q,cellContainer,q.imageLoadId),q.interactionEnabled)if(q.useTokens){var dropTarget=document.createElement("div");dropTarget.classList.add("token-drop"),dropTarget.setAttribute("data-cell-index",i),dropTarget.setAttribute("tabindex","0"),dropTarget.setAttribute("role","button"),dropTarget.setAttribute("aria-label","Drop zone for row ".concat(rowIndex+1,", column ").concat(columnIndex+1)),dropTarget.addEventListener("dragover",function(e){return e.preventDefault()}),dropTarget.addEventListener("drop",function(e){e.preventDefault();var dataTransfer=e.dataTransfer;if(dataTransfer){var id=dataTransfer.getData("text/plain");if(id){var token=document.getElementById(id);if(token){var tokenElement=token;q.tokenBank&&token.parentElement===q.tokenBank&&(tokenElement=function(q,token){return token?spawnTokenValue(q,token.dataset?token.dataset.value:null,!!token.dataset&&"true"===token.dataset.unlimited):null}(q,token),!tokenElement)||placeTokenElement(q,dropTarget,tokenElement)&&("function"==typeof q.clearKeyboardSelection&&q.clearKeyboardSelection(),showQuotaWarningsFn(q))}}}}),cellContainer.addEventListener("click",function(){removeTokenFromDropTarget(q,dropTarget)&&("function"==typeof q.clearKeyboardSelection&&q.clearKeyboardSelection(),showQuotaWarningsFn(q))}),dropTarget.addEventListener("keydown",function(event){if("Enter"===event.key||" "===event.key||"Spacebar"===event.key)if(event.preventDefault(),q.keyboardTokenSelection){var selection=q.keyboardTokenSelection,newToken=spawnTokenValue(q,selection.value,!!selection.unlimited);if(!newToken)return;placeTokenElement(q,dropTarget,newToken),"function"==typeof q.clearKeyboardSelection&&q.clearKeyboardSelection(),showQuotaWarningsFn(q)}else removeTokenFromDropTarget(q,dropTarget)&&("function"==typeof q.clearKeyboardSelection&&q.clearKeyboardSelection(),showQuotaWarningsFn(q));else if("Delete"===event.key||"Backspace"===event.key){if(event.preventDefault(),!removeTokenFromDropTarget(q,dropTarget))return;"function"==typeof q.clearKeyboardSelection&&q.clearKeyboardSelection(),showQuotaWarningsFn(q)}else"Escape"===event.key&&"function"==typeof q.clearKeyboardSelection&&q.clearKeyboardSelection()});var _contentContainer2=document.createElement("div");_contentContainer2.classList.add("content-container"),_contentContainer2.appendChild(dropTarget),cellContainer.appendChild(_contentContainer2)}else addDropdownAndLabel(q,cellContainer,rowIndex,columnIndex);else{var _contentContainer=document.createElement("div");_contentContainer.classList.add("content-container");var _marker=document.createElement("div");_marker.classList.add("static-index-marker"),_marker.dataset.cellIndex=i,_marker.hidden=!0,_contentContainer.appendChild(_marker),cellContainer.appendChild(_contentContainer)}addExperimentalLabelFn(q,cellContainer)}function populateGrid(q,gridContainer){if(gridContainer){gridContainer.querySelectorAll("[data-cell-index]").forEach(function(el){return el.removeAttribute("data-cell-index")}),gridContainer.querySelectorAll(".pre-assigned-label").forEach(function(el){return el.remove()}),gridContainer.innerHTML="";for(var rowIndex=0;rowIndex<q.rowCount;rowIndex++)for(var columnIndex=0;columnIndex<q.columnCount;columnIndex++){var cellContainer=document.createElement("div");cellContainer.classList.add("cell-container"),q.includeCenterCell&&rowIndex===q.calculateCenterCellRow()&&columnIndex===q.calculateCenterCellColumn()?buildCenterCell(q,cellContainer):buildNeighborCell(q,cellContainer,rowIndex,columnIndex),gridContainer.appendChild(cellContainer)}}}function measureCellSize(q,id){if(!(void 0!==id&&id!==q.imageLoadId||q.cellWidth&&q.cellHeight)){var wrapper=q.outerDiv.querySelector(".cell-image-wrapper");if(wrapper){var rect=wrapper.getBoundingClientRect();rect.width&&rect.height&&(q.cellWidth=rect.width,q.cellHeight=rect.height,q.gridContainer&&(q.gridContainer.style.gridTemplateColumns="repeat("+q.columnCount+", "+q.cellWidth+"px)",q.gridContainer.style.gridTemplateRows="repeat("+q.rowCount+", "+q.cellHeight+"px)"),q.outerDiv.querySelectorAll(".cell-container").forEach(function(h){h.style.width=q.cellWidth+"px",h.style.height=q.cellHeight+"px"}))}}}function checkAndWarnAttributeFit(q,attributes){var fontSize=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,warningDiv=document.getElementById("warnings");if(warningDiv)if(q.cellWidth){var tester=document.createElement("span");tester.style.visibility="hidden",tester.style.fontSize=fontSize+"rem",tester.style.whiteSpace="nowrap",document.body.appendChild(tester);var tooLong=[],max=.85*q.cellWidth;attributes.forEach(function(t){tester.textContent=t,tester.offsetWidth>max&&tooLong.push(t)}),tester.remove(),tooLong.length?warningDiv.dataset.attrWarnings="Warning: these labels may not fit - "+tooLong.join(", "):warningDiv.dataset.attrWarnings="",updateWarningTextFn(warningDiv)}else warningDiv.innerHTML=""}function centerGrid(q){var wrapper=q.gridWrapper||q.outerDiv.querySelector(".grid-wrapper"),grid=q.gridContainer||document.getElementById("grid-id");if(wrapper&&grid){wrapper.scrollLeft=(grid.scrollWidth-wrapper.clientWidth)/2;var styles=window.getComputedStyle(grid),marginTop=parseFloat(styles.marginTop)||0,marginBottom=parseFloat(styles.marginBottom)||0;wrapper.scrollTop=(grid.scrollHeight+marginTop+marginBottom-wrapper.clientHeight)/2}}function selectWeightedScenario(q){var scenarios=q&&q.experimentalScenarios;if(!Array.isArray(scenarios)||0===scenarios.length)return null;var _step2,r=Math.random(),cumulative=0,_iterator2=_createForOfIteratorHelper(scenarios);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var scenario=_step2.value;if(r<(cumulative+="number"==typeof scenario.probability?scenario.probability:0))return scenario}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return scenarios[scenarios.length-1]}function buildDeterministicTraitArray(cellCount,traits){var traitList=Array.isArray(traits)?traits.filter(function(t){return"string"==typeof t}):[],fallbackTrait=traitList.length>0&&"string"==typeof traitList[traitList.length-1]?traitList[traitList.length-1]:"",available=traitList.length>0?traitList:[fallbackTrait],result=[];if(cellCount<=0)return result;for(var i=0;i<cellCount;i++){var trait=available[i%available.length];result.push("string"==typeof trait&&trait.length?trait:fallbackTrait)}return result}function ensureTraitArrayLength(traitArray,desiredLength,traits){var list=Array.isArray(traitArray)?traitArray.slice(0,desiredLength):[];if(list.length===desiredLength)return list;var filler=buildDeterministicTraitArray(desiredLength-list.length,traits);return list.concat(filler)}function randomizeExperimentalTraits(q){if(q){var totalCells=q.rowCount*q.columnCount,interactiveCellCount=totalCells-(q.includeCenterCell?1:0),traits=Array.isArray(q.experimentalTraits)?q.experimentalTraits.filter(function(t){return"string"==typeof t}):[],fallbackTrait=traits.length>0&&"string"==typeof traits[traits.length-1]?traits[traits.length-1]:"",sanitizedScenario=function(scenario){return scenario&&"object"===_typeof(scenario)?{name:"string"==typeof scenario.name?scenario.name:"",weight:"number"==typeof scenario.probability&&Number.isFinite(scenario.probability)?scenario.probability:0,proportions:(Array.isArray(scenario.proportions)?scenario.proportions:[]).map(function(value){return"number"==typeof value&&Number.isFinite(value)&&value>0?value:0}),layout:"string"==typeof scenario.layout?scenario.layout:"weighted",valid:!0}:{name:"",weight:0,proportions:[],layout:"weighted",valid:!1}}(selectWeightedScenario(q));q.scenarioName=sanitizedScenario.name,q.scenarioWeight=sanitizedScenario.weight,q.scenarioLayout=sanitizedScenario.layout,q.scenarioProportions=sanitizedScenario.proportions.slice();var traitArray=[];try{if(sanitizedScenario.valid&&traits.length>0&&interactiveCellCount>0&&"weighted"===sanitizedScenario.layout){for(var slotCount=Math.max(traits.length,sanitizedScenario.proportions.length,1),weights=[],i=0;i<slotCount;i++){var raw=sanitizedScenario.proportions[i];weights.push("number"==typeof raw&&raw>0?raw:0)}for(var total=weights.reduce(function(sum,value){return sum+value},0),normalizedTotal=total>0?total:slotCount,cumulativeProportion=[],runningTotal=0,_i=0;_i<slotCount;_i++){runningTotal+=(total>0?weights[_i]:1)/normalizedTotal,cumulativeProportion.push(runningTotal)}for(var _loop2=function(){var r=Math.random(),traitIdx=cumulativeProportion.findIndex(function(threshold){return r<=threshold+Number.EPSILON});-1===traitIdx&&(traitIdx=slotCount-1),traitIdx>=traits.length&&(traitIdx=traits.length-1);var trait=traitIdx>=0?traits[traitIdx]:fallbackTrait;traitArray.push("string"==typeof trait&&trait.length?trait:fallbackTrait)},_i2=0;_i2<interactiveCellCount;_i2++)_loop2()}else if(sanitizedScenario.valid&&traits.length>0&&interactiveCellCount>0&&sanitizedScenario.proportions.length>0){if(sanitizedScenario.proportions.forEach(function(count,idx){for(var trait=idx<traits.length&&"string"==typeof traits[idx]?traits[idx]:fallbackTrait,repeats="number"==typeof count&&count>0?Math.floor(count):0,_i3=0;_i3<repeats;_i3++)traitArray.push(trait)}),traitArray=ensureTraitArrayLength(traitArray,interactiveCellCount,traits),"shuffle"===sanitizedScenario.layout)for(var _i4=traitArray.length-1;_i4>0;_i4--){var j=Math.floor(Math.random()*(_i4+1)),_ref=[traitArray[j],traitArray[_i4]];traitArray[_i4]=_ref[0],traitArray[j]=_ref[1]}}else traitArray=ensureTraitArrayLength([],interactiveCellCount,traits)}catch(err){traitArray=ensureTraitArrayLength([],interactiveCellCount,traits)}if(q.includeCenterCell){var centerCellIndex=q.calculateCenterCellRow()*q.columnCount+q.calculateCenterCellColumn(),copy=traitArray.slice();copy.splice(centerCellIndex,0,"your house"),traitArray=copy}if(0===traitArray.length&&totalCells>0&&(traitArray=buildDeterministicTraitArray(totalCells,traits)),traitArray.length>totalCells)traitArray=traitArray.slice(0,totalCells);else if(traitArray.length<totalCells){var filler=buildDeterministicTraitArray(totalCells-traitArray.length,traits);traitArray=traitArray.concat(filler)}q.traitArray=traitArray}}function makeDropdownOptionList(dropdownOptionsInput){var list=dropdownOptionsInput.value.split(",").map(function(option){return option.trim()}).filter(function(option){return option});if(0===list.length)throw new Error("Dropdown options list cannot be empty.");return list}function parseQuotaList(quotaInput){for(var parts=quotaInput.value.split(",").map(function(q){return q.trim()});parts.length&&""===parts[parts.length-1];)parts.pop();return parts.map(function(p){return""===p?0:/^-?\d+$/.test(p)?parseInt(p,10):NaN})}function getCellImageHTML(formInputs){return new Promise(function(resolve){if(formInputs.defaultCellCheckbox&&formInputs.defaultCellCheckbox.checked)resolve(null);else{var method=formInputs.cellImageMethodSelect?formInputs.cellImageMethodSelect.value:"file";if("svg"!==method)if("file"!==method)if("url"!==method)resolve(null);else{var url=formInputs.cellImageURLInput.value.trim();resolve(url?'<img src="'+url+'" alt="Cell icon" />':null)}else{if(formInputs.cellImageFileInput.files.length>0){var reader=new FileReader;return reader.onload=function(){resolve('<img src="'+reader.result+'" alt="Cell icon" />')},reader.onerror=function(){resolve(null)},void reader.readAsDataURL(formInputs.cellImageFileInput.files[0])}resolve(null)}else{var val=formInputs.cellImageSVGInput.value.trim();resolve(val?'<span role="img" aria-label="Cell icon">'+val+"</span>":null)}}})}function getBackgroundImageURL(formInputs){var url=(formInputs.backgroundImageURLInput.value||"").trim();if(!url)return null;try{var parsed=new URL(url,"http://example.com"),hasScheme=/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(url);return"javascript:"===parsed.protocol||url.startsWith("//")||hasScheme&&"http:"!==parsed.protocol&&"https:"!==parsed.protocol?null:url}catch(e){return null}}function displayError(message){var errorDiv=document.getElementById("errorMessage");errorDiv&&(errorDiv.textContent=message?"Error: ".concat(message):"")}function highlightInput(el){el&&el.classList&&el.classList.add&&el.classList.add("input-error")}function clearInputHighlights(){document&&document.querySelectorAll&&document.querySelectorAll(".input-error").forEach(function(el){el.classList&&el.classList.remove&&el.classList.remove("input-error")})}function clearError(){displayError("")}function validateQuestion(formInputs){var errors=[],result={rows:Number(formInputs.rowInput.value),cols:Number(formInputs.columnInput.value),options:[],traits:[]},interactionEnabled=!formInputs.userInteractionCheckbox||formInputs.userInteractionCheckbox.checked;formInputs.questionTextInput.value.trim().length>200&&(errors.push("Question text must be under 200 characters."),qMessages.highlightInput(formInputs.questionTextInput));var rows=result.rows;Number.isInteger(rows)?(rows>10&&(errors.push("Maximum rows is 10."),qMessages.highlightInput(formInputs.rowInput)),rows<1&&(errors.push("Rows must be at least 1."),qMessages.highlightInput(formInputs.rowInput))):(errors.push("Rows must be an integer between 1 and 10."),qMessages.highlightInput(formInputs.rowInput));var cols=result.cols;if(Number.isInteger(cols)?(cols>10&&(errors.push("Maximum columns is 10."),qMessages.highlightInput(formInputs.columnInput)),cols<1&&(errors.push("Columns must be at least 1."),qMessages.highlightInput(formInputs.columnInput))):(errors.push("Columns must be an integer between 1 and 10."),qMessages.highlightInput(formInputs.columnInput)),formInputs.enableCenterCell&&formInputs.enableCenterCell.checked){var r=parseInt(formInputs.centerCellRowInput.value,10),c=parseInt(formInputs.centerCellColumnInput.value,10);!Number.isNaN(r)&&(r<1||r>rows)&&(errors.push("Center row must be between 1 and ".concat(rows,".")),qMessages.highlightInput(formInputs.centerCellRowInput)),!Number.isNaN(c)&&(c<1||c>cols)&&(errors.push("Center column must be between 1 and ".concat(cols,".")),qMessages.highlightInput(formInputs.centerCellColumnInput))}var options=[];if(interactionEnabled)try{options=qMakeList(formInputs.dropdownOptionsInput)}catch(e){errors.push(e.message),qMessages.highlightInput(formInputs.dropdownOptionsInput)}result.options=options,interactionEnabled&&(options.length>20&&(errors.push("Maximum of 20 dropdown options allowed."),qMessages.highlightInput(formInputs.dropdownOptionsInput)),options.some(function(opt){return opt.length>50})&&(errors.push("Dropdown option text too long (50 char max)."),qMessages.highlightInput(formInputs.dropdownOptionsInput))),formInputs.centerLabelInput.value.trim().length>50&&(errors.push("Center label must be under 50 characters."),qMessages.highlightInput(formInputs.centerLabelInput));var traits=[],traitField=formInputs.experimentalTraitsInput,hasTraitEntries=traitField&&"string"==typeof traitField.value&&traitField.value.split(",").map(function(part){return part.trim()}).filter(Boolean).length>0;if(formInputs.experimentalRadioInput&&formInputs.experimentalRadioInput.checked&&hasTraitEntries)try{traits=qMakeList(traitField)}catch(e){var msg="Dropdown options list cannot be empty."===e.message?"Trait list cannot be empty.":e.message;errors.push(msg),qMessages.highlightInput(traitField)}result.traits=traits,traits.length>20&&(errors.push("Maximum of 20 experimental traits allowed."),qMessages.highlightInput(formInputs.experimentalTraitsInput)),traits.some(function(t){return t.length>50})&&(errors.push("Trait text too long (50 char max)."),qMessages.highlightInput(formInputs.experimentalTraitsInput));var gap=parseInt(formInputs.gridGapInput.value,10);(Number.isNaN(gap)||gap<0||gap>100)&&(errors.push("Gap must be between 0 and 100."),qMessages.highlightInput(formInputs.gridGapInput));var pad=parseInt(formInputs.gridPaddingInput.value,10);if((Number.isNaN(pad)||pad<0||pad>100)&&(errors.push("Padding must be between 0 and 100."),qMessages.highlightInput(formInputs.gridPaddingInput)),formInputs.labelFontSizeInput){var fontSize=parseFloat(formInputs.labelFontSizeInput.value);(Number.isNaN(fontSize)||fontSize<.5||fontSize>2)&&(errors.push("Font size must be between 0.5 and 2."),qMessages.highlightInput(formInputs.labelFontSizeInput))}if(formInputs.cellWidthInput){var width=parseInt(formInputs.cellWidthInput.value,10);(Number.isNaN(width)||width<80||width>150)&&(errors.push("Cell width must be between 80 and 150."),qMessages.highlightInput(formInputs.cellWidthInput))}if(formInputs.cellHeightInput){var height=parseInt(formInputs.cellHeightInput.value,10);(Number.isNaN(height)||height<100||height>180)&&(errors.push("Cell height must be between 100 and 180."),qMessages.highlightInput(formInputs.cellHeightInput))}var bgUrl=formInputs.backgroundImageURLInput.value.trim();if(bgUrl.length>200)errors.push("Background image URL too long (200 char max)."),qMessages.highlightInput(formInputs.backgroundImageURLInput);else if(bgUrl)try{var parsed=new URL(bgUrl,"http://example.com"),hasScheme=/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(bgUrl);if("javascript:"===parsed.protocol||bgUrl.startsWith("//")||hasScheme&&"http:"!==parsed.protocol&&"https:"!==parsed.protocol)throw new Error("bad scheme")}catch(e){errors.push("Invalid background image URL."),qMessages.highlightInput(formInputs.backgroundImageURLInput)}return _objectSpread({errors:errors},result)}function validateScenarios(formInputs,traits){var errors=[];if(formInputs.experimentalRadioInput&&formInputs.experimentalRadioInput.checked){var scenarios=document.querySelectorAll("#scenarios-container .scenario");scenarios.length>10&&errors.push("Maximum of 10 scenarios allowed."),scenarios.forEach(function(sc){var name=sc.querySelector('input[name="scenarioName"]').value.trim();name.length>50&&(errors.push("Scenario names must be under 50 characters."),scMessages.highlightInput(sc.querySelector('input[name="scenarioName"]')));var eq=sc.querySelector('input[name="equalProbability"]'),props=[];if(eq&&!eq.checked){var inputs=sc.querySelectorAll(".trait-probabilities input");if((props=Array.from(inputs).map(function(p){return parseProbability(p.value)}).filter(function(p){return!isNaN(p)})).length===inputs.length-1){var sum=props.reduce(function(a,b){return a+b},0);props.push(Math.max(0,1-sum))}}if(props.length&&props.length!==traits.length){errors.push('Trait distribution for scenario "'.concat(name||"Unnamed",'" must match number of traits.'));var hl=sc.querySelector(".trait-probabilities input")||null;scMessages.highlightInput(hl)}if(props.some(function(p){return p<0||p>1||isNaN(p)})){errors.push('Trait distribution for scenario "'.concat(name||"Unnamed",'" must be fractions or percentages between 0 and 1.'));var _hl=sc.querySelector(".trait-probabilities input")||null;scMessages.highlightInput(_hl)}if(props.length&&Math.abs(props.reduce(function(a,b){return a+b},0)-1)>.001){errors.push('Trait distribution for scenario "'.concat(name||"Unnamed",'" must sum to 1.'));var _hl2=sc.querySelector(".trait-probabilities input")||null;scMessages.highlightInput(_hl2)}})}return errors}function validateQuotas(formInputs,options,rows,cols){var errors=[];if(!(!formInputs.userInteractionCheckbox||formInputs.userInteractionCheckbox.checked))return errors;if(!formInputs.enableQuotasCheckbox||!formInputs.enableQuotasCheckbox.checked)return errors;var quotas=tvParseList(formInputs.optionQuotaInput);if(!Array.isArray(quotas)||0===quotas.length)return errors;quotas.length!==options.length&&(errors.push("Quotas must match number of options."),tMessages.highlightInput(formInputs.optionQuotaInput));var cellCount=parseInt(formInputs.rowInput.value,10)*parseInt(formInputs.columnInput.value,10)-(formInputs.enableCenterCell&&formInputs.enableCenterCell.checked?1:0);return quotas.some(function(q){return isNaN(q)||q<0||!Number.isInteger(q)||q>cellCount})&&(errors.push("Quotas must be integers between 0 and cell count."),tMessages.highlightInput(formInputs.optionQuotaInput)),errors}function validateInputs(formInputs){clearHighlights();var _questionValidator=questionValidator(formInputs),qErrs=_questionValidator.errors,rows=_questionValidator.rows,cols=_questionValidator.cols,options=_questionValidator.options,traits=_questionValidator.traits,scErrs=scenarioValidator(formInputs,traits),quotaErrs=quotaValidator(formInputs,options,rows,cols);return[].concat(_toConsumableArray(qErrs),_toConsumableArray(scErrs),_toConsumableArray(quotaErrs))}function handleInputChange(_x,_x2,_x3){return _handleInputChange.apply(this,arguments)}function _handleInputChange(){return(_handleInputChange=_asyncToGenerator(_regenerator().m(function _callee2(formInputs,neighborhoodQuestion,surveyQuestionDiv){var id,includeCenterInitially,initialRowNum,initialColNum,centerRow,centerCol,rowMax,clampedRow,colMax,clampedCol,errors,rowData,columnData,questionText,interactionEnabled,optionsData,centerLabelText,includeCenter,isExperimental,experimentalTraits,parseFn,experimentalScenarios,idx,quotas,parsedQuotas,useTokens,shuffleSeedRaw,shuffleSeed,shuffleOrderRaw,shuffleOrder,customImageHTML,backgroundURL,realized,_preview,missingMsg,indicator,_t2,_t3;return _regenerator().w(function(_context2){for(;;)switch(_context2.p=_context2.n){case 0:if(id=++previewUpdateId,includeCenterInitially=formInputs.enableCenterCell&&formInputs.enableCenterCell.checked,initialRowNum=parseFloat(formInputs.rowInput.value),initialColNum=parseFloat(formInputs.columnInput.value),centerRow=parseInt(formInputs.centerCellRowInput.value,10),centerCol=parseInt(formInputs.centerCellColumnInput.value,10),includeCenterInitially&&(Number.isNaN(initialRowNum)||(rowMax=Math.max(1,Math.floor(initialRowNum)),Number.isNaN(centerRow)?(centerRow=Math.ceil(initialRowNum/2),formInputs.centerCellRowInput.value=String(centerRow)):(clampedRow=Math.max(1,Math.min(centerRow,rowMax)))!==centerRow&&(centerRow=clampedRow,formInputs.centerCellRowInput.value=String(clampedRow))),Number.isNaN(initialColNum)||(colMax=Math.max(1,Math.floor(initialColNum)),Number.isNaN(centerCol)?(centerCol=Math.ceil(initialColNum/2),formInputs.centerCellColumnInput.value=String(centerCol)):(clampedCol=Math.max(1,Math.min(centerCol,colMax)))!==centerCol&&(centerCol=clampedCol,formInputs.centerCellColumnInput.value=String(clampedCol)))),!((errors=validate(formInputs)).length>0)){_context2.n=1;break}return showError(errors[0]),surveyQuestionDiv.innerHTML="<p>Please correct the highlighted errors to see the live preview.</p>",_context2.a(2);case 1:if(clearErr(),rowData=formInputs.rowInput.value,columnData=formInputs.columnInput.value,questionText=formInputs.questionTextInput.value,interactionEnabled=!formInputs.userInteractionCheckbox||formInputs.userInteractionCheckbox.checked,optionsData=[],!interactionEnabled){_context2.n=4;break}_context2.p=2,optionsData=pvMakeList(formInputs.dropdownOptionsInput),_context2.n=4;break;case 3:return _context2.p=3,_t2=_context2.v,showError(_t2.message),surveyQuestionDiv.innerHTML="<p>Please correct the highlighted errors to see the live preview.</p>",_context2.a(2);case 4:if(centerLabelText=formInputs.centerLabelInput.value,includeCenter=formInputs.enableCenterCell.checked,centerRow=parseInt(formInputs.centerCellRowInput.value,10),centerCol=parseInt(formInputs.centerCellColumnInput.value,10),parseFloat(rowData),parseFloat(columnData),isExperimental=formInputs.experimentalRadioInput.checked,experimentalTraits=[],!isExperimental){_context2.n=7;break}_context2.p=5,experimentalTraits=pvMakeList(formInputs.experimentalTraitsInput),_context2.n=7;break;case 6:return _context2.p=6,_t3=_context2.v,showError(_t3.message),surveyQuestionDiv.innerHTML="<p>Please correct the highlighted errors to see the live preview.</p>",_context2.a(2);case 7:return parseFn="function"==typeof globalThis.parseExperimentalScenarios?globalThis.parseExperimentalScenarios:parseScenariosDefault,experimentalScenarios=parseFn(experimentalTraits.length),isExperimental&&Array.isArray(experimentalScenarios)&&"number"==typeof globalThis.currentScenarioIndex&&experimentalScenarios.length>0&&(idx=Math.max(0,Math.min(globalThis.currentScenarioIndex,experimentalScenarios.length-1)),experimentalScenarios=experimentalScenarios.map(function(sc,i){return{name:sc.name,proportions:sc.proportions,layout:sc.layout,probability:i===idx?1:0}})),quotas=null,interactionEnabled&&formInputs.enableQuotasCheckbox&&formInputs.enableQuotasCheckbox.checked&&(parsedQuotas=pvParseList(formInputs.optionQuotaInput),quotas=Array.isArray(parsedQuotas)&&parsedQuotas.length?parsedQuotas:null),useTokens=interactionEnabled&&formInputs.dragDropCheckbox.checked,shuffleSeedRaw=formInputs.optionShuffleSeed?formInputs.optionShuffleSeed.value.trim():"",shuffleSeed=""===shuffleSeedRaw?null:shuffleSeedRaw,shuffleOrderRaw=formInputs.optionShuffleOrder?formInputs.optionShuffleOrder.value.trim():"",shuffleOrder=shuffleOrderRaw?shuffleOrderRaw.split(",").map(function(s){return s.trim()}).filter(function(s){return""!==s}):null,_context2.n=8,pvGetCellImageHTML(formInputs);case 8:if(customImageHTML=_context2.v,backgroundURL=pvGetBackgroundImageURL(formInputs),id===previewUpdateId){_context2.n=9;break}return _context2.a(2);case 9:if(rowData||columnData||questionText||interactionEnabled&&0!==optionsData.length){_context2.n=10;break}neighborhoodQuestion.renderDefault(isExperimental),_context2.n=13;break;case 10:if(!(parseFloat(rowData)>0&&parseFloat(columnData)>0&&(!interactionEnabled||optionsData.length>0))){_context2.n=12;break}if(!isExperimental){_context2.n=11;break}if(0!==experimentalTraits.length&&0!==experimentalScenarios.length){_context2.n=11;break}return surveyQuestionDiv.innerHTML="<p>Please enter experimental traits and proportions or switch back to blank neighborhood design to see the live preview.</p>",_context2.a(2);case 11:neighborhoodQuestion.renderQuestion(questionText,parseFloat(columnData),parseFloat(rowData),optionsData,centerLabelText,includeCenter,isNaN(centerCol)?null:centerCol,isNaN(centerRow)?null:centerRow,isExperimental,experimentalTraits,experimentalScenarios,null,customImageHTML,backgroundURL,null,useTokens,quotas,null,interactionEnabled,formInputs.skipBehaviorSelect.value,void 0,void 0,shuffleSeed,shuffleOrder),formInputs.optionShuffleOrder&&(realized=Array.isArray(neighborhoodQuestion.realizedOptionOrder)?neighborhoodQuestion.realizedOptionOrder.join(","):"",formInputs.optionShuffleOrder.value=realized),interactionEnabled||surveyQuestionDiv.querySelectorAll(".select-menu select").forEach(function(select){select.disabled=!0;var wrapper=select.closest(".select-menu");wrapper&&(wrapper.style.display="none")}),neighborhoodQuestion.setStyles(parseInt(formInputs.gridGapInput.value,10)||0,parseInt(formInputs.gridPaddingInput.value,10)||0,formInputs.labelFontSizeInput&&parseFloat(formInputs.labelFontSizeInput.value)||1,formInputs.cellWidthInput&&parseInt(formInputs.cellWidthInput.value,10)||100,formInputs.cellHeightInput&&parseInt(formInputs.cellHeightInput.value,10)||120),neighborhoodQuestion.checkAndWarnAttributeFit&&neighborhoodQuestion.checkAndWarnAttributeFit([].concat(_toConsumableArray(optionsData),_toConsumableArray(experimentalTraits||[]),[centerLabelText]),formInputs.labelFontSizeInput&&parseFloat(formInputs.labelFontSizeInput.value)||1),(_preview=document.querySelector(".preview"))&&_preview.style&&formInputs.previewWidthInput&&formInputs.previewHeightInput&&(_preview.style.width="".concat(formInputs.previewWidthInput.value,"px"),_preview.style.height="".concat(formInputs.previewHeightInput.value,"px")),_context2.n=13;break;case 12:missingMsg=interactionEnabled?"<p>Please enter a row count, a column count, and dropdown options to see the live preview.</p>":"<p>Please enter a row count and a column count to see the live preview.</p>",surveyQuestionDiv.innerHTML=missingMsg;case 13:(indicator=document.getElementById("scenarioNameIndicator"))&&(indicator.textContent=isExperimental&&neighborhoodQuestion.scenarioName||"");case 14:return _context2.a(2)}},_callee2,null,[[5,6],[2,3]])}))).apply(this,arguments)}function normalizeScenarioWeights(arr){var sanitized=arr.map(function(sc){var w=parseFloat(sc.weight),weight=isNaN(w)?1:Math.max(0,w);return{name:sc.name,proportions:sc.proportions,layout:sc.layout,weight:weight}}),total=sanitized.reduce(function(sum,sc){return sum+sc.weight},0),count=sanitized.length,probs=function(values){var decimals=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(!Array.isArray(values)||0===values.length)return[];var factor=Math.pow(10,decimals),sanitized=values.map(function(value){return Number.isFinite(value)&&value>0?value:0}),total=sanitized.reduce(function(sum,value){return sum+value},0);if(0===total)return sanitized.map(function(){return 0});var expectedTotal=Math.round(total*factor),scaled=sanitized.map(function(value){return Math.round(value*factor)}),remainder=expectedTotal-scaled.reduce(function(sum,value){return sum+value},0);if(0!==remainder){var adjustOrder=sanitized.map(function(value,idx){return{value:value,idx:idx}}).sort(function(a,b){return b.value-a.value}).map(function(item){return item.idx});if(adjustOrder.length||adjustOrder.push(scaled.length-1),remainder>0)for(var leftover=remainder;leftover>0;){var _step3,_iterator3=_createForOfIteratorHelper(adjustOrder);try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var idx=_step3.value;if(0===leftover)break;scaled[idx]+=1,leftover-=1}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}else for(var deficit=-remainder;deficit>0;){var _step4,adjusted=!1,_iterator4=_createForOfIteratorHelper(adjustOrder);try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _idx=_step4.value;if(0===deficit)break;if(0!==scaled[_idx]){var reduction=Math.min(scaled[_idx],deficit);if(0!==reduction&&(scaled[_idx]-=reduction,adjusted=!0,0===(deficit-=reduction)))break}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}if(!adjusted)break}}return scaled.map(function(value){return value/factor})}(total>0?sanitized.map(function(sc){return sc.weight/total}):sanitized.map(function(){return count>0?1/count:0}),2);return sanitized.map(function(sc,idx){return{name:sc.name,proportions:sc.proportions,layout:sc.layout,probability:roundProbabilityValue(probs[idx],2)}})}function suggestProbabilities(container){var precision=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;if(container&&container.querySelectorAll){var inputs=container.querySelectorAll("input");if(0!==inputs.length){var values=Array.from(inputs).map(function(i){return parseProbability(i.value)}),filledSum=values.reduce(function(s,v){return isNaN(v)?s:s+v},0),remaining=values.reduce(function(c,v){return c+(isNaN(v)?1:0)},0),remainder=Math.max(0,1-filledSum),suggestion=remaining>0?parseFloat((remainder/remaining).toFixed(precision)):0;values.forEach(function(v,idx){isNaN(v)&&(inputs[idx].placeholder=String(suggestion))})}}}function checkProbabilitySums(){var warningDiv=document.getElementById("warnings");if(warningDiv&&warningDiv.dataset){var experimentalRadio=document.getElementById("experimentalDesignSelector");if(!(!experimentalRadio||!!experimentalRadio.checked))return document.querySelectorAll(".trait-probabilities, #scenarioProbabilityInputs").forEach(function(el){el&&el.classList&&el.classList.remove&&el.classList.remove("warning-outline")}),warningDiv.dataset.probWarnings="",void updateWarningText(warningDiv);var traitBad=!1,traitTotal=null;document.querySelectorAll(".trait-probabilities").forEach(function(div){var inputs=div.querySelectorAll("input");if(inputs.length){var vals=Array.from(inputs).map(function(i){return parseProbability(i.value)}),total=vals.reduce(function(sum,value){return sum+(isNaN(value)?0:value)},0),roundedTotal=roundProbabilityValue(total,2);vals.every(function(v){return!isNaN(v)})&&Math.abs(roundedTotal-1)<=.01?div.classList&&div.classList.remove&&div.classList.remove("warning-outline"):(div.classList&&div.classList.add&&div.classList.add("warning-outline"),traitBad=!0,traitTotal=roundedTotal)}else div.classList&&div.classList.remove&&div.classList.remove("warning-outline")});var scenarioBad=!1,scenarioTotal=null,scContainer=document.getElementById("scenarioProbabilityInputs"),eqSc=document.getElementById("scenarioEqualProbability");if(!scContainer||eqSc&&eqSc.checked)scContainer&&scContainer.classList&&scContainer.classList.remove&&scContainer.classList.remove("warning-outline");else{var inputs=scContainer.querySelectorAll("input");if(inputs.length){var vals=Array.from(inputs).map(function(i){return parseProbability(i.value)}),total=vals.reduce(function(sum,value){return sum+(isNaN(value)?0:value)},0),roundedTotal=roundProbabilityValue(total,2);vals.every(function(v){return!isNaN(v)})&&Math.abs(roundedTotal-1)<=.01?scContainer.classList&&scContainer.classList.remove&&scContainer.classList.remove("warning-outline"):(scContainer.classList&&scContainer.classList.add&&scContainer.classList.add("warning-outline"),scenarioBad=!0,scenarioTotal=roundedTotal)}else scContainer.classList&&scContainer.classList.remove&&scContainer.classList.remove("warning-outline")}var parts=[];if(traitBad){var totalText="number"==typeof traitTotal?" (current total: ".concat(roundProbabilityValue(traitTotal,2).toFixed(2),")"):"";parts.push("trait probabilities".concat(totalText))}if(scenarioBad){var _totalText="number"==typeof scenarioTotal?" (current total: ".concat(roundProbabilityValue(scenarioTotal,2).toFixed(2),")"):"";parts.push("scenario probabilities".concat(_totalText))}warningDiv.dataset.probWarnings=parts.length?"Warning: ".concat(parts.join(" and ")," must sum to 1"):"",updateWarningText(warningDiv)}}function updateTraitProbabilityInputs(){var traitsField=document.getElementById("experimentalTraits"),traits=traitsField&&traitsField.value?traitsField.value.split(/\s*,\s*/).filter(function(t){return t}):[],traitCount=traits.length;document.querySelectorAll("#scenarios-container .scenario").forEach(function(sc){var eq=sc.querySelector('input[name="equalProbability"]'),container=sc.querySelector(".trait-probabilities");if(container&&eq){if(eq.checked||0===traitCount)return container.style.display="none",void(container.innerHTML="");container.style.display="block";for(var wrappers=container.querySelectorAll("label.trait-prob-label");wrappers.length<traitCount;){var label=document.createElement("label");label.className="trait-prob-label";var span=document.createElement("div");span.className="trait-name",label.appendChild(span);var inp=document.createElement("input");inp.type="text",inp.placeholder="0.25",inp.title="Probability for this trait (0-1)",label.appendChild(inp),container.appendChild(label),wrappers=container.querySelectorAll("label.trait-prob-label")}for(;wrappers.length>traitCount;)container.removeChild(container.lastChild),wrappers=container.querySelectorAll("label.trait-prob-label");wrappers.forEach(function(label,idx){var span=label.querySelector(".trait-name");span&&(span.textContent=traits[idx]?traits[idx].slice(0,10):""),label.querySelector("input").oninput=function(){suggestProbabilities(container),checkProbabilitySums()}}),suggestProbabilities(container),checkProbabilitySums()}})}function persistScenarioProbabilities(){var container=document.getElementById("scenarioProbabilityInputs");if(container){var inputs=container.querySelectorAll("input");document.querySelectorAll("#scenarios-container .scenario").forEach(function(sc,idx){var input=inputs[idx];input&&sc&&sc.dataset&&(sc.dataset.probability=input.value)})}}function updateScenarioProbabilityInputs(){if(document&&document.getElementById){var container=document.getElementById("scenarioProbabilityInputs"),eq=document.getElementById("scenarioEqualProbability");if(container&&eq){var scenarios=document.querySelectorAll("#scenarios-container .scenario");if(scenarios.length<2){container.style.display="none",container.innerHTML="";var _sec=document.getElementById("scenarioProbabilitySection");_sec&&_sec.style&&(_sec.style.display="none")}else{var previousValues=Array.from(container.querySelectorAll("input")).map(function(i){return i.value});container.innerHTML="",scenarios.forEach(function(sc,idx){var name=sc.querySelector('input[name="scenarioName"]').value||"Scenario ".concat(idx+1),label=document.createElement("label");label.textContent="".concat(name,": ");var inp=document.createElement("input");inp.type="text",inp.placeholder="0.25";var storedValue=(sc.dataset&&void 0!==sc.dataset.probability?sc.dataset.probability:previousValues[idx]||"")||"";inp.value=storedValue,sc.dataset&&(sc.dataset.probability=storedValue);var handleInput=function(){sc.dataset&&(sc.dataset.probability=inp.value),suggestProbabilities(container),checkProbabilitySums()};"function"==typeof inp.addEventListener?inp.addEventListener("input",handleInput):inp.oninput=handleInput,label.appendChild(inp),container.appendChild(label)});var sec=document.getElementById("scenarioProbabilitySection");sec&&sec.style&&(sec.style.display="block"),container.style.display=eq.checked?"none":"block",suggestProbabilities(container),checkProbabilitySums()}}}}function parseExperimentalScenarios(){var traitCount=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;updateTraitProbabilityInputs(),updateScenarioProbabilityInputs();var scenarios=document.querySelectorAll("#scenarios-container .scenario"),parsed=[];if(scenarios.forEach(function(scenario){var eq=scenario.querySelector('input[name="equalProbability"]'),probInputs=scenario.querySelectorAll(".trait-probabilities input"),proportionsField=scenario.querySelector('input[name="proportions"]'),layoutInput=scenario.querySelector('select[name="layoutStyle"]'),proportionArray=[];if(eq&&!eq.checked&&probInputs.length>0){if((proportionArray=Array.from(probInputs).map(function(p){return parseProbability(p.value)}).filter(function(p){return!isNaN(p)})).length===probInputs.length-1&&traitCount>0){var sum=proportionArray.reduce(function(a,b){return a+b},0);proportionArray.push(Math.max(0,1-sum))}}else proportionsField&&(proportionArray=proportionsField.value.split(",").map(function(p){return parseProbability(p)}).filter(function(p){return!isNaN(p)}));0===proportionArray.length&&traitCount>0&&(proportionArray=Array.from({length:traitCount},function(){return 1/traitCount})),proportionArray.length>0&&parsed.push({name:scenario.querySelector('input[name="scenarioName"]').value,proportions:proportionArray,layout:layoutInput?layoutInput.value:"weighted",weight:1})}),scenarios.length>1){var eqSc=document.getElementById("scenarioEqualProbability"),probContainer=document.getElementById("scenarioProbabilityInputs");if(eqSc&&probContainer&&!eqSc.checked){var inputs=probContainer.querySelectorAll("input"),probs=Array.from(inputs).map(function(p){return parseProbability(p.value)}).filter(function(p){return!isNaN(p)});if(probs.length===scenarios.length-1){var sum=probs.reduce(function(a,b){return a+b},0);probs.push(Math.max(0,1-sum))}probs.forEach(function(p,idx){idx<parsed.length&&(parsed[idx].weight=p)})}}return normalizeScenarioWeights(parsed)}function _getScenarioCount(){return document.querySelectorAll("#scenarios-container .scenario").length}function updateScenarioLimitUI(){var btn=document.getElementById("addScenarioBtn"),warn=document.getElementById("scenarioLimitWarning");if(btn||warn){var limitReached=_getScenarioCount()>=10;btn&&(btn.disabled=limitReached),warn&&warn.style&&(warn.style.display=limitReached?"inline":"none")}}function resetScenarioCount(){updateScenarioLimitUI(),toggleWeightInputs()}function toggleWeightInputs(){updateScenarioProbabilityInputs()}function addScenario(){persistScenarioProbabilities();var count=_getScenarioCount();if(count>=10)updateScenarioLimitUI();else{var container=document.getElementById("scenarios-container"),clone=document.getElementById("scenario-template").content.cloneNode(!0);clone.querySelector(".scenario-label").textContent="Scenario ".concat(count+1,":");var scenarioEl=clone.querySelector(".scenario");scenarioEl&&(scenarioEl.draggable=!0),container.appendChild(clone),updateScenarioLimitUI(),toggleWeightInputs(),updateTraitProbabilityInputs(),checkProbabilitySums();var eqInput=clone.querySelector('input[name="equalProbability"]');eqInput&&eqInput.addEventListener&&eqInput.addEventListener("change",function(){return updateTraitProbabilityInputs()}),globalThis.setCurrentScenarioIndex&&globalThis.setCurrentScenarioIndex(count)}}function removeScenario(button){persistScenarioProbabilities();var scenarioDiv=button.closest(".scenario"),index=_toConsumableArray(document.querySelectorAll("#scenarios-container .scenario")).indexOf(scenarioDiv);scenarioDiv.remove(),document.querySelectorAll("#scenarios-container .scenario-label").forEach(function(label,idx){label.textContent="Scenario ".concat(idx+1,":")}),updateScenarioLimitUI(),toggleWeightInputs(),checkProbabilitySums();var remaining=document.querySelectorAll("#scenarios-container .scenario").length;if(globalThis.setCurrentScenarioIndex){var newIndex=remaining>0?Math.min(index,remaining-1):0;globalThis.setCurrentScenarioIndex(newIndex)}}function sanitizeHTML(html){if(!html)return"";var sanitized=String(html);return sanitized=(sanitized=(sanitized=(sanitized=sanitized.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"")).replace(/[\u200B-\u200D\uFEFF]/g,"")).replace(/\s+on\w+(?:\s|\n)*=\s*(?:"[^"]*"|'[^']*'|[^\s>]+)/gi,"")).replace(/\s*j\s*a\s*v\s*a\s*s\s*c\s*r\s*i\s*p\s*t\s*:/gi,"")}function serializeCurrentInputs(){var inputs=document.querySelectorAll(".input-section input, .input-section textarea, .input-section select");if(!inputs.length)return{};var data={};inputs.forEach(function(el){"optionQuotaInput"!==el.id&&(el.classList&&el.classList.contains("quota-input")||"layoutStyle"!==el.name&&("cellImageSVG"!==el.id?"radio"===el.type?el.checked&&(data[el.id]=el.value):"checkbox"===el.type?data[el.id||el.name]=el.checked:data[el.id||el.name]=el.value:data[el.id]=el.value.trim()||_DEFAULT_CELL_SVG))}),document.querySelectorAll(".input-section select").forEach(function(el){el.closest("#scenarios-container .scenario")&&"layoutStyle"===el.name||(data[el.id||el.name]=el.value)});var quotaInput=document.getElementById("optionQuotaInput"),quotaContainer=document.getElementById("quotaInputContainer"),enableQuotas=document.getElementById("enableQuotas");if(enableQuotas&&enableQuotas.checked&&quotaInput){var quotas=[];if("function"==typeof quotaInputReader){var optionField=document.getElementById("dropdownOptionsInput"),optionList=optionField?optionField.value.split(",").map(function(opt){return opt.trim()}).filter(function(opt){return opt}):[];quotas=quotaInputReader({container:quotaContainer,hidden:quotaInput,options:optionList})}Array.isArray(quotas)&&quotas.length||!quotaInput.value.trim()||(quotas=quotaInput.value.split(",").map(function(q){return q.trim()}).map(function(q){if(""===q)return 0;var parsed=parseInt(q,10);return Number.isNaN(parsed)?NaN:parsed})),Array.isArray(quotas)&&quotas.length&&(data.quotas=quotas.map(function(value){return"number"!=typeof value||Number.isNaN(value)||value<0?null:value}))}var shuffleSeed=document.getElementById("optionShuffleSeed");if(shuffleSeed){var rawSeed="string"==typeof shuffleSeed.value?shuffleSeed.value:"";rawSeed.trim()&&(data.optionShuffleSeed=rawSeed.trim())}var shuffleOrder=document.getElementById("optionShuffleOrder");if(shuffleOrder){var rawOrder="string"==typeof shuffleOrder.value?shuffleOrder.value:"";rawOrder.trim()&&(data.optionShuffleOrder=rawOrder.trim())}var scenarioEls=document.querySelectorAll("#scenarios-container .scenario"),temp=[],probEq=document.getElementById("scenarioEqualProbability"),probInputs=document.querySelectorAll("#scenarioProbabilityInputs input"),probs=[];if(scenarioEls.length>1&&probEq&&!probEq.checked){probs=Array.from(probInputs).map(function(p){return parseProbability(p.value)}).map(function(n){return isNaN(n)||n<0?NaN:n});var missingIndexes=[];if(probs.forEach(function(value,idx){isNaN(value)&&missingIndexes.push(idx)}),1===missingIndexes.length){var missingIdx=missingIndexes[0],filledSum=probs.reduce(function(sum,value,idx){return idx===missingIdx||isNaN(value)?sum:sum+value},0);probs[missingIdx]=Math.max(0,1-filledSum)}}return scenarioEls.forEach(function(el,idx){var weight=probs[idx],probInputs=el.querySelectorAll(".trait-probabilities input"),proportions=Array.from(probInputs).map(function(p){return p.value||""}).join(",");temp.push({name:el.querySelector('input[name="scenarioName"]').value,proportions:proportions,layout:el.querySelector('select[name="layoutStyle"]').value,weight:isNaN(weight)?1:weight})}),data.scenarios=_normalizeScenarioWeights(temp),data.scenariosEqualProbability=scenarioEls.length<=1||!probEq||!!probEq.checked,data.version=_INPUTS_VERSION,data}function serializeInputs(tasks){return Array.isArray(tasks)?JSON.stringify(tasks):JSON.stringify(serializeCurrentInputs())}function _normalizeOptions(str){return str.split(",").map(function(s){return s.trim()}).filter(function(s){return s})}function carryForwardLayoutsMatch(portfolio,idx){if(!portfolio||!Array.isArray(portfolio))return!0;if(idx<0||idx>=portfolio.length)return!0;var task=portfolio[idx];if(!task||"number"!=typeof task.linkedTo)return!0;var source=portfolio[task.linkedTo];if(!source||!source.data)return!0;var current=serializeCurrentInputs(),src=source.data,currentRows=parseInt(current.rowInput,10),sourceRows=parseInt(src.rowInput,10),rowsMatch=Number.isNaN(currentRows)&&Number.isNaN(sourceRows)||currentRows===sourceRows,currentCols=parseInt(current.columnInput,10),sourceCols=parseInt(src.columnInput,10),colsMatch=Number.isNaN(currentCols)&&Number.isNaN(sourceCols)||currentCols===sourceCols,centerMatch=String(current.centerCellTextInput||"")===String(src.centerCellTextInput||""),enableMatch=String(current.enableCenterCell||"")===String(src.enableCenterCell||""),rowMatch=String(current.centerCellRowInput||"")===String(src.centerCellRowInput||""),colMatch=String(current.centerCellColumnInput||"")===String(src.centerCellColumnInput||""),optsMatch=JSON.stringify(_normalizeOptions(current.dropdownOptionsInput||""))===JSON.stringify(_normalizeOptions(src.dropdownOptionsInput||""));return rowsMatch&&colsMatch&&centerMatch&&enableMatch&&rowMatch&&colMatch&&optsMatch}function deserializeCurrentInputs(data){"cellImageSVG"in data&&data.cellImageSVG.trim()||(data.cellImageSVG=_DEFAULT_CELL_SVG);var version=data.version||0;version!==_INPUTS_VERSION&&console.warn("Unexpected input version ".concat(version,"; expected ").concat(_INPUTS_VERSION));var eqCheckbox=document.getElementById("scenarioEqualProbability");if(eqCheckbox&&Array.isArray(data.scenarios)){var explicit=Object.prototype.hasOwnProperty.call(data,"scenariosEqualProbability")?!!data.scenariosEqualProbability:void 0;eqCheckbox.checked=function(scenarios,explicit){if("boolean"==typeof explicit)return explicit;if(!Array.isArray(scenarios)||scenarios.length<=1)return!0;var values=scenarios.map(_extractNumericProbability);if(values.some(function(v){return isNaN(v)}))return!1;var sum=values.reduce(function(a,b){return a+b},0);if(0===sum)return!0;var expected=sum/values.length,tolerance=Math.max(.01*Math.abs(expected),.001);return values.every(function(v){return Math.abs(v-expected)<=tolerance})}(data.scenarios,explicit)}for(var _loop3=function(){var _Object$entries$_i=_slicedToArray(_Object$entries[_i5],2),key=_Object$entries$_i[0],value=_Object$entries$_i[1];if("scenarios"===key){var _document$getElementB;document.getElementById("scenarios-container").innerHTML="",_resetScenarioCount();var weightTotal=0;value.every(function(s){return"probability"in s})||(weightTotal=value.reduce(function(sum,s){var w=parseProbability(s.weight);return sum+(isNaN(w)?1:Math.max(0,w))},0)),value.forEach(function(scenario){"function"==typeof globalThis.addScenario&&globalThis.addScenario();var container=document.querySelectorAll("#scenarios-container .scenario"),latest=container[container.length-1];latest.querySelector('input[name="scenarioName"]').value=scenario.name;var probability,eqInput=latest.querySelector('input[name="equalProbability"]');if(scenario.proportions&&scenario.proportions.trim()?eqInput&&(eqInput.checked=!1):eqInput&&(eqInput.checked=!0),"probability"in scenario)probability=scenario.probability;else{var w=parseProbability(scenario.weight),weight=isNaN(w)?1:Math.max(0,w);probability=weightTotal>0?weight/weightTotal:0}if(latest&&latest.dataset&&(latest.dataset.probability=probability),scenario.layout){var sel=latest.querySelector('select[name="layoutStyle"]');sel&&(sel.value=scenario.layout)}}),globalThis.updateTraitProbabilityInputs&&globalThis.updateTraitProbabilityInputs();var traitCount=((null===(_document$getElementB=document.getElementById("experimentalTraits"))||void 0===_document$getElementB?void 0:_document$getElementB.value)||"").split(/\s*,\s*/).filter(function(t){return t}).length;document.querySelectorAll("#scenarios-container .scenario").forEach(function(el,idx){var sc=value[idx];if(sc&&sc.proportions&&traitCount){var parts=sc.proportions.split(/\s*,\s*/),inputs=el.querySelectorAll(".trait-probabilities input");parts.forEach(function(p,i){inputs[i]&&(inputs[i].value=p.trim())})}}),globalThis.updateScenarioProbabilityInputs&&globalThis.updateScenarioProbabilityInputs();var probInputs=document.querySelectorAll("#scenarioProbabilityInputs input");probInputs.forEach(function(inp,idx){var sc=document.querySelectorAll("#scenarios-container .scenario")[idx];sc&&sc.dataset.probability&&(inp.value=sc.dataset.probability)});var eq=document.getElementById("scenarioEqualProbability");eq&&0===probInputs.length&&(eq.checked=!0)}else if("quotas"===key){var input=document.getElementById("optionQuotaInput"),enable=document.getElementById("enableQuotas");enable&&(enable.checked=!0),input&&(input.value=value.map(function(v){return null==v?"":v}).join(", ")),"function"==typeof globalThis.updateQuotaInputs&&globalThis.updateQuotaInputs()}else{var el=document.getElementById(key);if(!el)return 0;if("cellImageSVG"===key){var val=value&&value.trim()?value:_DEFAULT_CELL_SVG;return el.value=val,el.defaultValue=val,0}if("radio"===el.type){var radio=document.querySelector('input[name="'.concat(el.name,'"][value="').concat(value,'"]'));radio&&(radio.checked=!0)}else"checkbox"===el.type?el.checked=function(value){if("boolean"==typeof value)return value;if("number"==typeof value)return 0!==value;if("string"==typeof value){var normalized=value.trim().toLowerCase();if(""===normalized||"false"===normalized||"0"===normalized||"off"===normalized||"no"===normalized)return!1;if("true"===normalized||"1"===normalized||"on"===normalized||"yes"===normalized)return!0}return!!value}(value):el.value=value}},_i5=0,_Object$entries=Object.entries(data);_i5<_Object$entries.length;_i5++)_loop3();var rowInput=document.getElementById("rowInput"),centerRowInput=document.getElementById("centerCellRowInput"),centerRowValue=centerRowInput&&"string"==typeof centerRowInput.value?centerRowInput.value:"";if(rowInput&&centerRowInput&&""===centerRowValue.trim()){var rows=parseInt(rowInput.value,10);!Number.isNaN(rows)&&rows>0&&(centerRowInput.value=String(Math.ceil(rows/2)))}var columnInput=document.getElementById("columnInput"),centerColumnInput=document.getElementById("centerCellColumnInput"),centerColumnValue=centerColumnInput&&"string"==typeof centerColumnInput.value?centerColumnInput.value:"";if(columnInput&&centerColumnInput&&""===centerColumnValue.trim()){var cols=parseInt(columnInput.value,10);!Number.isNaN(cols)&&cols>0&&(centerColumnInput.value=String(Math.ceil(cols/2)))}"function"==typeof globalThis.applyUserInteractionState&&globalThis.applyUserInteractionState();var experimentalRadio=document.getElementById("experimentalDesignSelector");!function(design){"function"==typeof globalThis.setScenarioVisibility&&globalThis.setScenarioVisibility(design)}(experimentalRadio&&experimentalRadio.checked?"experimental_scenarios":"blank_neighborhood"),"function"==typeof globalThis.buildAndUpdatePreview&&globalThis.buildAndUpdatePreview()}function _extractNumericProbability(scenario){if("number"==typeof scenario.probability)return scenario.probability;if("number"==typeof scenario.weight)return scenario.weight;var prob=parseFloat(scenario.probability);if(!isNaN(prob))return prob;var weight=parseFloat(scenario.weight);return isNaN(weight)?NaN:weight}function deserializeInputs(json){var data=JSON.parse(json);return Array.isArray(data)||deserializeCurrentInputs(data),data}function downloadInputs(){var dataStr=serializeInputs(),blob=new Blob([dataStr],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(blob),a.download="neighborhood_question_inputs.json",a.click(),"function"==typeof URL.revokeObjectURL&&setTimeout(function(){return URL.revokeObjectURL(a.href)},0)}function uploadInputs(file){var reader=new FileReader;reader.onload=function(){return deserializeInputs(reader.result)},reader.readAsText(file)}function triggerFileInput(){var input=document.getElementById("file-upload");input?(input.value="",input.click()):console.warn("file-upload element not found")}function resetTuningInputs(){["gridGapRange","gridGapInput","gridPaddingRange","gridPaddingInput","labelFontSizeRange","labelFontSizeInput","cellWidthRange","cellWidthInput","cellHeightRange","cellHeightInput"].forEach(function(id){var el=document.getElementById(id);el&&("checkbox"===el.type||"radio"===el.type?el.checked=el.defaultChecked:el.value=el.defaultValue)}),"function"==typeof globalThis.buildAndUpdatePreview&&globalThis.buildAndUpdatePreview()}function resetInputs(){document.querySelectorAll(".input-section input, .input-section textarea, .input-section select").forEach(function(el){"radio"===el.type||"checkbox"===el.type?el.checked=el.defaultChecked:el.value=el.defaultValue});var skipSelect=document.getElementById("skipBehaviorSelect");if(skipSelect){var defOpt="function"==typeof skipSelect.querySelector&&skipSelect.querySelector("option[selected]")||skipSelect.options&&skipSelect.options[0];defOpt&&(skipSelect.value=defOpt.value)}var svgField=document.getElementById("cellImageSVG");svgField&&(svgField.value=_DEFAULT_CELL_SVG),document.getElementById("scenarios-container").innerHTML="",_resetScenarioCount(),"function"==typeof globalThis.addScenario&&globalThis.addScenario(),"function"==typeof globalThis.applyUserInteractionState&&globalThis.applyUserInteractionState(),"function"==typeof globalThis.buildAndUpdatePreview&&globalThis.buildAndUpdatePreview()}function confirmResetInputs(){var title=document.getElementById("confirmModalTitle"),desc=document.getElementById("confirmModalDesc"),okBtn=document.getElementById("confirmOk"),defaultTitle=title?title.textContent:"",defaultDesc=desc?desc.textContent:"",defaultOk=okBtn?okBtn.textContent:"";function restore(){title&&(title.textContent=defaultTitle),desc&&(desc.textContent=defaultDesc),okBtn&&(okBtn.textContent=defaultOk)}title&&(title.textContent="Reset all inputs"),desc&&(desc.textContent="Are you sure you want to clear all inputs? This cannot be undone."),okBtn&&(okBtn.textContent="Confirm"),showConfirmModal(function(){resetInputs(),restore()},function(){restore()})}function persistPortfolio(){if(storage)try{storage.setItem("griddyPortfolio",JSON.stringify(state.portfolio)),storage.setItem(CURRENT_KEY,String(state.currentTask))}catch(err){}}function loadPortfolioFromStorage(){if(!storage)return!1;try{var str=storage.getItem("griddyPortfolio");if(!str)return!1;var tasks=JSON.parse(str);if(!Array.isArray(tasks)||0===tasks.length)throw new Error("Invalid portfolio");state.portfolio=tasks.map(function(t){return{name:t.name,data:t.data,linkedTo:"number"==typeof t.linkedTo?t.linkedTo:null}});var idx=parseInt(storage.getItem(CURRENT_KEY),10);return state.currentTask=isNaN(idx)?0:Math.min(Math.max(idx,0),tasks.length-1),!0}catch(err){try{storage.removeItem("griddyPortfolio"),storage.removeItem(CURRENT_KEY)}catch(_unused){}return!1}}function updateTaskSelect(){var sel=document.getElementById("taskSelect");sel&&(sel.innerHTML="",state.portfolio.forEach(function(t,i){var opt=document.createElement("option");opt.value=i,opt.textContent=("number"==typeof t.linkedTo?" ":"")+t.name;var isActive=i===state.currentTask;opt.selected=isActive,isActive?opt.setAttribute("selected","selected"):opt.removeAttribute("selected"),opt.setAttribute("aria-selected",isActive?"true":"false"),sel.appendChild(opt)}),function(){var sel=document.getElementById("linkSelect"),container=document.getElementById("linkedContainer");if(sel&&container){if(state.portfolio.length<=1)return container.style.display="none",sel.innerHTML="",void(sel.value="");container.style.display="inline",sel.innerHTML="";var noneOpt=document.createElement("option");noneOpt.value="",noneOpt.textContent="None",sel.appendChild(noneOpt),state.portfolio.forEach(function(t,i){if(i!==state.currentTask){var opt=document.createElement("option");opt.value=i,opt.textContent=t.name,sel.appendChild(opt)}});var linkedTo=state.portfolio[state.currentTask].linkedTo;sel.value="number"==typeof linkedTo?String(linkedTo):""}}())}function saveCurrent(){if(state.portfolio[state.currentTask]){state.portfolio[state.currentTask].data=JSON.parse(serializeInputs());var linkSel=document.getElementById("linkSelect");if(linkSel){var val=linkSel.value;state.portfolio[state.currentTask].linkedTo=""===val?null:parseInt(val,10)}persistPortfolio()}}function loadTask(idx){idx<0||idx>=state.portfolio.length||(saveCurrent(),state.currentTask=idx,deserializeCurrentInputs(state.portfolio[state.currentTask].data),updateTaskSelect(),persistPortfolio())}function addTask(){saveCurrent(),resetInputs();var name=prompt("Task name?","Task ".concat(state.portfolio.length+1));(name=name&&name.trim())||(name="Task ".concat(state.portfolio.length+1));var data=JSON.parse(serializeInputs());state.portfolio.push({name:name,data:data,linkedTo:null}),state.currentTask=state.portfolio.length-1,updateTaskSelect(),persistPortfolio()}function renameTask(){var name=prompt("Rename task",state.portfolio[state.currentTask].name);null!==name&&(name=name.trim())&&(state.portfolio[state.currentTask].name=name,updateTaskSelect(),persistPortfolio())}function deleteTask(){state.portfolio.length<=1||confirm("Delete current task?")&&(state.portfolio.splice(state.currentTask,1),state.portfolio.forEach(function(t){"number"==typeof t.linkedTo&&(t.linkedTo===state.currentTask?t.linkedTo=null:t.linkedTo>state.currentTask&&(t.linkedTo-=1))}),state.currentTask>=state.portfolio.length&&(state.currentTask=state.portfolio.length-1),deserializeCurrentInputs(state.portfolio[state.currentTask].data),updateTaskSelect(),persistPortfolio())}function downloadPortfolio(){saveCurrent();var str=serializeInputs(state.portfolio),blob=new Blob([str],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(blob),a.download="portfolio.json",a.click(),"function"==typeof URL.revokeObjectURL&&setTimeout(function(){return URL.revokeObjectURL(a.href)},0)}function uploadPortfolio(file){var reader=new FileReader;reader.onload=function(){var tasks;try{tasks=deserializeInputs(reader.result)}catch(err){return void alert("Invalid portfolio file")}Array.isArray(tasks)?state.portfolio=tasks.map(function(t){return{name:t.name,data:t.data,linkedTo:"number"==typeof t.linkedTo?t.linkedTo:null}}):state.portfolio=[{name:"Imported Task",data:tasks,linkedTo:null}],state.currentTask=0,deserializeCurrentInputs(state.portfolio[state.currentTask].data),updateTaskSelect(),persistPortfolio()},reader.readAsText(file)}function triggerPortfolioInput(){var input=document.getElementById("file-upload");input?(input.value="",input.click()):console.warn("file-upload element not found")}function initPortfolio(){loadPortfolioFromStorage()||(state.portfolio=[{name:"Task 1",data:JSON.parse(serializeInputs()),linkedTo:null}],state.currentTask=0),updateTaskSelect(),persistPortfolio()}function defaultSkipModal(){return new Promise(function(resolve){var title=document.getElementById("confirmModalTitle"),desc=document.getElementById("confirmModalDesc"),okBtn=document.getElementById("confirmOk"),defaults={title:title?title.textContent:"",desc:desc?desc.textContent:"",ok:okBtn?okBtn.textContent:""};function restore(){title&&(title.textContent=defaults.title),desc&&(desc.textContent=defaults.desc),okBtn&&(okBtn.textContent=defaults.ok)}title&&(title.textContent="Incomplete grid"),desc&&(desc.textContent="Some houses are unfilled. Click Cancel to finish filling or Continue to skip."),okBtn&&(okBtn.textContent="Continue"),showConfirmModal(function(){restore(),resolve("skip")},function(){restore(),resolve("stay")})})}function indentMultiline(str,spaces){var padding=" ".repeat(spaces);return str.split("\n").map(function(line){return line.length?padding+line:line}).join("\n")}function collectHelperSources(body){if("string"!=typeof body||!body.includes("_"))return[];var matches=body.match(/_[A-Za-z0-9]+/g)||[],needed=new Set;matches.forEach(function(name){if(cachedHelperSources[name]){needed.add(name);var deps=helperDependencyMap[name];Array.isArray(deps)&&deps.forEach(function(dep){return needed.add(dep)})}});for(var expanded=!0;expanded;)expanded=!1,needed.forEach(function(name){var deps=helperDependencyMap[name];Array.isArray(deps)&&deps.forEach(function(dep){!needed.has(dep)&&cachedHelperSources[dep]&&(needed.add(dep),expanded=!0)})});return knownHelperOrder.filter(function(name){return needed.has(name)}).map(function(name){return cachedHelperSources[name]}).filter(Boolean)}function serializeNeighborhoodQuestion(neighborhoodQuestion){if("function"!=typeof neighborhoodQuestion)throw new Error("NeighborhoodQuestion is not a function");var segments=[neighborhoodQuestion.toString()],prototype=neighborhoodQuestion.prototype;prototype&&"object"===_typeof(prototype)&&Object.getOwnPropertyNames(prototype).forEach(function(name){if("constructor"!==name){var descriptor=Object.getOwnPropertyDescriptor(prototype,name);descriptor&&segments.push("Object.defineProperty(NeighborhoodQuestion.prototype, ".concat(JSON.stringify(name),", ").concat(function(descriptor){if(!descriptor)return"{}";var parts=[];if("value"in descriptor){var value=descriptor.value;if("function"==typeof value){var src=value.toString();if(src.startsWith("async ")){var rest=src.slice(6);rest.startsWith("function")||(src=rest.startsWith("*")?"async function*".concat(rest.slice(1)):"async function ".concat(rest))}else src.startsWith("function")||(src=src.startsWith("*")?"function*".concat(src.slice(1)):"function ".concat(src));parts.push("value: ".concat(src))}else parts.push("value: ".concat(JSON.stringify(value)));parts.push("writable: ".concat(descriptor.writable?"true":"false"))}return"function"==typeof descriptor.get&&parts.push("get: ".concat(descriptor.get.toString())),"function"==typeof descriptor.set&&parts.push("set: ".concat(descriptor.set.toString())),parts.push("enumerable: ".concat(descriptor.enumerable?"true":"false")),parts.push("configurable: ".concat(descriptor.configurable?"true":"false")),"{ ".concat(parts.join(", ")," }")}(descriptor),");"))}});return segments.join("\n")}function getSharedStyles(){var doc=globalThis.document;if(!doc||!doc.head||"function"!=typeof doc.head.querySelector)return"";var styleTag=doc.head.querySelector("style");if(!styleTag)return"";var raw="string"==typeof styleTag.innerHTML?styleTag.innerHTML:"string"==typeof styleTag.textContent?styleTag.textContent:"";return String(raw)}function adaptNeighborhoodQuestionSource(source){if("string"!=typeof source||!source.includes("NeighborhoodQuestion"))return source;var classIndex=source.indexOf("class NeighborhoodQuestion");if(-1===classIndex)return source;var braceIndex=source.indexOf("{",classIndex);if(-1===braceIndex)return source;var classEnd=function(source,openBraceIndex){for(var depth=0,inSingle=!1,inDouble=!1,inTemplate=!1,inBlockComment=!1,inLineComment=!1,i=openBraceIndex;i<source.length;i+=1){var char=source[i],prev=source[i-1],next=source[i+1];if(inLineComment)"\n"===char&&(inLineComment=!1);else if(inBlockComment)"*"===prev&&"/"===char&&(inBlockComment=!1);else if(inSingle)"\\"===char?i+=1:"'"===char&&"\\"!==prev&&(inSingle=!1);else if(inDouble)"\\"===char?i+=1:'"'===char&&"\\"!==prev&&(inDouble=!1);else{if(inTemplate){if("\\"===char){i+=1;continue}if("`"===char&&"\\"!==prev){inTemplate=!1;continue}}else{if("/"===char&&"/"===next){inLineComment=!0,i+=1;continue}if("/"===char&&"*"===next){inBlockComment=!0,i+=1;continue}if("'"===char){inSingle=!0;continue}if('"'===char){inDouble=!0;continue}if("`"===char){inTemplate=!0;continue}}if("{"===char)depth+=1;else if("}"===char&&0==(depth-=1))return i}}return-1}(source,braceIndex);if(-1===classEnd)return source;var beforeClass=source.slice(0,classIndex),classDeclaration=source.slice(classIndex,classEnd+1),afterClass=source.slice(classEnd+1),bodyStart=braceIndex-classIndex+1,classHeader=classDeclaration.slice(0,bodyStart),classBody=classDeclaration.slice(bodyStart,-1),adapterBlock=["var __missingHelperWarnings = {};","function __warnMissingHelper(namespace, method) {","  var key = namespace + '.' + method;","  if (__missingHelperWarnings[key]) return;","  __missingHelperWarnings[key] = true;","  var message = 'GRIDDY: Missing helper ' + key + '; using a safe fallback.';","  if (typeof console !== 'undefined' && typeof console.warn === 'function') {","    console.warn(message);","  }","  try {","    var doc = typeof document !== 'undefined' ? document : null;","    if (!doc) return;","    var mount = null;","    if (typeof GRIDDY_CONFIG === 'object' && GRIDDY_CONFIG) {","      if (!mount && GRIDDY_CONFIG.mountClassName) {","        mount = doc.querySelector('.' + GRIDDY_CONFIG.mountClassName);","      }","      if (!mount && GRIDDY_CONFIG.questionSelector) {","        mount = doc.querySelector(GRIDDY_CONFIG.questionSelector);","      }","    }","    if (!mount) {","      mount = doc.querySelector('.griddy-mount') || doc.getElementById('surveyQuestion');","    }","    if (!mount) return;","    var warning = mount.querySelector('.griddy-helper-warning');","    if (!warning) {","      warning = doc.createElement('div');","      warning.className = 'griddy-helper-warning';","      warning.style.margin = '1rem 0';","      warning.style.padding = '0.75rem';","      warning.style.backgroundColor = '#fff3cd';","      warning.style.border = '1px solid #ffeeba';","      warning.style.color = '#856404';","      warning.style.fontSize = '0.9rem';","      warning.style.fontFamily = 'inherit';","      warning.textContent = 'Some interactive helpers are unavailable. Displaying a simplified grid.';","      mount.prepend(warning);","    }","    var list = warning.querySelector('ul');","    if (!list) {","      list = doc.createElement('ul');","      list.style.margin = '0.5rem 0 0';","      list.style.paddingLeft = '1.2rem';","      warning.appendChild(list);","    }","    var item = doc.createElement('li');","    item.textContent = key;","    list.appendChild(item);","  } catch (err) {}","}","function __fallbackReturn(namespace, method) {","  if (namespace === 'tokenUtils' && method === 'getCurrentCounts') return {};","  if (namespace === 'tokenUtils' && method === 'adjustTokenCount') return 0;","  return null;","}","function __createFallback(namespace, method) {","  return function () {","    __warnMissingHelper(namespace, method);","    return __fallbackReturn(namespace, method);","  };","}","function __ensureNamespace(namespace, methods) {","  var target = globalThis[namespace];","  if (!target || typeof target !== 'object') {","    target = {};","    globalThis[namespace] = target;","  }","  if (Array.isArray(methods)) {","    for (var i = 0; i < methods.length; i += 1) {","      var name = methods[i];","      if (typeof target[name] !== 'function') {","        target[name] = __createFallback(namespace, name);","      }","    }","  }","  return target;","}","function __wrapNamespace(namespace, methods) {","  var wrapper = {};","  methods = Array.isArray(methods) ? methods.slice() : [];","  __ensureNamespace(namespace, methods);","  for (var i = 0; i < methods.length; i += 1) {","    (function (method) {","      wrapper[method] = function () {","        var target = globalThis[namespace];","        var fn = target && typeof target[method] === 'function' ? target[method] : null;","        if (!fn) {","          target = __ensureNamespace(namespace, methods);","          fn = target && typeof target[method] === 'function' ? target[method] : null;","        }","        if (!fn) {","          fn = __createFallback(namespace, method);","          target = globalThis[namespace];","          if (target && typeof target === 'object') {","            target[method] = fn;","          }","        }","        if (!fn) return __fallbackReturn(namespace, method);","        try {","          return fn.apply(target, arguments);","        } catch (error) {","          __warnMissingHelper(namespace, method);","          return __fallbackReturn(namespace, method);","        }","      };","    })(methods[i]);","  }","  return wrapper;","}",Object.entries(namespaceFallbacks).map(function(_ref7){var _ref8=_slicedToArray(_ref7,2),namespace=_ref8[0],methodList=_ref8[1].map(function(method){return JSON.stringify(method)}).join(", ");return"var __".concat(namespace," = __wrapNamespace(").concat(JSON.stringify(namespace),", [").concat(methodList,"]);")}).join("\n"),"var __updateWarningText =","  typeof globalThis.updateWarningText === 'function'","    ? globalThis.updateWarningText","    : function () {};"].join("\n"),adaptedBody=classBody.replace(/gridUtils\./g,"__gridUtils.").replace(/tokenUtils\./g,"__tokenUtils.").replace(/randomizer\./g,"__randomizer.").replace(/scenarioUtils\./g,"__scenarioUtils.").replace(/updateWarningTextLocal\(/g,"__updateWarningText(").replace(/return __randomizer\.selectWeightedScenario\(([^)]*)\);/g,"return ((__randomizer.selectWeightedScenario) || function(){return null;})($1);"),adaptedClass="".concat(classHeader).concat(adaptedBody).concat("}"),adaptedAfterClass=afterClass.replace(/Object\.defineProperty\(NeighborhoodQuestion\.prototype,[\s\S]*?\);/g,function(segment){return segment.replace(/gridUtils\./g,"__gridUtils.").replace(/tokenUtils\./g,"__tokenUtils.").replace(/randomizer\./g,"__randomizer.").replace(/scenarioUtils\./g,"__scenarioUtils.").replace(/updateWarningTextLocal\(/g,"__updateWarningText(")});return"".concat(beforeClass).concat(adapterBlock,"\n").concat(adaptedClass).concat(adaptedAfterClass)}function buildQualtricsJSString(_x4){return _buildQualtricsJSString.apply(this,arguments)}function _buildQualtricsJSString(){return(_buildQualtricsJSString=_asyncToGenerator(_regenerator().m(function _callee3(formInputs){var errors,customImageHTML,backgroundURL,interactionEnabled,qText,centerLabel,safeImageHTML,dropdownOptions,experimentalTraitsField,experimentalRadioChecked,hasTraitEntries,traitOptions,attrs,uniqueCode,missingCode,errorCode,followUpEnabled,followUpQIDs,confirmLabel,traitList,scenarios,rawQuotas,quotas,shuffleSeedRaw,optionShuffleSeed,shuffleOrderRaw,persistedOptionOrder,sharedStyles,defaultCellSVG,neighborhoodQuestionSource,adaptedNeighborhoodQuestionSource,helperSources,helperBlock,parsePriorSelectionsSource,helperFunctions,helperBlockIndented,helperBlocks,qualtricsScript;return _regenerator().w(function(_context3){for(;;)switch(_context3.n){case 0:if(uniqueCode=function(base){for(var code=base,i=1;attrs.includes(code);)code="".concat(base).concat(i++);return code},!(errors=validateInputs(formInputs)).length){_context3.n=1;break}throw new Error(errors.join("\n"));case 1:if(carryForwardLayoutsMatch(globalThis.appState.portfolio,globalThis.appState.currentTask)){_context3.n=2;break}throw new Error("Linked task layout does not match the source. Adjust the grid or unlink this task.");case 2:return _context3.n=3,getCellImageHTML(formInputs);case 3:if(customImageHTML=_context3.v,backgroundURL=getBackgroundImageURL(formInputs),interactionEnabled=!formInputs.userInteractionCheckbox||formInputs.userInteractionCheckbox.checked,qText=sanitizeHTML(formInputs.questionTextInput.value),centerLabel=sanitizeHTML(formInputs.centerLabelInput.value),safeImageHTML=customImageHTML?sanitizeHTML(customImageHTML):null,dropdownOptions=interactionEnabled?makeDropdownOptionList(formInputs.dropdownOptionsInput):[],experimentalTraitsField=formInputs.experimentalTraitsInput,experimentalRadioChecked=!(!formInputs.experimentalRadioInput||!formInputs.experimentalRadioInput.checked),hasTraitEntries=experimentalRadioChecked&&experimentalTraitsField&&"string"==typeof experimentalTraitsField.value&&experimentalTraitsField.value.split(",").map(function(part){return part.trim()}).filter(Boolean).length>0,traitOptions=hasTraitEntries?makeDropdownOptionList(experimentalTraitsField):[],attrs=_toConsumableArray(dropdownOptions),traitOptions.length&&attrs.push.apply(attrs,_toConsumableArray(traitOptions)),attrs.push(centerLabel),missingCode=uniqueCode("_missing_"),errorCode=uniqueCode("_error_"),followUpEnabled=formInputs.followUpCheckbox&&formInputs.followUpCheckbox.checked,followUpQIDs=formInputs.followUpQIDsInput?formInputs.followUpQIDsInput.value.split(",").map(function(s){return s.trim()}).filter(Boolean):[],confirmLabel=formInputs.confirmButtonText?formInputs.confirmButtonText.value:"Confirm grid",traitOptions.length>0,scenarios=parseExperimentalScenarios((traitList=traitOptions).length),rawQuotas=null,interactionEnabled&&formInputs.enableQuotasCheckbox&&formInputs.enableQuotasCheckbox.checked&&(rawQuotas="function"==typeof quotaReader?quotaReader({container:formInputs.quotaInputContainer,hidden:formInputs.optionQuotaInput,options:dropdownOptions}):parseQuotaList(formInputs.optionQuotaInput)),quotas=Array.isArray(rawQuotas)&&rawQuotas.length?rawQuotas:null,shuffleSeedRaw=formInputs.optionShuffleSeed?formInputs.optionShuffleSeed.value.trim():"",optionShuffleSeed=""===shuffleSeedRaw?null:shuffleSeedRaw,shuffleOrderRaw=formInputs.optionShuffleOrder?formInputs.optionShuffleOrder.value.trim():"",persistedOptionOrder=shuffleOrderRaw?shuffleOrderRaw.split(",").map(function(s){return s.trim()}).filter(function(s){return""!==s}):null,sharedStyles=getSharedStyles(),defaultCellSVG="string"==typeof globalThis.DEFAULT_CELL_SVG&&globalThis.DEFAULT_CELL_SVG||globalThis.NeighborhoodQuestion&&globalThis.NeighborhoodQuestion.DEFAULT_CELL_SVG){_context3.n=4;break}throw new Error("DEFAULT_CELL_SVG is not available. Rebuild the editor bundle and try again.");case 4:return neighborhoodQuestionSource=serializeNeighborhoodQuestion(NeighborhoodQuestion),adaptedNeighborhoodQuestionSource=adaptNeighborhoodQuestionSource(neighborhoodQuestionSource),helperSources=collectHelperSources(neighborhoodQuestionSource),helperBlock=helperSources.length?helperSources.map(function(code){return indentMultiline(code,2)}).join("\n"):"",parsePriorSelectionsSource=parsePriorSelections.toString(),helperFunctions=[["(function initSanitizeHTML() {",'  if (typeof globalThis.sanitizeHTML === "function") return;',"  globalThis.sanitizeHTML = ".concat(sanitizeHTMLForExport.toString(),";"),"})();"].join("\n")],interactionEnabled&&followUpEnabled&&helperFunctions.push("globalThis.setupFollowUpQIDs = ".concat(setupFnSource,";"),"globalThis.getNextBtn = ".concat(nextFnSource,";")),helperFunctions.push(["(function initTokenUtils() {","  if (","    typeof globalThis.addTokenBank === 'function' &&","    typeof globalThis.createDraggableToken === 'function' &&","    typeof globalThis.adjustTokenCount === 'function' &&","    typeof globalThis.getCurrentCounts === 'function' &&","    typeof globalThis.showQuotaWarnings === 'function' &&","    typeof globalThis.updateTokenCountReadout === 'function'","  ) {","    return;","  }","  const updateWarningText =","    typeof globalThis.updateWarningText === 'function'","      ? globalThis.updateWarningText","      : function () {};","  const KEYBOARD_SELECTED_CLASS = 'token-keyboard-selected';","  const OVER_QUOTA_CLASS = 'over-quota';","  const NEEDS_ALLOCATION_CLASS = 'needs-allocation';","  function formatTokenText(value, unlimited, remaining) {","    return unlimited ? String(value == null ? '' : value) : value + ' (' + remaining + ')';","  }","  function updateTokenAvailability(token, unlimited, remaining) {","    if (!token) return;","    if (unlimited) {","      token.draggable = true;","      token.classList.remove('disabled-option');","      token.tabIndex = 0;","      token.setAttribute('aria-disabled', 'false');","      token.setAttribute('aria-label', token.dataset.value + ' token (unlimited uses)');","      return;","    }","    var disabled = remaining <= 0;","    token.draggable = !disabled;","    if (disabled) token.classList.add('disabled-option');","    else token.classList.remove('disabled-option');","    token.tabIndex = disabled ? -1 : 0;","    token.setAttribute('aria-disabled', disabled ? 'true' : 'false');","    token.setAttribute('aria-label', token.dataset.value + ' token (' + remaining + ' remaining)');","  }","  function clearQuotaClasses(q) {","    if (!q) return;","    if (q.tokenBank) {","      q.tokenBank.querySelectorAll('.token').forEach(function (token) {","        token.classList.remove(OVER_QUOTA_CLASS);","        token.classList.remove(NEEDS_ALLOCATION_CLASS);","      });","    }","    if (q.outerDiv) {","      q.outerDiv.querySelectorAll('.token-drop').forEach(function (drop) {","        drop.classList.remove(OVER_QUOTA_CLASS);","      });","    }","  }","  function markBankTokens(q, value, className) {","    if (!q || !q.tokenBank) return;","    q.tokenBank.querySelectorAll('.token').forEach(function (token) {","      if (token.dataset.value === value) token.classList.add(className);","    });","  }","  function markDropTargets(q, value, className) {","    if (!q || !q.outerDiv) return;","    q.outerDiv.querySelectorAll('.token-drop').forEach(function (drop) {","      var placed = drop.querySelector('.token');","      if (placed && placed.dataset && placed.dataset.value === value) {","        drop.classList.add(className);","      }","    });","  }","  function updateTokenCountReadout(q, countsOverride) {","    if (!q || !q.tokenCountReadout) return;","    if (!q.useTokens) {","      q.tokenCountReadout.textContent = '';","      return;","    }","    var counts = countsOverride || getCurrentCounts(q);","    var options = Array.isArray(q.optionsData) ? q.optionsData : [];","    if (!options.length) {","      q.tokenCountReadout.textContent = '';","      return;","    }","    var parts = options.map(function (opt, idx) {","      var used = counts[opt] || 0;","      var quotas = Array.isArray(q.quotas) ? q.quotas : [];","      var rawQuota = quotas[idx];","      var quota = typeof rawQuota === 'number' && isFinite(rawQuota) && rawQuota >= 0 ? Math.floor(rawQuota) : null;","      return quota === null ? opt + ': ' + used : opt + ': ' + used + '/' + quota;","    });","    q.tokenCountReadout.textContent = parts.join('  ');","  }","  function addTokenBank(q, options, columnCount, rowCount, quotas, includeCenterCell, lockedCells) {","    if (!q || q.useTokens === false || !q.outerDiv) return;","    var optionList = Array.isArray(options) ? options : [];","    var unlimited = !Array.isArray(quotas) || !quotas.length;","    var counts = {};","    if (!unlimited) {","      optionList.forEach(function (opt, i) {","        var raw = Array.isArray(quotas) ? quotas[i] : 0;","        var quota = typeof raw === 'number' && isFinite(raw) && raw > 0 ? Math.floor(raw) : 0;","        counts[opt] = Math.max(0, quota);","      });","    }","    var wrapper = document.createElement('div');","    wrapper.className = 'token-bank-wrapper';","    var bank = document.createElement('div');","    bank.className = 'token-bank';","    bank.setAttribute('role', 'list');","    function clearSelection() {","      q.keyboardTokenSelection = null;","      bank.querySelectorAll('.token').forEach(function (token) {","        token.classList.remove(KEYBOARD_SELECTED_CLASS);","        token.setAttribute('aria-pressed', 'false');","      });","    }","    function selectToken(token) {","      if (!token || token.classList.contains('disabled-option')) {","        clearSelection();","        return;","      }","      if (","        q.keyboardTokenSelection &&","        q.keyboardTokenSelection.value === token.dataset.value &&","        (q.keyboardTokenSelection.unlimited ? token.dataset.unlimited === 'true' : token.dataset.unlimited !== 'true')","      ) {","        clearSelection();","        return;","      }","      clearSelection();","      token.classList.add(KEYBOARD_SELECTED_CLASS);","      token.setAttribute('aria-pressed', 'true');","      q.keyboardTokenSelection = {","        value: token.dataset.value,","        unlimited: token.dataset.unlimited === 'true',","      };","    }","    optionList.forEach(function (opt) {","      var token = document.createElement('div');","      token.className = 'token';","      token.id = 'token-' + Math.random().toString(36).slice(2);","      token.dataset.value = opt;","      token.setAttribute('role', 'button');","      token.setAttribute('aria-pressed', 'false');","      if (unlimited) {","        token.dataset.unlimited = 'true';","        token.textContent = formatTokenText(opt, true, 0);","        updateTokenAvailability(token, true, 0);","      } else {","        var count = counts[opt] || 0;","        token.dataset.remaining = String(count);","        token.textContent = formatTokenText(opt, false, count);","        updateTokenAvailability(token, false, count);","      }","      token.addEventListener('dragstart', function (event) {","        if (!event || !event.dataTransfer) return;","        event.dataTransfer.setData('text/plain', token.id);","      });","      token.addEventListener('keydown', function (event) {","        if (event.key === ' ' || event.key === 'Spacebar' || event.key === 'Enter') {","          event.preventDefault();","          if (token.classList.contains('disabled-option')) clearSelection();","          else selectToken(token);","        } else if (event.key === 'Escape') {","          clearSelection();","        }","      });","      token.addEventListener('click', function () {","        if (token.classList.contains('disabled-option')) {","          clearSelection();","          return;","        }","        selectToken(token);","      });","      bank.appendChild(token);","    });","    var readout = document.createElement('div');","    readout.className = 'token-count-readout';","    readout.setAttribute('role', 'status');","    readout.setAttribute('aria-live', 'polite');","    wrapper.appendChild(bank);","    wrapper.appendChild(readout);","    q.outerDiv.appendChild(wrapper);","    q.tokenBank = bank;","    q.tokenBankWrapper = wrapper;","    q.tokenCountReadout = readout;","    q.clearKeyboardSelection = clearSelection;","    clearSelection();","    updateTokenCountReadout(q);","  }","  function adjustTokenCount(q, value, delta) {","    if (!q || q.useTokens === false || !q.tokenBank) return null;","    var token = null;","    q.tokenBank.querySelectorAll('.token').forEach(function (candidate) {","      if (candidate.dataset.value === value) token = candidate;","    });","    if (!token || token.dataset.unlimited === 'true') return null;","    var current = parseInt(token.dataset.remaining || '0', 10) || 0;","    var next = current + delta;","    if (delta < 0 && next < 0) return -1;","    var remaining = Math.max(0, next);","    token.dataset.remaining = String(remaining);","    token.textContent = formatTokenText(value, false, remaining);","    updateTokenAvailability(token, false, remaining);","    if (remaining === 0 && q.keyboardTokenSelection && q.keyboardTokenSelection.value === value && !q.keyboardTokenSelection.unlimited && typeof q.clearKeyboardSelection === 'function') {","      q.clearKeyboardSelection();","    }","    return remaining;","  }","  function createDraggableToken(value, unlimitedClone) {","    var token = document.createElement('div');","    token.className = 'token';","    token.textContent = formatTokenText(value, !!unlimitedClone, 0);","    token.dataset.value = value;","    if (unlimitedClone) token.dataset.unlimitedClone = 'true';","    token.id = 'token-' + Math.random().toString(36).slice(2);","    token.draggable = true;","    token.tabIndex = -1;","    token.setAttribute('aria-hidden', 'true');","    token.addEventListener('dragstart', function (event) {","      if (!event || !event.dataTransfer) return;","      event.dataTransfer.setData('text/plain', token.id);","    });","    return token;","  }","  function getCurrentCounts(q) {","    if (!q) return {};","    var counts = {};","    if (q.useTokens) {","      q.outerDiv.querySelectorAll('.token-drop .token').forEach(function (token) {","        var v = token && token.dataset ? token.dataset.value : null;","        if (!v) return;","        counts[v] = (counts[v] || 0) + 1;","      });","    } else {","      q.outerDiv.querySelectorAll('.cell-container select[data-cell-index]').forEach(function (selectEl) {","        if (!selectEl.value) return;","        counts[selectEl.value] = (counts[selectEl.value] || 0) + 1;","      });","    }","    return counts;","  }","  function showQuotaWarnings(q) {","    if (!q || q.useTokens === false) {","      if (q && q.tokenCountReadout) q.tokenCountReadout.textContent = '';","      var warningDiv = document.getElementById('warnings');","      if (warningDiv) {","        warningDiv.dataset.quotaWarnings = '';","        warningDiv.dataset.overspec = 'false';","        updateWarningText(warningDiv);","      }","      return;","    }","    var warningDiv = document.getElementById('warnings');","    var counts = getCurrentCounts(q);","    updateTokenCountReadout(q, counts);","    clearQuotaClasses(q);","    var options = Array.isArray(q.optionsData) ? q.optionsData : [];","    var quotas = Array.isArray(q.quotas) ? q.quotas : [];","    if (!warningDiv || !quotas.length || options.length !== quotas.length) {","      if (warningDiv) {","        warningDiv.dataset.quotaWarnings = '';","        warningDiv.dataset.overspec = 'false';","        updateWarningText(warningDiv);","      }","      return;","    }","    var msgs = [];","    var total = 0;","    options.forEach(function (opt, idx) {","      var rawQuota = quotas[idx];","      var quota = typeof rawQuota === 'number' && isFinite(rawQuota) && rawQuota > 0 ? Math.floor(rawQuota) : 0;","      total += quota;","      var used = counts[opt] || 0;","      if (quota > 0 && used < quota) markBankTokens(q, opt, NEEDS_ALLOCATION_CLASS);","      if (used > quota) {","        msgs.push(opt + ' (' + used + '/' + quota + ')');","        markBankTokens(q, opt, OVER_QUOTA_CLASS);","        markDropTargets(q, opt, OVER_QUOTA_CLASS);","      }","    });","    var cellCount = q.columnCount * q.rowCount - (q.includeCenterCell ? 1 : 0) - (Array.isArray(q.lockedCells) ? q.lockedCells.length : 0);","    var overspec = total > cellCount;","    var warnings = [];","    if (overspec) warnings.push('Note that there are more tokens than grid cells');","    if (msgs.length) warnings.push('Quota exceeded: ' + msgs.join(', '));","    warningDiv.dataset.quotaWarnings = warnings.join(' | ');","    warningDiv.dataset.overspec = overspec ? 'true' : 'false';","    updateWarningText(warningDiv);","  }","  if (typeof globalThis.addTokenBank !== 'function') globalThis.addTokenBank = addTokenBank;","  if (typeof globalThis.adjustTokenCount !== 'function') globalThis.adjustTokenCount = adjustTokenCount;","  if (typeof globalThis.createDraggableToken !== 'function') globalThis.createDraggableToken = createDraggableToken;","  if (typeof globalThis.getCurrentCounts !== 'function') globalThis.getCurrentCounts = getCurrentCounts;","  if (typeof globalThis.showQuotaWarnings !== 'function') globalThis.showQuotaWarnings = showQuotaWarnings;","  if (typeof globalThis.updateTokenCountReadout !== 'function') globalThis.updateTokenCountReadout = updateTokenCountReadout;","})();"].join("\n")),helperFunctions.push(["(function initGridUtils() {","  if (typeof globalThis.startGridContainer === 'function' && typeof globalThis.buildNeighborCell === 'function') return;","  const sanitize = typeof globalThis.sanitizeHTML === 'function'","    ? globalThis.sanitizeHTML","    : function (value) {",'        return value == null ? "" : String(value);',"      };","  const updateWarningText =","    typeof globalThis.updateWarningText === 'function'","      ? globalThis.updateWarningText","      : function () {};","  const addExperimentalLabel =","    typeof globalThis.addExperimentalLabel === 'function'","      ? globalThis.addExperimentalLabel","      : function (q, cellContainer) {","          if (!q || !q.isExperimental || !cellContainer) return;","          const marker = cellContainer.querySelector('[data-cell-index]');","          if (!marker || !marker.dataset) return;","          const idx = parseInt(marker.dataset.cellIndex, 10);","          if (!Number.isInteger(idx) || !Array.isArray(q.traitArray)) return;","          const trait = q.traitArray[idx];",'          if (typeof trait !== "string" || !trait) return;',"          const container =","            cellContainer.getElementsByClassName('content-container')[0] ||","            cellContainer;","          const prev = container.querySelector('.pre-assigned-label');","          if (prev) prev.remove();","          const label = document.createElement('div');","          label.className = 'pre-assigned-label';","          label.textContent = trait;","          container.prepend(label);","        };","  const createToken = function (value, unlimitedClone) {","    return typeof globalThis.createDraggableToken === 'function'","      ? globalThis.createDraggableToken(value, unlimitedClone)","      : null;","  };","  const adjustToken =","    typeof globalThis.adjustTokenCount === 'function'","      ? globalThis.adjustTokenCount","      : function () { return null; };","  function spawnTokenValue(q, value, unlimited) {","    if (!q || !value) return null;","    if (unlimited) return createToken(value, true);","    var remaining = adjustToken(q, value, -1);","    if (typeof remaining !== 'number' || remaining < 0) return null;","    return createToken(value, false);","  }","  function spawnTokenFromBank(q, token) {","    if (!token || !token.dataset) return null;","    return spawnTokenValue(q, token.dataset.value, token.dataset.unlimited === 'true');","  }","  function removeTokenFromDropTarget(q, dropTarget) {","    if (!dropTarget) return false;","    var existing = dropTarget.querySelector('.token');","    if (!existing) return false;","    var value = existing.dataset ? existing.dataset.value : null;","    if (existing.dataset && existing.dataset.unlimitedClone === 'true') {","      existing.remove();","    } else {","      existing.remove();","      if (value) adjustToken(q, value, 1);","    }","    return true;","  }","  function placeTokenElement(q, dropTarget, tokenElement) {","    if (!dropTarget || !tokenElement) return false;","    var existing = dropTarget.querySelector('.token');","    if (existing && existing !== tokenElement) {","      var existingValue = existing.dataset ? existing.dataset.value : null;","      if (existing.dataset && existing.dataset.unlimitedClone === 'true') {","        existing.remove();","      } else {","        existing.remove();","        if (existingValue) adjustToken(q, existingValue, 1);","      }","    }","    dropTarget.appendChild(tokenElement);","    return true;","  }","  function setBackgroundWarning(message) {","    const warningDiv = document.getElementById('warnings');","    if (!warningDiv || !warningDiv.dataset) return;","    warningDiv.dataset.bgWarning = message || '';","    updateWarningText(warningDiv);","  }","  function startGridContainer(q, columnCount, rowCount) {","    if (!q || !q.outerDiv) return null;","    q.columnCount = columnCount;","    q.rowCount = rowCount;","    const wrapper = document.createElement('div');","    wrapper.className = 'grid-wrapper';","    if (q.backgroundImageURL) {","      const loader = new Image();","      loader.addEventListener('load', function () {","        wrapper.style.backgroundImage = 'url(' + q.backgroundImageURL + ')';","        setBackgroundWarning('');","      });","      loader.addEventListener('error', function () {","        wrapper.style.backgroundImage = '';","        setBackgroundWarning('Warning: background image failed to load.');","      });","      loader.src = q.backgroundImageURL;","    } else {","      setBackgroundWarning('');","    }","    const grid = document.createElement('div');","    grid.className = 'grid-container';","    grid.id = 'grid-id';","    const width = q.cellWidth || 100;","    const height = q.cellHeight || 120;","    grid.style.gridTemplateColumns = 'repeat(' + columnCount + ', ' + width + 'px)';","    grid.style.gridTemplateRows = 'repeat(' + rowCount + ', ' + height + 'px)';","    wrapper.appendChild(grid);","    q.outerDiv.appendChild(wrapper);","    q.gridWrapper = wrapper;","    q.gridContainer = grid;","    return grid;","  }","  function setStyles(q, gap, padding, fontSize, width, height) {","    if (q.gridContainer) {","      q.gridContainer.style.gap = gap + 'px';","      q.gridContainer.style.gridTemplateColumns = 'repeat(' + q.columnCount + ', ' + width + 'px)';","      q.gridContainer.style.gridTemplateRows = 'repeat(' + q.rowCount + ', ' + height + 'px)';","    }","    if (q.gridWrapper) q.gridWrapper.style.padding = padding + 'px';","    q.outerDiv.querySelectorAll('.cell-container').forEach(function (cell) {","      cell.style.width = width + 'px';","      cell.style.height = height + 'px';","    });","    q.outerDiv.querySelectorAll('.cell-image-wrapper').forEach(function (wrapper) {","      wrapper.style.width = width + 'px';","      wrapper.style.height = height + 'px';","    });","    q.outerDiv.querySelectorAll('.selected-label, .pre-assigned-label').forEach(function (label) {","      label.style.fontSize = fontSize + 'rem';","    });","    q.cellWidth = width;","    q.cellHeight = height;","  }","  function buildCenterCell(q, cellContainer) {","    const cell = document.createElement('div');","    cell.className = 'cell center-cell';","    cell.id = 'center-cell-id';","    const label = document.createElement('div');","    label.className = 'center-cell-label';","    label.innerHTML = sanitize(q.centerLabelText || 'Your<br>House');","    cell.appendChild(label);","    cellContainer.appendChild(cell);","  }","  function addCellImage(q, cellContainer, id) {","    const wrapper = document.createElement('div');","    wrapper.className = 'cell-image-wrapper';","    let safeHTML = sanitize(q.cellImageHTML || '');","    if (!safeHTML.trim()) {","      const fallback =","        (globalThis.NeighborhoodQuestion && globalThis.NeighborhoodQuestion.DEFAULT_CELL_SVG) ||","        (typeof globalThis.DEFAULT_CELL_SVG === 'string' ? globalThis.DEFAULT_CELL_SVG : '');","      safeHTML = sanitize(fallback);","    }","    wrapper.innerHTML = safeHTML;","    const loadId = id;","    const img = wrapper.querySelector('img');","    if (img) {","      if (!img.complete) {","        img.addEventListener('load', function () {","          if (!q || loadId !== q.imageLoadId) return;","          measureCellSize(q, loadId);","        });","      }","      img.addEventListener('error', function () {","        if (!q || loadId !== q.imageLoadId) return;","        const fallback =","          (globalThis.NeighborhoodQuestion && globalThis.NeighborhoodQuestion.DEFAULT_CELL_SVG) ||","          (typeof globalThis.DEFAULT_CELL_SVG === 'string' ? globalThis.DEFAULT_CELL_SVG : '');","        wrapper.innerHTML = sanitize(fallback);","        measureCellSize(q, loadId);","      });","    }","    cellContainer.appendChild(wrapper);","  }","  function addDropdownAndLabel(q, cellContainer, rowIndex, columnIndex) {","    const contentContainer = document.createElement('div');","    contentContainer.className = 'content-container';","    const selectContainer = document.createElement('div');","    selectContainer.className = 'select-menu';","    const selectElement = document.createElement('select');","    const idx = rowIndex * q.columnCount + columnIndex;","    selectElement.setAttribute('data-cell-index', idx);","    selectElement.setAttribute('aria-label', 'Select attribute for cell ' + (idx + 1));","    const initial = document.createElement('option');","    initial.value = '';","    initial.disabled = true;","    initial.selected = true;","    initial.textContent = 'Select';","    selectElement.appendChild(initial);","    (Array.isArray(q.optionsData) ? q.optionsData : []).forEach(function (opt) {","      const optionElement = document.createElement('option');","      optionElement.value = opt;","      optionElement.textContent = opt;","      selectElement.appendChild(optionElement);","    });","    selectContainer.appendChild(selectElement);","    contentContainer.appendChild(selectContainer);","    const selectedLabel = document.createElement('div');","    selectedLabel.className = 'selected-label';","    selectedLabel.style.display = 'none';","    contentContainer.appendChild(selectedLabel);","    cellContainer.appendChild(contentContainer);","    selectElement.addEventListener('change', function () {","      const prev = selectElement.dataset.prevValue;","      if (prev) q.selectedCounts[prev] = (q.selectedCounts[prev] || 1) - 1;","      const val = selectElement.value;","      if (val) q.selectedCounts[val] = (q.selectedCounts[val] || 0) + 1;","      selectElement.dataset.prevValue = val;","      selectedLabel.innerText = val;","      selectedLabel.style.display = 'block';","      selectContainer.style.display = 'none';","      if (typeof q.showQuotaWarnings === 'function') {","        q.showQuotaWarnings();","      } else if (typeof globalThis.showQuotaWarnings === 'function') {","        globalThis.showQuotaWarnings(q);","      }","    });","    cellContainer.addEventListener('click', function (event) {","      if (!event || !event.target) return;","      if (event.target.tagName && event.target.tagName.toLowerCase() === 'select') return;","      selectContainer.style.display = 'block';","      if (typeof selectElement.focus === 'function') selectElement.focus();","      selectedLabel.style.display = 'none';","    });","  }","  function buildNeighborCell(q, cellContainer, rowIndex, columnIndex) {","    if (q && typeof q.isLockedCell === 'function' && q.isLockedCell(rowIndex, columnIndex)) {","      const locked = document.createElement('div');","      locked.className = 'locked-cell';","      cellContainer.appendChild(locked);","      return;","    }","    addCellImage(q, cellContainer, q ? q.imageLoadId : undefined);","    const idx = rowIndex * (q ? q.columnCount : 0) + columnIndex;","    if (!q || !q.interactionEnabled) {","      const contentContainer = document.createElement('div');","      contentContainer.className = 'content-container';","      const marker = document.createElement('div');","      marker.className = 'static-index-marker';","      marker.dataset.cellIndex = idx;","      marker.hidden = true;","      contentContainer.appendChild(marker);","      cellContainer.appendChild(contentContainer);","    } else if (q.useTokens) {","      const dropTarget = document.createElement('div');","      dropTarget.className = 'token-drop';","      dropTarget.dataset.cellIndex = idx;","      dropTarget.tabIndex = 0;","      dropTarget.setAttribute('role', 'button');","      dropTarget.setAttribute('aria-label', 'Drop zone for row ' + (rowIndex + 1) + ', column ' + (columnIndex + 1));","      dropTarget.addEventListener('dragover', function (event) {","        if (event && typeof event.preventDefault === 'function') event.preventDefault();","      });","      dropTarget.addEventListener('drop', function (event) {","        if (!event || typeof event.preventDefault !== 'function') return;","        event.preventDefault();","        const dataTransfer = event.dataTransfer;","        if (!dataTransfer) return;","        const id = dataTransfer.getData('text/plain');","        if (!id) return;","        const token = document.getElementById(id);","        if (!token) return;","        let tokenElement = token;","        if (q.tokenBank && token.parentElement === q.tokenBank) {","          tokenElement = spawnTokenFromBank(q, token);","          if (!tokenElement) return;","        }","        if (!placeTokenElement(q, dropTarget, tokenElement)) return;","        if (typeof q.clearKeyboardSelection === 'function') q.clearKeyboardSelection();","        if (typeof q.showQuotaWarnings === 'function') q.showQuotaWarnings();","        else if (typeof globalThis.showQuotaWarnings === 'function') globalThis.showQuotaWarnings(q);","      });","      dropTarget.addEventListener('keydown', function (event) {","        if (!event) return;","        const key = event.key;","        if (key === 'Enter' || key === ' ' || key === 'Spacebar') {","          event.preventDefault();","          if (q.keyboardTokenSelection) {","            const selection = q.keyboardTokenSelection;","            const newToken = spawnTokenValue(q, selection.value, !!selection.unlimited);","            if (!newToken) return;","            placeTokenElement(q, dropTarget, newToken);","            if (typeof q.clearKeyboardSelection === 'function') q.clearKeyboardSelection();","          } else if (removeTokenFromDropTarget(q, dropTarget)) {","            if (typeof q.clearKeyboardSelection === 'function') q.clearKeyboardSelection();","          }","          if (typeof q.showQuotaWarnings === 'function') q.showQuotaWarnings();","          else if (typeof globalThis.showQuotaWarnings === 'function') globalThis.showQuotaWarnings(q);","        } else if (key === 'Delete' || key === 'Backspace') {","          event.preventDefault();","          if (removeTokenFromDropTarget(q, dropTarget)) {","            if (typeof q.clearKeyboardSelection === 'function') q.clearKeyboardSelection();","            if (typeof q.showQuotaWarnings === 'function') q.showQuotaWarnings();","            else if (typeof globalThis.showQuotaWarnings === 'function') globalThis.showQuotaWarnings(q);","          }","        } else if (key === 'Escape') {","          if (typeof q.clearKeyboardSelection === 'function') q.clearKeyboardSelection();","        }","      });","      cellContainer.addEventListener('click', function () {","        if (!removeTokenFromDropTarget(q, dropTarget)) return;","        if (typeof q.clearKeyboardSelection === 'function') q.clearKeyboardSelection();","        if (typeof q.showQuotaWarnings === 'function') q.showQuotaWarnings();","        else if (typeof globalThis.showQuotaWarnings === 'function') globalThis.showQuotaWarnings(q);","      });","      const contentContainer = document.createElement('div');","      contentContainer.className = 'content-container';","      contentContainer.appendChild(dropTarget);","      cellContainer.appendChild(contentContainer);","    } else {","      addDropdownAndLabel(q, cellContainer, rowIndex, columnIndex);","    }","    addExperimentalLabel(q, cellContainer);","  }","  function populateGrid(q, gridContainer) {","    if (!q || !gridContainer) return;","    gridContainer.innerHTML = '';","    for (let rowIndex = 0; rowIndex < q.rowCount; rowIndex += 1) {","      for (let columnIndex = 0; columnIndex < q.columnCount; columnIndex += 1) {","        const cellContainer = document.createElement('div');","        cellContainer.className = 'cell-container';","        if (","          q.includeCenterCell &&","          rowIndex === q.calculateCenterCellRow() &&","          columnIndex === q.calculateCenterCellColumn()","        ) {","          buildCenterCell(q, cellContainer);","        } else {","          buildNeighborCell(q, cellContainer, rowIndex, columnIndex);","        }","        gridContainer.appendChild(cellContainer);","      }","    }","  }","  function measureCellSize(q, id) {","    if (!q || (typeof id !== 'undefined' && id !== q.imageLoadId)) return;","    if (q.cellWidth && q.cellHeight) return;","    const wrapper = q.outerDiv.querySelector('.cell-image-wrapper');","    if (!wrapper) return;","    const rect = wrapper.getBoundingClientRect();","    if (!rect.width || !rect.height) return;","    q.cellWidth = rect.width;","    q.cellHeight = rect.height;","    if (q.gridContainer) {","      q.gridContainer.style.gridTemplateColumns = 'repeat(' + q.columnCount + ', ' + q.cellWidth + 'px)';","      q.gridContainer.style.gridTemplateRows = 'repeat(' + q.rowCount + ', ' + q.cellHeight + 'px)';","    }","    q.outerDiv.querySelectorAll('.cell-container').forEach(function (cell) {","      cell.style.width = q.cellWidth + 'px';","      cell.style.height = q.cellHeight + 'px';","    });","  }","  function checkAndWarnAttributeFit(q, attributes, fontSize) {","    const warningDiv = document.getElementById('warnings');","    if (!warningDiv) return;","    if (!q || !q.cellWidth) {","      warningDiv.dataset.attrWarnings = '';","      updateWarningText(warningDiv);","      return;","    }","    const tester = document.createElement('span');","    tester.style.visibility = 'hidden';","    tester.style.whiteSpace = 'nowrap';","    tester.style.fontSize = (fontSize || 1) + 'rem';","    document.body.appendChild(tester);","    const tooLong = [];","    const max = q.cellWidth * 0.85;","    (Array.isArray(attributes) ? attributes : []).forEach(function (attr) {","      tester.textContent = attr;","      if (tester.offsetWidth > max) tooLong.push(attr);","    });","    tester.remove();","    warningDiv.dataset.attrWarnings = tooLong.length","      ? 'Warning: these labels may not fit - ' + tooLong.join(', ')","      : '';","    updateWarningText(warningDiv);","  }","  function centerGrid(q) {","    if (!q) return;","    const wrapper = q.gridWrapper || (q.outerDiv ? q.outerDiv.querySelector('.grid-wrapper') : null);","    const grid = q.gridContainer || document.getElementById('grid-id');","    if (!wrapper || !grid) return;","    wrapper.scrollLeft = (grid.scrollWidth - wrapper.clientWidth) / 2;","    const styles = typeof window !== 'undefined' && typeof window.getComputedStyle === 'function' ? window.getComputedStyle(grid) : null;","    const marginTop = styles ? parseFloat(styles.marginTop) || 0 : 0;","    const marginBottom = styles ? parseFloat(styles.marginBottom) || 0 : 0;","    wrapper.scrollTop = (grid.scrollHeight + marginTop + marginBottom - wrapper.clientHeight) / 2;","  }","  if (typeof globalThis.startGridContainer !== 'function') globalThis.startGridContainer = startGridContainer;","  if (typeof globalThis.setStyles !== 'function') globalThis.setStyles = setStyles;","  if (typeof globalThis.buildCenterCell !== 'function') globalThis.buildCenterCell = buildCenterCell;","  if (typeof globalThis.addCellImage !== 'function') globalThis.addCellImage = addCellImage;","  if (typeof globalThis.addDropdownAndLabel !== 'function') globalThis.addDropdownAndLabel = addDropdownAndLabel;","  if (typeof globalThis.buildNeighborCell !== 'function') globalThis.buildNeighborCell = buildNeighborCell;","  if (typeof globalThis.populateGrid !== 'function') globalThis.populateGrid = populateGrid;","  if (typeof globalThis.measureCellSize !== 'function') globalThis.measureCellSize = measureCellSize;","  if (typeof globalThis.checkAndWarnAttributeFit !== 'function') globalThis.checkAndWarnAttributeFit = checkAndWarnAttributeFit;","  if (typeof globalThis.centerGrid !== 'function') globalThis.centerGrid = centerGrid;","  if (typeof globalThis.setBackgroundWarning !== 'function') globalThis.setBackgroundWarning = setBackgroundWarning;","})();"].join("\n")),helperFunctions.push(["(function initScenarioRandomizers() {","  if (typeof globalThis.normalizeScenarioWeights !== 'function') {","    globalThis.normalizeScenarioWeights = function (scenarios) {","      if (!Array.isArray(scenarios)) return [];","      const decimals = 2;","      const roundProbabilityValue = typeof globalThis.roundProbability === 'function'","        ? globalThis.roundProbability","        : function (value, decimals) {","            if (typeof value !== 'number' || !Number.isFinite(value)) return 0;","            const factor = Math.pow(10, decimals);","            return Math.round((value + Number.EPSILON) * factor) / factor;","          };","      function roundProbabilityDistribution(values, decimals) {","        if (!Array.isArray(values) || values.length === 0) return [];","        const factor = Math.pow(10, decimals);","        const sanitizedValues = values.map(function (value) {","          return typeof value === 'number' && Number.isFinite(value) && value > 0","            ? value","            : 0;","        });","        const totalValues = sanitizedValues.reduce(function (sum, value) {","          return sum + value;","        }, 0);","        if (totalValues === 0) return sanitizedValues.map(function () { return 0; });","        const scaled = sanitizedValues.map(function (value) {","          return Math.round(value * factor);","        });","        const expectedTotal = Math.round(totalValues * factor);","        let scaledTotal = scaled.reduce(function (sum, value) { return sum + value; }, 0);","        let remainder = expectedTotal - scaledTotal;","        if (remainder !== 0) {","          const adjustOrder = sanitizedValues","            .map(function (value, idx) { return { value: value, idx: idx }; })","            .sort(function (a, b) { return b.value - a.value; })","            .map(function (item) { return item.idx; });","          if (!adjustOrder.length) adjustOrder.push(scaled.length - 1);","          if (remainder > 0) {","            let leftover = remainder;","            while (leftover > 0) {","              for (let i = 0; i < adjustOrder.length && leftover > 0; i += 1) {","                const idx = adjustOrder[i];","                scaled[idx] += 1;","                leftover -= 1;","              }","            }","          } else {","            let deficit = -remainder;","            while (deficit > 0) {","              let adjusted = false;","              for (let j = 0; j < adjustOrder.length && deficit > 0; j += 1) {","                const idx = adjustOrder[j];","                if (scaled[idx] === 0) continue;","                const reduction = Math.min(scaled[idx], deficit);","                if (!reduction) continue;","                scaled[idx] -= reduction;","                deficit -= reduction;","                adjusted = true;","              }","              if (!adjusted) break;","            }","          }","        }","        return scaled.map(function (value) { return value / factor; });","      }","      const sanitized = scenarios.map(function (sc) {","        const weight = parseFloat(sc && sc.weight);","        return {","          name: sc && sc.name ? sc.name : '',","          proportions: Array.isArray(sc && sc.proportions) ? sc.proportions.slice() : [],","          layout: sc && sc.layout ? sc.layout : 'weighted',","          weight: !Number.isFinite(weight) || weight < 0 ? 1 : weight,","        };","      });","      const total = sanitized.reduce(function (sum, sc) { return sum + sc.weight; }, 0);","      const count = sanitized.length;","      const raw = total > 0","        ? sanitized.map(function (sc) { return sc.weight / total; })","        : sanitized.map(function () { return count > 0 ? 1 / count : 0; });","      const probabilities = roundProbabilityDistribution(raw, decimals);","      return sanitized.map(function (sc, idx) {","        return {","          name: sc.name,","          proportions: sc.proportions,","          layout: sc.layout,","          probability: roundProbabilityValue(probabilities[idx], decimals),","        };","      });","    };","  }","  if (typeof globalThis.selectWeightedScenario !== 'function') {","    globalThis.selectWeightedScenario = function (q) {","      if (!q || q.isExperimental === false) return null;","      const normalized = globalThis.normalizeScenarioWeights(","        Array.isArray(q.experimentalScenarios) ? q.experimentalScenarios : []","      );","      if (!normalized.length) return null;","      q.experimentalScenarios = normalized;","      const r = Math.random();","      let cumulative = 0;","      for (let i = 0; i < normalized.length; i += 1) {","        const scenario = normalized[i];","        cumulative += typeof scenario.probability === 'number' ? scenario.probability : 0;","        if (r <= cumulative + Number.EPSILON) {","          return scenario;","        }","      }","      return normalized[normalized.length - 1];","    };","  }","  if (typeof globalThis.randomizeExperimentalTraits !== 'function') {","    globalThis.randomizeExperimentalTraits = function (q) {","      if (!q || q.isExperimental === false) {","        if (q) q.traitArray = null;","        return;","      }","      const columnCount = Number(q.columnCount) || 0;","      const rowCount = Number(q.rowCount) || 0;","      const includeCenter = !!q.includeCenterCell;","      const cellCount = columnCount * rowCount - (includeCenter ? 1 : 0);","      const traits = Array.isArray(q.experimentalTraits)","        ? q.experimentalTraits.filter(function (trait) { return typeof trait === 'string' && trait.length; })","        : [];","      const fallbackTrait = traits.length ? traits[traits.length - 1] : '';","      const scenario = globalThis.selectWeightedScenario(q);","      if (!scenario) {","        q.traitArray = [];","        q.scenarioName = null;","        q.scenarioWeight = null;","        q.scenarioProportions = null;","        q.scenarioLayout = null;","        return;","      }","      const layout = typeof scenario.layout === 'string' ? scenario.layout : 'weighted';","      const proportions = Array.isArray(scenario.proportions) ? scenario.proportions.slice() : [];","      let traitArray = [];","      if (layout === 'weighted') {","        const slotCount = Math.max(traits.length, proportions.length, 1);","        const weights = [];","        for (let i = 0; i < slotCount; i += 1) {","          const raw = proportions[i];","          weights.push(typeof raw === 'number' && raw > 0 ? raw : 0);","        }","        const total = weights.reduce(function (sum, value) { return sum + value; }, 0);","        const normalizedTotal = total > 0 ? total : slotCount;","        const cumulative = [];","        let running = 0;","        for (let i = 0; i < slotCount; i += 1) {","          const weight = total > 0 ? weights[i] : 1;","          running += weight / normalizedTotal;","          cumulative.push(running);","        }","        for (let i = 0; i < cellCount; i += 1) {","          const r = Math.random();","          let traitIdx = -1;","          for (let j = 0; j < cumulative.length; j += 1) {","            if (r <= cumulative[j] + Number.EPSILON) {","              traitIdx = j;","              break;","            }","          }","          if (traitIdx === -1) traitIdx = cumulative.length - 1;","          if (traitIdx >= traits.length) traitIdx = traits.length - 1;","          const trait = traitIdx >= 0 ? traits[traitIdx] : fallbackTrait;","          traitArray.push(typeof trait === 'string' && trait.length ? trait : fallbackTrait);","        }","      } else {","        proportions.forEach(function (count, idx) {","          const quota = Number(count) || 0;","          const trait = idx < traits.length ? traits[idx] : fallbackTrait;","          for (let i = 0; i < quota; i += 1) {","            traitArray.push(typeof trait === 'string' && trait.length ? trait : fallbackTrait);","          }","        });","        while (traitArray.length < cellCount) {","          const nextIdx = traits.length ? traitArray.length % traits.length : 0;","          const trait = traits.length ? traits[nextIdx] : fallbackTrait;","          traitArray.push(typeof trait === 'string' && trait.length ? trait : fallbackTrait);","        }","        traitArray = traitArray.slice(0, cellCount);","        if (layout === 'shuffle') {","          for (let i = traitArray.length - 1; i > 0; i -= 1) {","            const j = Math.floor(Math.random() * (i + 1));","            const tmp = traitArray[i];","            traitArray[i] = traitArray[j];","            traitArray[j] = tmp;","          }","        }","      }","      if (includeCenter) {","        const centerIndex =","          q.calculateCenterCellRow() * q.columnCount + q.calculateCenterCellColumn();","        const centerLabel = typeof q.centerLabelText === 'string' && q.centerLabelText.length","          ? q.centerLabelText","          : 'Your House';","        traitArray.splice(centerIndex, 0, centerLabel);","      }","      q.traitArray = traitArray;","      q.scenarioName = scenario.name || '';","      q.scenarioWeight = typeof scenario.probability === 'number' ? scenario.probability : null;","      q.scenarioProportions = proportions;","      q.scenarioLayout = layout;","    };","  }","})();"].join("\n")),helperFunctions.push(["(function ensureConfirmModal() {","  if (typeof globalThis.showConfirmModal === 'function') return;","  globalThis.showConfirmModal = function (onOk, onCancel, opts) {","    const force = opts && opts.force;","    const message = opts && opts.message;","    if (force) {","      if (typeof window !== 'undefined' && typeof window.alert === 'function') {","        window.alert(message || 'All cells must be filled before continuing.');","      }","      return;","    }","    const confirmed =","      typeof window !== 'undefined' && typeof window.confirm === 'function'","        ? window.confirm(","            message ||","              'Some cells are unfilled. Click Cancel to finish filling in cells or Continue to submit partly empty.'","          )","        : true;","    if (confirmed) {","      if (typeof onOk === 'function') onOk();","    } else if (typeof onCancel === 'function') {","      onCancel();","    }","  };","  if (typeof globalThis.hideConfirmModal !== 'function') {","    globalThis.hideConfirmModal = function () {};","  }","})();"].join("\n")),helperFunctions=helperFunctions.map(function(block){if(block.includes("(function initTokenUtils()")){var updated=block.replace("(function initTokenUtils() {",["(function initTokenUtils() {","  const tokenUtilsNS =","    globalThis.tokenUtils = globalThis.tokenUtils || {};"].join("\n"));return["addTokenBank","createDraggableToken","adjustTokenCount","getCurrentCounts","showQuotaWarnings","updateTokenCountReadout"].forEach(function(name){var regex=new RegExp("globalThis\\.".concat(name),"g");updated=updated.replace(regex,"tokenUtilsNS.".concat(name))}),updated}if(block.includes("(function initGridUtils()")){var _updated=block.replace("(function initGridUtils() {",["(function initGridUtils() {","  const gridUtilsNS =","    globalThis.gridUtils = globalThis.gridUtils || {};","  const tokenUtilsNS =","    globalThis.tokenUtils = globalThis.tokenUtils || {};"].join("\n"));["populateGrid","startGridContainer","setStyles","addCellImage","addDropdownAndLabel","buildNeighborCell","buildCenterCell","measureCellSize","checkAndWarnAttributeFit","centerGrid","setBackgroundWarning","addExperimentalLabel"].forEach(function(name){var regex=new RegExp("globalThis\\.".concat(name),"g");_updated=_updated.replace(regex,"gridUtilsNS.".concat(name))});return["createDraggableToken","adjustTokenCount","showQuotaWarnings","addTokenBank","getCurrentCounts","updateTokenCountReadout"].forEach(function(name){var regex=new RegExp("globalThis\\.".concat(name),"g");_updated=_updated.replace(regex,"tokenUtilsNS.".concat(name))}),_updated}if(block.includes("normalizeScenarioWeights")){var _updated2=block.replace("  if (typeof globalThis.normalizeScenarioWeights !== 'function') {","  const scenarioUtilsNS =\n    globalThis.scenarioUtils = globalThis.scenarioUtils || {};\n  if (typeof scenarioUtilsNS.normalizeScenarioWeights !== 'function') {");return _updated2=(_updated2=(_updated2=(_updated2=(_updated2=(_updated2=_updated2.replace("  globalThis.normalizeScenarioWeights = function (scenarios) {","  scenarioUtilsNS.normalizeScenarioWeights = function (scenarios) {")).replace("  if (typeof globalThis.selectWeightedScenario !== 'function') {","  const randomizerNS =\n    globalThis.randomizer = globalThis.randomizer || {};\n  if (typeof randomizerNS.selectWeightedScenario !== 'function') {")).replace("  if (typeof globalThis.randomizeExperimentalTraits !== 'function') {","  if (typeof randomizerNS.randomizeExperimentalTraits !== 'function') {")).replace(/globalThis\.normalizeScenarioWeights/g,"scenarioUtilsNS.normalizeScenarioWeights")).replace(/globalThis\.selectWeightedScenario/g,"randomizerNS.selectWeightedScenario")).replace(/globalThis\.randomizeExperimentalTraits/g,"randomizerNS.randomizeExperimentalTraits")}return block}),helperBlockIndented=helperBlock?"".concat(indentMultiline(helperBlock,2),"\n"):"",helperBlocks=helperFunctions.map(function(fn){return indentMultiline(fn,2)}),qualtricsScript='((function (global) {\n    if (!global) {\n      global = (function () {\n        return this || new Function("return this")();\n      })();\n    }\n    global.gridUtils = global.gridUtils || {};\n    global.tokenUtils = global.tokenUtils || {};\n    global.randomizer = global.randomizer || {};\n    global.scenarioUtils = global.scenarioUtils || {};\n    const interactionEnabled = '.concat(interactionEnabled,";\n    const followUpEnabled = ").concat(followUpEnabled,";\n    const GRIDDY_CONFIG = {\n      // Customize these selectors and IDs to match your Qualtrics layout.\n      questionSelector: '#surveyQuestion',\n      mountClassName: 'griddy-mount',\n      followUpQIDs: ").concat(JSON.stringify(followUpQIDs),",\n      confirmButtonLabel: ").concat(JSON.stringify(confirmLabel),",\n    };\n    global.GRIDDY_CONFIG = GRIDDY_CONFIG;\n    const SHARED_STYLE_TEXT = ").concat(JSON.stringify(sharedStyles),";\n    const SHARED_STYLE_ID = 'griddy-shared-styles';\n    function __ensureSharedStyles() {\n      if (!SHARED_STYLE_TEXT) return;\n      if (typeof document === 'undefined') return;\n      const head = document.head || document.getElementsByTagName('head')[0];\n      if (!head || typeof head.querySelector !== 'function') return;\n      const existingByAttr = head.querySelector('style[data-griddy-shared=\"true\"]');\n      const existingById =\n        typeof document.getElementById === 'function'\n          ? document.getElementById(SHARED_STYLE_ID)\n          : null;\n      const existing = existingByAttr || existingById;\n      if (existing) {\n        if (existing.textContent !== SHARED_STYLE_TEXT) {\n          existing.textContent = SHARED_STYLE_TEXT;\n        }\n        if (existing !== existingByAttr && existing.setAttribute) {\n          existing.setAttribute('data-griddy-shared', 'true');\n        }\n        if (existing.id !== SHARED_STYLE_ID && typeof existing === 'object') {\n          existing.id = SHARED_STYLE_ID;\n        }\n        return;\n      }\n      const style = document.createElement('style');\n      style.type = 'text/css';\n      style.setAttribute('data-griddy-shared', 'true');\n      style.id = SHARED_STYLE_ID;\n      const textNode =\n        typeof document.createTextNode === 'function'\n          ? document.createTextNode(SHARED_STYLE_TEXT)\n          : null;\n      if (textNode && typeof style.appendChild === 'function') {\n        style.appendChild(textNode);\n      } else {\n        style.textContent = SHARED_STYLE_TEXT;\n      }\n      head.appendChild(style);\n    }\n    const DEFAULT_CELL_SVG = (typeof global.DEFAULT_CELL_SVG === \"string\" && global.DEFAULT_CELL_SVG) || ").concat(JSON.stringify(defaultCellSVG),";\n    const missingCode = ").concat(JSON.stringify(missingCode),";\n    const errorCode = ").concat(JSON.stringify(errorCode),";\n    const optionShuffleSeed = ").concat(JSON.stringify(optionShuffleSeed),";\n    const persistedOptionOrder = ").concat(JSON.stringify(persistedOptionOrder),";\n    let neighborhoodQuestionInstance = null;\n    const parsePriorSelections = ").concat(parsePriorSelectionsSource,';\n    function defineStatics(target) {\n      if (!target) return;\n      target.DEFAULT_CELL_SVG = DEFAULT_CELL_SVG;\n      target.SKIP_ALLOW = "allow";\n      target.SKIP_FORCE = "force";\n      target.SKIP_REMIND = "remind";\n    }\n  ').concat(helperBlockIndented).concat(indentMultiline(adaptedNeighborhoodQuestionSource,2),"\n    defineStatics(NeighborhoodQuestion);\n    global.DEFAULT_CELL_SVG = DEFAULT_CELL_SVG;\n    global.NeighborhoodQuestion = NeighborhoodQuestion;\n  ").concat(helperBlocks.join("\n"),"\n    if (typeof global.Qualtrics !== 'undefined' && global.Qualtrics.SurveyEngine) {\n      const Qualtrics = global.Qualtrics;\n      Qualtrics.SurveyEngine.addOnload(function () {\n        Qualtrics.SurveyEngine.setEmbeddedData(\n          \"neighborhood_question_chosen_labels\",\n          errorCode\n        );\n      });\n      Qualtrics.SurveyEngine.addOnReady(function () {\n        __ensureSharedStyles();\n        const containerFromConfig = (function () {\n          if (typeof document === 'undefined') return null;\n          if (!GRIDDY_CONFIG || !GRIDDY_CONFIG.questionSelector) return null;\n          const selected = document.querySelector(GRIDDY_CONFIG.questionSelector);\n          if (selected) return selected;\n          if (GRIDDY_CONFIG.questionSelector.charAt(0) === '#') {\n            return document.getElementById(GRIDDY_CONFIG.questionSelector.slice(1));\n          }\n          return null;\n        })();\n        const container =\n          (typeof this.getQuestionContainer === 'function' && this.getQuestionContainer()) ||\n          containerFromConfig ||\n          document.getElementById('surveyQuestion');\n        if (!container) return;\n        const mountClass =\n          (GRIDDY_CONFIG && GRIDDY_CONFIG.mountClassName) || 'griddy-mount';\n        const existingMount = container.querySelector('.' + mountClass);\n        const mount =\n          existingMount || Object.assign(document.createElement('div'), { className: mountClass });\n        if (!existingMount) container.appendChild(mount);\n        if (!interactionEnabled) {\n          const navButtons = container.querySelector('.scenario-buttons');\n          if (navButtons && typeof navButtons.remove === 'function') {\n            navButtons.remove();\n          }\n        }\n        neighborhoodQuestionInstance = new NeighborhoodQuestion(mount);\n        this.neighborhoodQuestion = neighborhoodQuestionInstance;\n        const priorSelections = parsePriorSelections();\n        neighborhoodQuestionInstance.renderQuestion(\n          ").concat(JSON.stringify(qText),",\n          ").concat(parseFloat(formInputs.columnInput.value),",\n          ").concat(parseFloat(formInputs.rowInput.value),",\n          ").concat(JSON.stringify(dropdownOptions),",\n          ").concat(JSON.stringify(centerLabel),",\n          ").concat(formInputs.enableCenterCell.checked,",\n          ").concat(parseInt(formInputs.centerCellColumnInput.value,10)||null,",\n          ").concat(parseInt(formInputs.centerCellRowInput.value,10)||null,",\n          ").concat(formInputs.experimentalRadioInput.checked,",\n          ").concat(JSON.stringify(traitList),",\n          ").concat(JSON.stringify(scenarios),",\n          this,\n          ").concat(JSON.stringify(safeImageHTML),",\n          ").concat(JSON.stringify(backgroundURL),",\n          priorSelections,\n          ").concat(interactionEnabled&&formInputs.dragDropCheckbox.checked,",\n          ").concat(JSON.stringify(quotas),",\n          null,\n          interactionEnabled,\n          ").concat(JSON.stringify(formInputs.skipBehaviorSelect.value),",\n          missingCode,\n          errorCode,\n          optionShuffleSeed,\n          persistedOptionOrder\n        );\n        if (\n          interactionEnabled &&\n          typeof Qualtrics.SurveyEngine.hideNextButton === 'function'\n        ) {\n          Qualtrics.SurveyEngine.hideNextButton();\n          this._griddyHidNext = true;\n        }\n        if (\n          !interactionEnabled &&\n          neighborhoodQuestionInstance &&\n          typeof neighborhoodQuestionInstance.recordSelectionsToQualtrics === 'function'\n        ) {\n          neighborhoodQuestionInstance.recordSelectionsToQualtrics();\n        }\n        if (\n          interactionEnabled &&\n          followUpEnabled &&\n          typeof global.setupFollowUpQIDs === 'function'\n        ) {\n          global.setupFollowUpQIDs({\n            gridSelector:\n              (GRIDDY_CONFIG && GRIDDY_CONFIG.questionSelector) || '#surveyQuestion',\n            likertQIDs: (GRIDDY_CONFIG && GRIDDY_CONFIG.followUpQIDs) || [],\n            confirmLabel:\n              (GRIDDY_CONFIG && GRIDDY_CONFIG.confirmButtonLabel) || ").concat(JSON.stringify(confirmLabel),",\n          });\n        }\n      });\n      Qualtrics.SurveyEngine.addOnUnload(function () {\n        try {\n          const question = (this && this.neighborhoodQuestion) || neighborhoodQuestionInstance;\n          if (question && typeof question.recordSelectionsToQualtrics === 'function') {\n            question.recordSelectionsToQualtrics();\n          }\n        } catch (err) {}\n        if (\n          interactionEnabled &&\n          this &&\n          this._griddyHidNext &&\n          typeof Qualtrics.SurveyEngine.showNextButton === 'function'\n        ) {\n          Qualtrics.SurveyEngine.showNextButton();\n          this._griddyHidNext = false;\n        }\n      });\n    }\n  })(typeof globalThis !== 'undefined' ? globalThis : (typeof window !== 'undefined' ? window : this)));"),_context3.a(2,qualtricsScript)}},_callee3)}))).apply(this,arguments)}function buildQualtricsHTMLString(formInputs){var errors=validateInputs(formInputs);if(errors.length)throw new Error(errors.join("\n"));if(!carryForwardLayoutsMatch(globalThis.appState.portfolio,globalThis.appState.currentTask))throw new Error("Linked task layout does not match the source. Adjust the grid or unlink this task.");return['\x3c!-- Section for custom question content --\x3e\n    <div class="survey-question" id="surveyQuestion">',sanitizeHTML(formInputs.questionTextInput.value),"</div>"].join("\n")}function sanitizeFileName(name){var sanitized=String(name).replace(/[^a-z0-9_-]/gi,"_");return sanitized.length>0?sanitized:"untitled"}function flashCopied(element){if(element&&element.parentNode){var span=document.createElement("span");span.className="copy-feedback",span.textContent="Copied!",element.insertAdjacentElement("afterend",span),setTimeout(function(){return span.remove()},1e3)}}function abortIfProbWarnings(){var div=document.getElementById("warnings");return!!(div&&div.dataset&&div.dataset.probWarnings)&&(displayError(div.dataset.probWarnings),!0)}function showCopyModal(text,title){var modal=document.getElementById("copyModal");if(modal){modal.style.display="flex";var heading=modal.querySelector("h2");heading&&(heading.textContent=title)}else{(modal=document.createElement("div")).id="copyModal",modal.style.display="flex",modal.style.position="fixed",modal.style.top=0,modal.style.left=0,modal.style.width="100%",modal.style.height="100%",modal.style.background="rgba(0,0,0,0.5)",modal.style.justifyContent="center",modal.style.alignItems="center",modal.style.zIndex=1e3;var inner=document.createElement("div");inner.className="modal-content",inner.style.background="#fff",inner.style.padding="20px",inner.style.borderRadius="4px",inner.style.textAlign="center";var h2=document.createElement("h2");h2.textContent=title;var p=document.createElement("p");p.textContent="Clipboard access was denied. Select and copy the text below manually.";var _ta=document.createElement("textarea");_ta.id="copyModalText",_ta.style.width="100%",_ta.style.height="150px";var close=document.createElement("button");close.textContent="Close",close.onclick=function(){return modal.style.display="none"},inner.appendChild(h2),inner.appendChild(p),inner.appendChild(_ta),inner.appendChild(close),modal.appendChild(inner),document.body.appendChild(modal)}var ta=modal.querySelector("#copyModalText");ta&&(ta.value=text,ta.focus(),ta.select())}function writeTextToClipboard(text,fallbackTitle){if(!text)return Promise.resolve(!1);var nav=function(){if("undefined"!=typeof navigator&&navigator)return navigator;if("undefined"!=typeof window&&window.navigator)return window.navigator;if("undefined"!=typeof globalThis){if(globalThis.navigator)return globalThis.navigator;if(globalThis.window&&globalThis.window.navigator)return globalThis.window.navigator;if(globalThis.document&&globalThis.document.defaultView&&globalThis.document.defaultView.navigator)return globalThis.document.defaultView.navigator}}();if(!nav||!nav.clipboard||"function"!=typeof nav.clipboard.writeText)return showCopyModal(text,fallbackTitle),Promise.resolve(!1);try{return nav.clipboard.writeText(text).then(function(){return!0},function(){return showCopyModal(text,fallbackTitle),!1})}catch(err){return showCopyModal(text,fallbackTitle),Promise.resolve(!1)}}function copyQualtricsJS(_x5){return _copyQualtricsJS.apply(this,arguments)}function _copyQualtricsJS(){return(_copyQualtricsJS=_asyncToGenerator(_regenerator().m(function _callee4(btn){var formInputs,jsSnippet,copied,_t4;return _regenerator().w(function(_context4){for(;;)switch(_context4.p=_context4.n){case 0:if(!abortIfProbWarnings()){_context4.n=1;break}return _context4.a(2,!1);case 1:return formInputs=new FormInputsRef,_context4.p=2,_context4.n=3,buildQualtricsJSString(formInputs);case 3:jsSnippet=_context4.v,_context4.n=5;break;case 4:return _context4.p=4,_t4=_context4.v,alert(_t4.message),_context4.a(2,!1);case 5:return _context4.n=6,writeTextToClipboard(jsSnippet,"Copy the JavaScript manually");case 6:return(copied=_context4.v)&&flashCopied(btn),_context4.a(2,copied)}},_callee4,null,[[2,4]])}))).apply(this,arguments)}function copyQualtricsHTML(btn){if(abortIfProbWarnings())return Promise.resolve("");var formInputs=new FormInputsRef;try{var html=buildQualtricsHTMLString(formInputs);return writeTextToClipboard(html,"Copy the HTML manually").then(function(copied){return copied&&flashCopied(btn),html})}catch(err){return alert(err.message),Promise.resolve("")}}function downloadQualtricsFiles(){return _downloadQualtricsFiles.apply(this,arguments)}function _downloadQualtricsFiles(){return(_downloadQualtricsFiles=_asyncToGenerator(_regenerator().m(function _callee5(){var original,_loop4,i;return _regenerator().w(function(_context6){for(;;)switch(_context6.n){case 0:if(!abortIfProbWarnings()){_context6.n=1;break}return _context6.a(2);case 1:if(Array.isArray(globalThis.appState.portfolio)&&0!==globalThis.appState.portfolio.length){_context6.n=2;break}return _context6.a(2);case 2:saveCurrent(),original=globalThis.appState.currentTask,_loop4=_regenerator().m(function _loop4(){var formInputs,html,js,name,htmlBlob,htmlLink,jsBlob,jsLink,_t5;return _regenerator().w(function(_context5){for(;;)switch(_context5.p=_context5.n){case 0:return globalThis.appState.currentTask=i,deserializeCurrentInputs(globalThis.appState.portfolio[i].data),formInputs=new FormInputsRef,_context5.p=1,html=buildQualtricsHTMLString(formInputs),_context5.n=2,buildQualtricsJSString(formInputs);case 2:js=_context5.v,name=sanitizeFileName(globalThis.appState.portfolio[i].name||"task_".concat(i+1)),htmlBlob=new Blob([html],{type:"text/html"}),(htmlLink=document.createElement("a")).href=URL.createObjectURL(htmlBlob),htmlLink.download="".concat(name,".html"),document.body&&document.body.appendChild(htmlLink),htmlLink.click(),htmlLink.remove(),"function"==typeof URL.revokeObjectURL&&setTimeout(function(){return URL.revokeObjectURL(htmlLink.href)},0),jsBlob=new Blob([js],{type:"application/javascript"}),(jsLink=document.createElement("a")).href=URL.createObjectURL(jsBlob),jsLink.download="".concat(name,".js"),document.body&&document.body.appendChild(jsLink),jsLink.click(),jsLink.remove(),"function"==typeof URL.revokeObjectURL&&setTimeout(function(){return URL.revokeObjectURL(jsLink.href)},0),_context5.n=4;break;case 3:_context5.p=3,_t5=_context5.v,alert("Failed to export ".concat(globalThis.appState.portfolio[i].name,": ").concat(_t5.message));case 4:return _context5.a(2)}},_loop4,null,[[1,3]])}),i=0;case 3:if(!(i<globalThis.appState.portfolio.length)){_context6.n=5;break}return _context6.d(_regeneratorValues(_loop4()),4);case 4:i++,_context6.n=3;break;case 5:globalThis.appState.currentTask=original,deserializeCurrentInputs(globalThis.appState.portfolio[original].data),updateTaskSelect();case 6:return _context6.a(2)}},_callee5)}))).apply(this,arguments)}function showConfirmModal(onOk,onCancel){var opts=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},modal=document.getElementById("confirmModal"),okBtn=document.getElementById("confirmOk"),cancelBtn=document.getElementById("confirmCancel");function cleanup(){okBtn.removeEventListener("click",okHandler),cancelBtn.removeEventListener("click",cancelHandler),document.removeEventListener("keydown",keyHandler)}function okHandler(){cleanup(),hideConfirmModal(),onOk&&onOk()}function cancelHandler(){cleanup(),hideConfirmModal(),onCancel&&onCancel()}function keyHandler(e){"Escape"===e.key&&cancelHandler()}modal&&okBtn&&cancelBtn&&(lastFocusedElement=document.activeElement,modal.style.display="flex",modal.setAttribute("aria-hidden","false"),okBtn.addEventListener("click",okHandler),cancelBtn.addEventListener("click",cancelHandler),document.addEventListener("keydown",keyHandler),okBtn.focus(),opts.force?cancelBtn.style.display="none":cancelBtn.style.display="inline-block")}function hideConfirmModal(){var modal=document.getElementById("confirmModal");modal&&(modal.style.display="none",modal.setAttribute("aria-hidden","true")),lastFocusedElement&&(lastFocusedElement.focus(),lastFocusedElement=null)}function syncCurrentScenarioIndex(){"undefined"!=typeof globalThis&&(globalThis.currentScenarioIndex=currentScenarioIndex)}function updateScenarioLimitUILocal(){var btn=document.getElementById("addScenarioBtn"),warn=document.getElementById("scenarioLimitWarning");if(btn||warn){var limitReached=document.querySelectorAll("#scenarios-container .scenario").length>=MAX_SCENARIOS_CONST;btn&&(btn.disabled=limitReached),warn&&warn.style&&(warn.style.display=limitReached?"inline":"none")}}function renumberScenarioLabels(){document.querySelectorAll("#scenarios-container .scenario-label").forEach(function(label,idx){label.textContent="Scenario ".concat(idx+1,":")})}function updateScenarioNavVisibility(){var buttons=document.querySelectorAll(".scenario-buttons")[0];if(buttons&&buttons.style){var previewPane=document.getElementById("previewPane");if(!!(previewPane&&previewPane.classList&&previewPane.classList.contains("static-preview")))buttons.style.display="none";else{var count=document.querySelectorAll("#scenarios-container .scenario").length;buttons.style.display=count>=2?"block":"none"}}}function highlightCurrentScenario(){document.querySelectorAll("#scenarios-container .scenario").forEach(function(sc,idx){sc.classList&&(idx===currentScenarioIndex?sc.classList.add("selected"):sc.classList.remove("selected"))}),updateScenarioNavVisibility()}function setCurrentScenarioIndex(idx){var scenarios=document.querySelectorAll("#scenarios-container .scenario");currentScenarioIndex=Math.max(0,Math.min(idx,scenarios.length-1)),syncCurrentScenarioIndex(),highlightCurrentScenario()}function duplicateScenario(button){"function"==typeof globalThis.persistScenarioProbabilities&&globalThis.persistScenarioProbabilities();var scenario=button.closest(".scenario"),container=document.getElementById("scenarios-container");if(scenario&&container&&!(container.querySelectorAll(".scenario").length>=MAX_SCENARIOS_CONST)){var clone=scenario.cloneNode(!0);clone.draggable=!0,scenario.after(clone),renumberScenarioLabels(),globalThis.updateScenarioLimitUI(),globalThis.toggleWeightInputs&&globalThis.toggleWeightInputs();var eqInput=clone.querySelector('input[name="equalProbability"]');eqInput&&eqInput.addEventListener&&eqInput.addEventListener("change",function(){globalThis.updateTraitProbabilityInputs&&globalThis.updateTraitProbabilityInputs()}),globalThis.updateTraitProbabilityInputs&&globalThis.updateTraitProbabilityInputs(),setCurrentScenarioIndex(_toConsumableArray(container.querySelectorAll(".scenario")).indexOf(clone))}}function moveScenario(fromIdx,toIdx){var container=document.getElementById("scenarios-container"),scenarios=_toConsumableArray(container.querySelectorAll(".scenario"));if(!(fromIdx<0||fromIdx>=scenarios.length||toIdx<0||toIdx>=scenarios.length||fromIdx===toIdx)){"function"==typeof globalThis.persistScenarioProbabilities&&globalThis.persistScenarioProbabilities();var moving=scenarios[fromIdx],target=scenarios[toIdx];container.insertBefore(moving,fromIdx<toIdx?target.nextSibling:target),renumberScenarioLabels(),"function"==typeof globalThis.toggleWeightInputs&&globalThis.toggleWeightInputs(),setCurrentScenarioIndex(toIdx)}}function initScenarioDragAndDrop(){var container=document.getElementById("scenarios-container");if(container){container.querySelectorAll(".scenario").forEach(function(sc){sc.draggable=!0});var dragIndex=null;container.addEventListener("dragstart",function(e){var sc=e.target.closest(".scenario");sc&&(dragIndex=_toConsumableArray(container.querySelectorAll(".scenario")).indexOf(sc),e.dataTransfer.setData("text/plain",""))}),container.addEventListener("dragover",function(e){e.preventDefault()}),container.addEventListener("drop",function(e){e.preventDefault();var sc=e.target.closest(".scenario");if(sc){var dropIdx=_toConsumableArray(container.querySelectorAll(".scenario")).indexOf(sc);null!==dragIndex&&moveScenario(dragIndex,dropIdx),dragIndex=null}})}}function nextScenario(){var scenarios=document.querySelectorAll("#scenarios-container .scenario");0!==scenarios.length&&(setCurrentScenarioIndex((currentScenarioIndex+1)%scenarios.length),"function"==typeof globalThis.buildAndUpdatePreview&&globalThis.buildAndUpdatePreview())}function prevScenario(){var scenarios=document.querySelectorAll("#scenarios-container .scenario");0!==scenarios.length&&(setCurrentScenarioIndex((currentScenarioIndex-1+scenarios.length)%scenarios.length),"function"==typeof globalThis.buildAndUpdatePreview&&globalThis.buildAndUpdatePreview())}function randomizeScenario(){currentQuestion&&currentQuestion.randomizeExperimentalTraits&&currentQuestion.randomizeExperimentalTraits();var scenarios=document.querySelectorAll("#scenarios-container .scenario");scenarios.length>0&&setCurrentScenarioIndex(Math.floor(Math.random()*scenarios.length)),"function"==typeof globalThis.buildAndUpdatePreview&&globalThis.buildAndUpdatePreview()}function getCurrentScenarioIndex(){return currentScenarioIndex}function __setCurrentQuestion(q){currentQuestion=q}function parseQuotaValue(raw){if("number"==typeof raw&&Number.isFinite(raw))return raw;var str="string"==typeof raw?raw.trim():String(raw||"").trim();return""===str?0:/^-?\d+$/.test(str)?parseInt(str,10):NaN}function readQuotaInputs(){var _ref9=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},container=_ref9.container,hidden=_ref9.hidden,options=_ref9.options;container||"undefined"==typeof document||(container=document.getElementById("quotaInputContainer")),hidden||"undefined"==typeof document||(hidden=document.getElementById("optionQuotaInput"));var results=[],inputs=container?Array.from(container.querySelectorAll(".quota-input")):[];if(inputs.length)return inputs.forEach(function(input){results.push(parseQuotaValue(input.value))}),results;if(!hidden)return results;var dataset=hidden.dataset||{},order=[];if(Array.isArray(options)&&options.length&&(order=options.map(function(opt){return"".concat(opt).trim()}).filter(function(opt){return opt})),!order.length&&dataset.quotaOptions)try{var parsed=JSON.parse(dataset.quotaOptions);Array.isArray(parsed)&&(order=parsed.map(function(opt){return"".concat(opt).trim()}).filter(function(opt){return opt}))}catch(err){order=[]}var map=null;if(dataset.quotaMap)try{var _parsed=JSON.parse(dataset.quotaMap);_parsed&&"object"===_typeof(_parsed)&&(map=_parsed)}catch(err){map=null}if(map&&order.length)return order.forEach(function(label){var key=function(label){return(label||"").trim().toLowerCase()}(label),value=Object.prototype.hasOwnProperty.call(map,key)&&void 0!==map[key]?map[key]:map[label];results.push(parseQuotaValue(value))}),results;if(dataset.quotaLastValues)try{var _parsed2=JSON.parse(dataset.quotaLastValues);if(Array.isArray(_parsed2)&&_parsed2.length)return _parsed2.forEach(function(value){results.push(parseQuotaValue(value))}),results}catch(err){}return hidden.value&&hidden.value.split(",").map(function(q){return q.trim()}).forEach(function(value){results.push(parseQuotaValue(value))}),results}function updateQuotaInputs(){var optInput=document.getElementById("dropdownOptionsInput"),enable=document.getElementById("enableQuotas"),container=document.getElementById("quotaInputContainer"),hidden=document.getElementById("optionQuotaInput");if(container&&hidden&&optInput){if(!enable||!enable.checked){if(hidden.dataset){var captured=readQuotaInputs({container:container,hidden:hidden});captured.length?hidden.dataset.quotaLastValues=JSON.stringify(captured):delete hidden.dataset.quotaLastValues}return container.innerHTML="",container.style.display="none",void(hidden.value="")}var options=optInput.value.split(/\s*,\s*/).filter(function(o){return o}),existingInputs=container.querySelectorAll(".quota-input"),oldMap={};existingInputs.forEach(function(i){var key=i.title?i.title.replace(/^Quota for\s+/,"").trim().toLowerCase():"";oldMap[key]=i.value});var hiddenValues=null;0===existingInputs.length&&hidden.value&&(hiddenValues=hidden.value.split(",").map(function(v){return v.trim()}));var hiddenMap=null,storedOptionOrder=null;if(hidden.dataset&&hidden.dataset.quotaMap)try{var parsed=JSON.parse(hidden.dataset.quotaMap);parsed&&"object"===_typeof(parsed)&&(hiddenMap=parsed)}catch(err){hiddenMap=null}if(hidden.dataset&&hidden.dataset.quotaOptions)try{var _parsed3=JSON.parse(hidden.dataset.quotaOptions);Array.isArray(_parsed3)&&(storedOptionOrder=_parsed3.map(function(s){return"".concat(s)}))}catch(err){storedOptionOrder=null}var normalizedOptions=options.map(function(opt){return opt.trim()});container.innerHTML="",options.forEach(function(opt,idx){var wrap=document.createElement("div");wrap.className="inline-item";var label=document.createElement("label");label.textContent=opt+":";var inp=document.createElement("input");inp.type="number",inp.min="0",inp.className="quota-input input-field",inp.placeholder="0",inp.title="Quota for ".concat(opt);var value,trimmed=opt.trim(),key=trimmed.toLowerCase();if(Object.prototype.hasOwnProperty.call(oldMap,key))value=oldMap[key];else if(hiddenMap&&Object.prototype.hasOwnProperty.call(hiddenMap,key))value=hiddenMap[key];else if(hiddenValues){var _hiddenValues$idx;value=(!storedOptionOrder||storedOptionOrder.length===normalizedOptions.length&&storedOptionOrder.every(function(stored,storedIdx){return stored.toLowerCase()===normalizedOptions[storedIdx].toLowerCase()}))&&null!==(_hiddenValues$idx=hiddenValues[idx])&&void 0!==_hiddenValues$idx?_hiddenValues$idx:""}else value="";var normalizedValue=""===value||null==value?"0":"".concat(value);inp.value=normalizedValue,inp.dataset.optionKey=key,inp.dataset.optionLabel=trimmed,inp.oninput=updateHidden,wrap.appendChild(label),wrap.appendChild(inp),container.appendChild(wrap)}),container.style.display="flex",updateHidden()}function updateHidden(){var inputs=Array.from(container.querySelectorAll(".quota-input")),vals=inputs.map(function(i){return i.value.trim()});hidden.value=vals.join(", ");var optionOrder=[],map={};if(inputs.forEach(function(input,inputIdx){var optLabel=input.dataset.optionLabel||normalizedOptions[inputIdx]||"",optKey=(input.dataset.optionKey||optLabel).toLowerCase();optionOrder.push(optLabel),map[optKey]=input.value.trim()}),hidden.dataset){hidden.dataset.quotaOptions=JSON.stringify(optionOrder),hidden.dataset.quotaMap=JSON.stringify(map);var values=inputs.map(function(input){return parseQuotaValue(input.value)});hidden.dataset.quotaLastValues=JSON.stringify(values)}}}function setScenarioVisibility(design){var div=document.getElementById("experimentalScenariosContent");div&&(div.style.display="experimental_scenarios"===design?"block":"none")}function addCellImageToggleListener(){var checkbox=document.getElementById("defaultCellCheckbox"),custom=document.getElementById("customCellInputs"),method=document.getElementById("cellImageMethod"),fileC=document.getElementById("cellImageFileContainer"),svgC=document.getElementById("cellImageSVGContainer"),urlC=document.getElementById("cellImageURLContainer");function setSectionVisibility(section,show){section&&(section.style.display=show?"block":"none",section.hidden=!show,section.setAttribute("aria-hidden",show?"false":"true"))}function updateMethod(showCustom){if(method){var allowVisibility="boolean"==typeof showCustom?showCustom:!checkbox||!checkbox.checked;setSectionVisibility(fileC,allowVisibility&&"file"===method.value),setSectionVisibility(svgC,allowVisibility&&"svg"===method.value),setSectionVisibility(urlC,allowVisibility&&"url"===method.value)}}function update(){var show=!checkbox||!checkbox.checked;setSectionVisibility(custom,show),checkbox&&checkbox.setAttribute("aria-expanded",show?"true":"false"),updateMethod(show)}custom&&(checkbox&&custom&&custom.id&&(checkbox.hasAttribute("aria-controls")||checkbox.setAttribute("aria-controls",custom.id)),checkbox&&(checkbox.onchange=update),method&&(method.onchange=function(){return updateMethod(!checkbox||!checkbox.checked)}),update())}function addCenterCellToggleListener(){var checkbox=document.getElementById("enableCenterCell"),positionGroup=document.getElementById("centerCellPositionInputs"),labelInput=document.getElementById("centerCellTextInput"),positionInputs=positionGroup?Array.from(positionGroup.querySelectorAll("input")):[];function setDisabledAttribute(el,disabled){el&&(el.disabled=disabled,disabled?el.setAttribute("aria-disabled","true"):el.removeAttribute("aria-disabled"))}function update(){var enabled=!checkbox||checkbox.checked;positionGroup&&(positionGroup.style.display=enabled?"flex":"none",positionGroup.setAttribute("aria-hidden",enabled?"false":"true")),setDisabledAttribute(labelInput,!enabled),positionInputs.forEach(function(input){return setDisabledAttribute(input,!enabled)})}(checkbox||positionGroup||labelInput)&&(checkbox&&(checkbox.onchange=update),update())}function getFollowUpElements(){var _qidInput$closest,_confirmInput$closest,_checkbox$closest,checkbox=document.getElementById("followUpCheckbox"),qidInput=document.getElementById("followUpQIDsInput"),confirmInput=document.getElementById("confirmButtonText"),advancedPanel=qidInput&&(null===(_qidInput$closest=qidInput.closest)||void 0===_qidInput$closest?void 0:_qidInput$closest.call(qidInput,"details"))||confirmInput&&(null===(_confirmInput$closest=confirmInput.closest)||void 0===_confirmInput$closest?void 0:_confirmInput$closest.call(confirmInput,"details"))||checkbox&&(null===(_checkbox$closest=checkbox.closest)||void 0===_checkbox$closest?void 0:_checkbox$closest.call(checkbox,"details"))||null;return{checkbox:checkbox,qidLabel:document.querySelector('label[for="followUpQIDsInput"]'),qidInput:qidInput,confirmLabel:document.querySelector('label[for="confirmButtonText"]'),confirmInput:confirmInput,stateHint:document.getElementById("followUpStateHint"),advancedPanel:advancedPanel}}function updateFollowUpFieldVisibility(){var _getFollowUpElements=getFollowUpElements(),checkbox=_getFollowUpElements.checkbox,qidLabel=_getFollowUpElements.qidLabel,qidInput=_getFollowUpElements.qidInput,confirmLabel=_getFollowUpElements.confirmLabel,confirmInput=_getFollowUpElements.confirmInput,stateHint=_getFollowUpElements.stateHint,advancedPanel=_getFollowUpElements.advancedPanel,wasOpen=advancedPanel&&"boolean"==typeof advancedPanel.open?advancedPanel.open:void 0,show=!!checkbox&&checkbox.checked;[qidLabel,qidInput,confirmLabel,confirmInput].forEach(function(el){el&&el.classList&&el.classList.toggle("muted-field",!show)}),[qidInput,confirmInput].forEach(function(input){input&&(input.disabled=!show,show?input.removeAttribute("aria-disabled"):input.setAttribute("aria-disabled","true"))}),stateHint&&(stateHint.textContent=show?"Follow-up gating is enabled. Customize these fields as needed.":"Follow-up gating is disabled. Enable the checkbox to edit these fields."),advancedPanel&&"boolean"==typeof wasOpen&&(advancedPanel.open=wasOpen)}function initFollowUpFieldToggle(){var checkbox=getFollowUpElements().checkbox;checkbox&&("true"!==checkbox.dataset.followUpListenerAttached?(checkbox.addEventListener("change",function(){return updateFollowUpFieldVisibility()}),checkbox.dataset.followUpListenerAttached="true",updateFollowUpFieldVisibility()):updateFollowUpFieldVisibility())}function addUserInteractionToggleListener(formInputs){var toggle=formInputs.userInteractionCheckbox;if(toggle){var storedState=null,lastKnownDesign=null,interactionFieldDescriptors=[{key:"design",capture:function(inputs,state){var _inputs$experimentalR;state.design=null!==(_inputs$experimentalR=inputs.experimentalRadioInput)&&void 0!==_inputs$experimentalR&&_inputs$experimentalR.checked?"experimental_scenarios":"blank_neighborhood"},disable:function(inputs){var blank=inputs.blankNeighborhoodRadio,experimental=inputs.experimentalRadioInput;blank&&(blank.disabled=!0),experimental&&(experimental.disabled=!0)},enable:function(inputs,state){var blank=inputs.blankNeighborhoodRadio,experimental=inputs.experimentalRadioInput;blank&&(blank.disabled=!1),experimental&&(experimental.disabled=!1)}},{field:"enableQuotasCheckbox",stateKey:"quotasChecked",type:"checked",defaultValue:!1},{field:"optionQuotaInput",stateKey:"quotaValue",type:"value",defaultValue:""},{field:"optionShuffleSeed",stateKey:"shuffleSeed",type:"value",defaultValue:""},{field:"optionShuffleOrder",stateKey:"shuffleOrder",type:"value",defaultValue:""},{field:"dragDropCheckbox",stateKey:"dragDropChecked",type:"checked",defaultValue:!1},{field:"skipBehaviorSelect",stateKey:"skipBehavior",type:"value",defaultValue:DEFAULT_SKIP_BEHAVIOR,capture:function(inputs,state){var select=inputs.skipBehaviorSelect;select&&(state.skipBehavior=select.value||DEFAULT_SKIP_BEHAVIOR)}},{field:"followUpCheckbox",stateKey:"followUpChecked",type:"checked",defaultValue:!1},{field:"followUpQIDsInput",stateKey:"followUpQids",type:"value",defaultValue:""},{field:"confirmButtonText",stateKey:"confirmText",type:"value",defaultValue:"",fallback:function(element){element.value||(element.value="Confirm grid")}}];globalThis.applyUserInteractionState=function(){return applyState()},"true"!==toggle.dataset.interactionHandlerAttached?(toggle.dataset.interactionHandlerAttached="true",toggle.addEventListener("change",function(){return applyState()}),applyState({skipPreview:!0,skipCapture:!0})):applyState({skipPreview:!0,skipCapture:!0})}function getDescriptorElement(descriptor){return descriptor.getElement?descriptor.getElement(formInputs):descriptor.field?formInputs[descriptor.field]:null}function applyDescriptorValue(element,descriptor,value){element&&("checked"===descriptor.type?element.checked=!!value:element.value="string"==typeof value||null!=value?value:"")}function captureState(){var state={};interactionFieldDescriptors.forEach(function(descriptor){!function(descriptor,state){if(descriptor.capture)descriptor.capture(formInputs,state);else if(descriptor.stateKey){var _element$value,element=getDescriptorElement(descriptor);element&&("checked"===descriptor.type?state[descriptor.stateKey]=!!element.checked:state[descriptor.stateKey]=null!==(_element$value=element.value)&&void 0!==_element$value?_element$value:"")}}(descriptor,state)}),storedState=state}function currentDesignFromInputs(){var _formInputs$experimen;return!(null===(_formInputs$experimen=formInputs.experimentalRadioInput)||void 0===_formInputs$experimen||!_formInputs$experimen.checked)?"experimental_scenarios":"blank_neighborhood"}function setDisabledInputs(disabled){var _formInputs$quotaInpu;((null===(_formInputs$quotaInpu=formInputs.quotaInputContainer)||void 0===_formInputs$quotaInpu?void 0:_formInputs$quotaInpu.querySelectorAll("input"))||[]).forEach(function(inp){inp.disabled=disabled})}function disableInteraction(){var _storedState;captureState(),lastKnownDesign=(null===(_storedState=storedState)||void 0===_storedState?void 0:_storedState.design)||currentDesignFromInputs(),interactionFieldDescriptors.forEach(function(descriptor){!function(descriptor){if(descriptor.disable)descriptor.disable(formInputs,storedState);else{var element=getDescriptorElement(descriptor);element&&(applyDescriptorValue(element,descriptor,function(descriptor){return"function"==typeof descriptor.defaultValue?descriptor.defaultValue():void 0!==descriptor.defaultValue?descriptor.defaultValue:"checked"!==descriptor.type&&""}(descriptor)),element.disabled=!0)}}(descriptor)}),setDisabledInputs(!0),globalThis.updateQuotaInputs&&globalThis.updateQuotaInputs(),updateFollowUpFieldVisibility()}function enableInteraction(){interactionFieldDescriptors.forEach(function(descriptor){!function(descriptor,state){var element=getDescriptorElement(descriptor);if(element?element.disabled=!1:"experimentalRadioInput"===descriptor.field&&formInputs.experimentalRadioInput&&(formInputs.experimentalRadioInput.disabled=!1),descriptor.enable)return descriptor.enable(formInputs,state),void(element&&descriptor.fallback&&descriptor.fallback(element,state,formInputs));element&&(descriptor.stateKey&&state&&Object.prototype.hasOwnProperty.call(state,descriptor.stateKey)&&applyDescriptorValue(element,descriptor,state[descriptor.stateKey]),descriptor.fallback&&descriptor.fallback(element,state,formInputs))}(descriptor,storedState)});var design,blank,experimental,designToRestore=storedState&&storedState.design||lastKnownDesign||currentDesignFromInputs();design=designToRestore,blank=formInputs.blankNeighborhoodRadio,experimental=formInputs.experimentalRadioInput,"experimental_scenarios"===design?(experimental&&(experimental.checked=!0),blank&&(blank.checked=!1)):(blank&&(blank.checked=!0),experimental&&(experimental.checked=!1)),setScenarioVisibility(design),lastKnownDesign=designToRestore,setDisabledInputs(!1),globalThis.updateQuotaInputs&&globalThis.updateQuotaInputs(),updateFollowUpFieldVisibility()}function applyState(){var _ref0=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},_ref0$skipPreview=_ref0.skipPreview,skipPreview=void 0!==_ref0$skipPreview&&_ref0$skipPreview,_ref0$skipCapture=_ref0.skipCapture,skipCapture=void 0!==_ref0$skipCapture&&_ref0$skipCapture,enabled=!toggle||toggle.checked;enabled||skipCapture||captureState(),enabled?enableInteraction():disableInteraction();var previewPane=document.getElementById("previewPane");if(previewPane&&previewPane.classList&&previewPane.classList.toggle("static-preview",!enabled),"function"==typeof globalThis.updateScenarioNavVisibility)globalThis.updateScenarioNavVisibility();else if(!enabled){var scenarioButtons=document.querySelector(".scenario-buttons");scenarioButtons&&scenarioButtons.style&&(scenarioButtons.style.display="none")}skipPreview||"function"!=typeof globalThis.buildAndUpdatePreview||globalThis.buildAndUpdatePreview()}}function initScenarioEqualProbabilityToggle(){var checkbox=document.getElementById("scenarioEqualProbability");checkbox&&"true"!==checkbox.dataset.equalProbabilityHandlerAttached&&(checkbox.addEventListener("change",function(){globalThis.toggleWeightInputs&&globalThis.toggleWeightInputs(),"function"==typeof globalThis.persistScenarioProbabilities&&globalThis.persistScenarioProbabilities(),"function"==typeof globalThis.buildAndUpdatePreview&&globalThis.buildAndUpdatePreview()}),checkbox.dataset.equalProbabilityHandlerAttached="true")}function setNextButtonVisibility(show){var btn=document.querySelector("#surveyQuestion .preview-next-button");btn&&(btn.style.display=show?"inline-block":"none")}function syncRangeWithNumber(rangeEl,numberEl,onChange){rangeEl&&numberEl&&(rangeEl.oninput=function(){numberEl.value=rangeEl.value,onChange&&onChange()},numberEl.oninput=function(){rangeEl.value=numberEl.value,onChange&&onChange()})}function initTabs(){var tabs=document.querySelectorAll(".tab-link"),contents=document.querySelectorAll(".tab-content"),previewPane=document.getElementById("previewPane"),persistentPreview=document.getElementById("persistentPreview");if(tabs.length){var tabByName=new Map;tabs.forEach(function(tab){tab.dataset&&tab.dataset.tab&&tabByName.set(tab.dataset.tab,tab)});var suppressHashChange=!1;if(tabs.forEach(function(tab,idx){tab.addEventListener("click",function(){return activate(tab)}),tab.addEventListener("keydown",function(e){if("ArrowRight"===e.key||"ArrowLeft"===e.key){e.preventDefault();var dir="ArrowRight"===e.key?1:-1,next=(idx+dir+tabs.length)%tabs.length;activate(tabs[next])}})}),"undefined"!=typeof window)if(window.addEventListener("hashchange",function(){if(suppressHashChange)suppressHashChange=!1;else if("undefined"!=typeof window){var hash=window.location.hash;hash&&activateByName(hash.slice(1))||document.querySelector(".tab-link.active")||activate(tabs[0],{skipHashUpdate:!0})}}),window.location.hash)if(activateByName(window.location.hash.slice(1)))return;activate(tabs[0],{skipHashUpdate:!0})}function activate(t){var _ref1$skipHashUpdate=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).skipHashUpdate,skipHashUpdate=void 0!==_ref1$skipHashUpdate&&_ref1$skipHashUpdate;contents.forEach(function(c){return c.style.display="none"}),tabs.forEach(function(b){b.classList.remove("active"),b.setAttribute("aria-selected","false"),b.tabIndex=-1});var panel=document.getElementById(t.dataset.tab);if(panel&&(panel.style.display="block"),previewPane)if(["save","layout","survey","tuning"].includes(t.dataset.tab)){var container=panel&&panel.querySelector(".editor-container");if(container){var w=document.getElementById("previewWidthInput"),h=document.getElementById("previewHeightInput");container.appendChild(persistentPreview),persistentPreview.style.display="block",persistentPreview.appendChild(previewPane),previewPane.style.width="".concat(w?w.value:550,"px"),previewPane.style.height="".concat(h?h.value:550,"px"),previewPane.style.display="block",setNextButtonVisibility(!1)}}else persistentPreview.appendChild(previewPane),persistentPreview.style.display="none",previewPane.style.width="".concat(550,"px"),previewPane.style.height="".concat(550,"px"),previewPane.style.display="none",setNextButtonVisibility(!1);t.classList.add("active"),t.setAttribute("aria-selected","true"),t.tabIndex=0,t.focus(),!skipHashUpdate&&t.dataset&&t.dataset.tab&&function(tabName){if("undefined"!=typeof window&&tabName){var hash="#".concat(tabName);window.location&&window.location.hash===hash||(suppressHashChange=!0,window.location.hash=hash,setTimeout(function(){suppressHashChange=!1},0))}}(t.dataset.tab)}function activateByName(name,options){var tab=tabByName.get(name);return!!tab&&(activate(tab,_objectSpread({skipHashUpdate:!0},options)),!0)}}function showCitationText(){var target=document.getElementById("citationText");target&&(target.innerHTML="Sola, Justin, and Samuel Filmeyer. 2025. <em>GRIDDY: The Grid Experiments Tool (Beta)</em>. Chapel Hill, NC: Department of Sociology & School of Data Science and Society, University of North Carolina at Chapel Hill.")}function addTabLinkListeners(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:document).querySelectorAll('a[href^="#"]').forEach(function(link){link.addEventListener("click",function(e){var href=link.getAttribute("href");if(href&&"#"!==href){var target=document.querySelector(href);if(link.classList.contains("help-link")){e.preventDefault();var saveTab=document.getElementById("tab-save");saveTab&&saveTab.click();var details=document.getElementById("helpDetails");details&&(details.open=!0,details.scrollIntoView({block:"start",behavior:"smooth"}));var scrollToTarget=function(){var helpTarget=document.querySelector(href);helpTarget&&helpTarget.scrollIntoView({block:"start",behavior:"smooth"})};scrollToTarget(),setTimeout(scrollToTarget,120)}else if(target&&target.classList.contains("tab-link"))e.preventDefault(),target.click();else if(target){var container=target.closest(".tab-content");if(container){e.preventDefault();var tabId=container.getAttribute("aria-labelledby"),tab=tabId&&document.getElementById(tabId);tab&&tab.click(),target.scrollIntoView()}}}})})}function parsePriorSelections(){var input=document.getElementById("neighborhood_prior_selections");return input&&input.value?input.value.split("|").map(function(v){return v.trim()}).filter(function(v){return""!==v}):null}function runPowerCalc(){var p1=parseFloat(document.getElementById("simProb1").value),p2=parseFloat(document.getElementById("simProb2").value),n=parseInt(document.getElementById("simN").value,10),pow=calculatePower(p1,p2,n),out=document.getElementById("simulationPower");out&&(out.textContent="Estimated power: ".concat(pow.toFixed(2)))}function buildAndUpdatePreview(){var surveyQuestionDiv=document.getElementById("surveyQuestion"),neighborhoodQuestion=new NeighborhoodQuestion(surveyQuestionDiv);scenarioUI.__setCurrentQuestion(neighborhoodQuestion);var count=document.querySelectorAll("#scenarios-container .scenario").length;scenarioUI.getCurrentScenarioIndex()>=count&&scenarioUI.setCurrentScenarioIndex(0);var formInputs=new FormInputsClass;if(formInputs.allInputs().forEach(function(input){input.oninput=function(){return handleInputChange(formInputs,neighborhoodQuestion,surveyQuestionDiv)}}),globalThis.updateQuotaInputs){var opt=formInputs.dropdownOptionsInput,en=formInputs.enableQuotasCheckbox;opt&&opt.addEventListener("input",globalThis.updateQuotaInputs),en&&en.addEventListener("change",globalThis.updateQuotaInputs),globalThis.updateQuotaInputs()}var onInputChange=function(){return handleInputChange(formInputs,neighborhoodQuestion,surveyQuestionDiv)};function fillCenterRowDefault(){var rowInput=formInputs.rowInput,centerCellRowInput=formInputs.centerCellRowInput;if(rowInput&&centerCellRowInput&&""===("string"==typeof centerCellRowInput.value?centerCellRowInput.value:"").trim()){var rows=parseInt(rowInput.value,10);if(!Number.isNaN(rows)&&rows>0){var desiredRow=String(Math.ceil(rows/2));centerCellRowInput.value!==desiredRow&&(centerCellRowInput.value=desiredRow,onInputChange())}}}function fillCenterColumnDefault(){var columnInput=formInputs.columnInput,centerCellColumnInput=formInputs.centerCellColumnInput;if(columnInput&&centerCellColumnInput&&""===("string"==typeof centerCellColumnInput.value?centerCellColumnInput.value:"").trim()){var cols=parseInt(columnInput.value,10);if(!Number.isNaN(cols)&&cols>0){var desiredColumn=String(Math.ceil(cols/2));centerCellColumnInput.value!==desiredColumn&&(centerCellColumnInput.value=desiredColumn,onInputChange())}}}syncRangeWithNumber(formInputs.gridGapRange,formInputs.gridGapInput,onInputChange),syncRangeWithNumber(formInputs.gridPaddingRange,formInputs.gridPaddingInput,onInputChange),syncRangeWithNumber(formInputs.labelFontSizeRange,formInputs.labelFontSizeInput,onInputChange),syncRangeWithNumber(formInputs.cellWidthRange,formInputs.cellWidthInput,onInputChange),syncRangeWithNumber(formInputs.cellHeightRange,formInputs.cellHeightInput,onInputChange);var scenarioContainer=document.getElementById("scenarios-container");scenarioContainer&&(scenarioContainer.oninput=function(){return handleInputChange(formInputs,neighborhoodQuestion,surveyQuestionDiv)});var traitsField=document.getElementById("experimentalTraits");traitsField&&globalThis.updateTraitProbabilityInputs&&traitsField.addEventListener("input",function(){return globalThis.updateTraitProbabilityInputs()}),addUserInteractionToggleListener(formInputs),document.getElementsByName("experiment_design").forEach(function(radio){radio.onchange=function(){radio.checked&&(setScenarioVisibility(radio.value),"function"==typeof globalThis.buildAndUpdatePreview&&globalThis.buildAndUpdatePreview(),"function"==typeof globalThis.checkProbabilitySums&&globalThis.checkProbabilitySums())},radio.checked&&(setScenarioVisibility(radio.value),"function"==typeof globalThis.checkProbabilitySums&&globalThis.checkProbabilitySums())}),addCellImageToggleListener(),addCenterCellToggleListener(),formInputs.rowInput&&formInputs.rowInput.addEventListener("change",fillCenterRowDefault),formInputs.columnInput&&formInputs.columnInput.addEventListener("change",fillCenterColumnDefault),fillCenterRowDefault(),fillCenterColumnDefault(),handleInputChange(formInputs,neighborhoodQuestion,surveyQuestionDiv),scenarioUI.highlightCurrentScenario();document.querySelector(".tab-link.active");setNextButtonVisibility(!1)}function setErrorLogFile(path){logFile=path}function logError(_x6){return _logError.apply(this,arguments)}function _logError(){return(_logError=_asyncToGenerator(_regenerator().m(function _callee6(err){var msg,fs,_t6;return _regenerator().w(function(_context7){for(;;)switch(_context7.p=_context7.n){case 0:if(msg=err&&err.stack?err.stack:String(err),console.error(msg),!globalThis.isNode){_context7.n=4;break}return fs=require("fs").promises,_context7.p=1,_context7.n=2,fs.appendFile(logFile,msg+"\n","utf8");case 2:_context7.n=4;break;case 3:_context7.p=3,_t6=_context7.v,console.error("Failed to write error log",_t6);case 4:return _context7.a(2)}},_callee6,null,[[1,3]])}))).apply(this,arguments)}function clearErrorLog(){return _clearErrorLog.apply(this,arguments)}function _clearErrorLog(){return(_clearErrorLog=_asyncToGenerator(_regenerator().m(function _callee7(){var fs;return _regenerator().w(function(_context8){for(;;)switch(_context8.p=_context8.n){case 0:if(!globalThis.isNode){_context8.n=4;break}return fs=require("fs").promises,_context8.p=1,_context8.n=2,fs.unlink(logFile);case 2:_context8.n=4;break;case 3:_context8.p=3,_context8.v;case 4:return _context8.a(2)}},_callee7,null,[[1,3]])}))).apply(this,arguments)}function fetchAndRender(el,url){return fetch(url).then(function(r){return r.text()}).then(function(md){window.marked?el.innerHTML=window.marked.parse(md):el.textContent=md}).catch(function(){})}}("undefined"!=typeof window?window:"undefined"!=typeof global?global:this);
