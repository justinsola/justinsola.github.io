<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grid Question Editor</title>
    <style>
      /* styles shared with the outputted HTML for qualtrics */
      /* Grid Styles */
      .grid-wrapper {
        overflow: auto;
        height: 75%;
        max-height: 500px;
        max-width: 500px;
        line-height: normal;
        box-sizing: border-box; /* ensure padding doesn't reduce height */
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
      }
      .grid-container {
        display: grid;
        gap: 10px;
        /* Removed justify-content to prevent centering which may cause overflow issues */
        margin: 0;
        height: 100%;
        width: 100%;
        max-height: 500px;
        max-width: 500px;
        overflow: visible;
      }

      .survey-question {
        overflow: hidden;
        max-height: 750px;
        max-width: 500px;
        white-space: pre-line;
      }
      .question {
        height: 20%;
        max-height: 100px;
        overflow: auto;
      }

      /* Cell Container */
      .cell-container {
        position: relative;
        width: 100px;
        height: 120px;
      }

      .cell-image-wrapper {
        width: 100px;
        height: 120px;
        display: inline-block; /* Match img behavior */
        line-height: 0; /* Avoid extra space below inline SVG */
      }
      .cell-image-wrapper svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      /* Cell Styles */
      .cell {
        width: 100%;
        height: auto;
        max-height: 100%;
        display: block;
      }

      /* Center Cell Styles */
      .center-cell {
        background-color: #f0f0f0;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        width: 100%;
        height: 100%;
      }

      /* Center Cell Label */
      .center-cell-label {
        font-weight: bold;
        color: #000000;
        text-align: center;
        font-size: 0.8rem; /* Adjusted font size for consistency */
        word-wrap: break-word;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 100%;
      }

      /* Content Container */
      .content-container {
        position: absolute;
        top: 50px; /* Adjusted to lower the content inside the cell */
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 90%;
      }

      /* Select Menu Styles */
      .select-menu {
        width: 100%;
        margin-top: 1px;
      }

      .select-menu select {
        width: 100%;
        padding: 1px;
        font-size: 0.8rem; /* Adjusted font size for consistency */
        border: 1px solid #cccccc;
        border-radius: 4px;
        background-color: #ffffff;
        cursor: pointer;
        color: #000000;
      }

      /* Selected Label Styles */
      .selected-label {
        font-size: 0.8rem; /* Adjusted font size to match */
        color: #000000;
        width: 85%; /* Set width to 85% of the cell */
        text-align: center;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
        margin: 1px auto 0;
      }

      /* Pre-assigned Attribute Label */
      .pre-assigned-label {
        font-size: 0.8rem; /* Adjusted font size for consistency */
        color: #000000;
        width: 85%;
        text-align: center;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
        margin-bottom: 1px;
      }

      /* Accessibility and Hover Effects */
      .select-menu select:focus,
      .select-menu select:hover {
        outline: 2px solid #007bff;
      }
      button:focus {
        outline: 2px solid #007bff;
      }

      /* Screen reader helpers */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .muted-field {
        opacity: 0.6;
      }

      .muted-field[disabled] {
        background-color: #f5f5f5;
      }

      /* Token bank styles */
      .token-bank {
        margin: 10px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }
      .token-bank-toggle,
      .skip-policy-select {
        margin-bottom: 1rem;
      }
      .token {
        padding: 2px 6px;
        background: #ececec;
        border: 1px solid #999;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: grab;
        user-select: none;
      }
      .token.disabled-option {
        cursor: not-allowed;
      }
      .token-drop {
        min-height: 16px;
        min-width: 40px;
        border: 1px dashed #bbb;
        margin-top: 2px;
      }
      .disabled-option {
        opacity: 0.5;
      }
      .locked-cell {
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          45deg,
          #cccccc,
          #cccccc 10px,
          #eeeeee 10px,
          #eeeeee 20px
        );
        pointer-events: none;
      }
    </style>
    <style>
      /* styles just for this editor/preview */

      /* Add styles for the editor page */
      body {
        font-family: Arial, Helvetica, sans-serif;
        padding: 20px;
        background-color: #f9f9f9;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      h1 {
        text-align: center;
      }
      .editor-container {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        width: 100%;
        max-width: 1200px; /* You can adjust this width */
        align-items: flex-start;
      }
      .input-section,
      .project-controls,
      .preview-panel,
      #persistentPreview {
        flex: 1 1 50%;
      }
      .preview {
        width: 550px;
        height: 550px;
        padding: 20px;
        max-height: 1500px;
        overflow: hidden;
        background: #fff;
        position: relative;
        border: 8px solid #333;
        border-radius: 6px;
        box-sizing: content-box;
      }
      #previewPane.static-preview .scenario-buttons {
        display: none !important;
      }
      .howto-content {
        width: 90%;
        max-width: 800px;
        margin: 0 auto;
      }
      @media (max-width: 700px) {
        .editor-container {
          flex-direction: column;
        }
        .editor-container .input-section,
        .editor-container .project-controls,
        .editor-container .preview-panel,
        .editor-container #persistentPreview {
          flex-basis: 100%;
          width: 100%;
        }
      }
      @media (max-width: 1250px) {
        #survey #persistentPreview,
        #tuning #persistentPreview {
          flex: 1 1 100%;
        }
      }
      .input-field {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 1rem;
      }
      .inline-group {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
      }
      .inline-group .inline-item {
        display: flex;
        flex-direction: column;
      }
      .inline-group input.input-field {
        width: 4rem;
        max-width: 100%;
      }
      #survey .editor-container,
      #tuning .editor-container {
        gap: 2rem;
        flex-wrap: wrap;
      }
      #survey .input-section,
      #tuning .input-section {
        flex: 1 1 360px;
        max-width: 520px;
      }
      #survey #persistentPreview,
      #tuning #persistentPreview {
        flex: 0 0 580px;
        max-width: 100%;
      }
      #survey .section .option-group {
        margin-top: 0.5rem;
        width: 100%;
        max-width: 520px;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      #survey .section .option-heading {
        font-weight: bold;
        margin-top: 0.5rem;
      }
      #survey .section .option-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        line-height: 1.4;
      }
      #survey .section .option-label input[type="checkbox"],
      #survey .section .option-label input[type="radio"] {
        margin: 0;
      }
      .input-error {
        border-color: darkred;
      }
      .warning-outline {
        border: 1px solid darkred;
        padding: 4px;
      }
      .error-message {
        color: red;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .required::after {
        content: "*";
        color: darkred;
        margin-right: 4px;
      }
      .help-link {
        margin-left: 5px;
        padding: 2px 6px;
        background-color: #eee;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.9rem;
      }
      .project-controls .section {
        margin-bottom: 1rem;
      }
      .project-controls h3 {
        margin: 0 0 1rem 0;
      }
      .project-controls .button-group {
        padding: 0 1rem;
      }
      .tabs {
        display: flex;
        margin-bottom: 10px;
      }
      .tab-link {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #ddd;
        border: 1px solid #ccc;
        border-bottom: none;
        margin-right: 5px;
      }
      .tab-link.active {
        background-color: #fff;
        font-weight: bold;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      #confirmModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      #confirmModal .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 4px;
        text-align: center;
      }
      #confirmModal button {
        margin: 0 5px;
      }
      .copy-feedback {
        color: green;
        margin-left: 6px;
        font-size: 0.9rem;
      }
    </style>
    <style>
      /* Inline style for scenario template moved here */
      .scenario {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        cursor: grab;
      }
      .scenario.selected {
        border-color: #007bff;
        background: #eef;
      }
      .drag-handle {
        cursor: move;
        user-select: none;
        margin-right: 6px;
      }
    </style>
    <style>
      .about-footer {
        margin-top: 20px;
        font-size: 0.9rem;
        color: #505050;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>Grid Question Editor</h1>
    <div id="taskManager" style="margin-bottom: 10px">
      <label for="taskSelect">Tasks:</label>
      <select id="taskSelect"></select>
      <span id="linkedContainer" style="margin-left: 6px; display: none">
        <label for="linkSelect">Linked to:</label>
        <select id="linkSelect"></select>
      </span>
      <button onclick="addTask()">New</button>
      <button onclick="renameTask()">Rename</button>
      <button onclick="deleteTask()">Delete</button>
    </div>
    <div class="tabs" role="tablist">
      <button
        class="tab-link"
        data-tab="save"
        id="tab-save"
        role="tab"
        aria-controls="save"
        aria-selected="false"
        tabindex="-1"
      >
        Save &amp; Help
      </button>
      <button
        class="tab-link"
        data-tab="layout"
        id="tab-layout"
        role="tab"
        aria-controls="layout"
        aria-selected="false"
        tabindex="-1"
      >
        Layout
      </button>
      <button
        class="tab-link"
        data-tab="survey"
        id="tab-survey"
        role="tab"
        aria-controls="survey"
        aria-selected="false"
        tabindex="-1"
      >
        Survey
      </button>
      <button
        class="tab-link"
        data-tab="tuning"
        id="tab-tuning"
        role="tab"
        aria-controls="tuning"
        aria-selected="false"
        tabindex="-1"
      >
        Tuning
      </button>
      <button
        class="tab-link"
        data-tab="howto"
        id="tab-howto"
        role="tab"
        aria-controls="howto"
        aria-selected="false"
        tabindex="-1"
      >
        Qualtrics How-To
      </button>
    </div>

    <div
      id="save"
      class="tab-content"
      role="tabpanel"
      aria-labelledby="tab-save"
    >
      <div class="editor-container">
        <div class="project-controls">
          <div class="section">
            <h3>Export</h3>
            <div class="button-group">
              <button onclick="copyQualtricsHTML(this)">
                Copy Qualtrics HTML
              </button>
              <button onclick="copyQualtricsJS(this)">
                Copy Qualtrics Javascript
              </button>
              <button onclick="downloadQualtricsFiles()">
                Download Qualtrics Files
              </button>
            </div>
          </div>
          <div class="section">
            <h3>Save / Load</h3>
            <div class="button-group">
              <button onclick="downloadPortfolio()">Save</button>
              <button onclick="triggerPortfolioInput()">Load</button>
              <input
                type="file"
                id="file-upload"
                style="display: none"
                onchange="uploadPortfolio(this.files[0])"
              />
            </div>
          </div>
          <fieldset class="section" id="resetFieldset">
            <legend>Reset</legend>
            <button
              onclick="confirmResetInputs()"
              title="Reset values on every tab"
            >
              Reset All Inputs
            </button>
            <small>Applies to every tab</small>
          </fieldset>
          <div
            class="section citation-section"
            style="color: #505050; font-size: 0.8rem"
          >
            <br />Please cite:<br />
            <div id="citationText"></div>
          </div>
        </div>
      </div>
      <details id="helpDetails">
        <summary>Help</summary>
        <div class="howto-content"><p><a id="help"></a></p>
<h1>Using the Grid Editor</h1>


<p>The editor lets you build a grid question for surveys. The examples below use characters from <em>The Lord of the Rings</em> to illustrate each tab. See the <a href="#qualtrics-howto">Qualtrics Implementation Guide</a> for instructions on embedding the generated question. Clicking the link opens the Qualtrics How-To tab automatically.</p>
<p><a id="save-doc"></a></p>
<h2>Save &amp; Help Tab</h2>
<p>Export the Qualtrics HTML and JavaScript or save your configuration as a JSON file so you can reload it later. The recommended citation is shown in ASA style. The <strong>Reset All Inputs</strong> button now asks for confirmation before clearing every tab and returns keyboard focus to the trigger after the dialog closes.</p>
<h2>Tasks</h2>
<p>Use the task selector at the top to manage multiple grid setups in one portfolio. Create, rename or delete tasks and switch between them without losing progress. The <a href="#save-doc">Save &amp; Help</a> buttons export or import the entire portfolio as JSON. Your portfolio is also saved to your browser so tasks persist between visits. Any corrupt saved data will be cleared automatically.</p>
<h2>Layout Tab</h2>
<p>Configure the overall layout: question text, number of rows and columns, the label for the centre cell, the image used for cells and an optional background image. For example, set three rows and three columns to create nine cells and label the centre cell &quot;Bag End&quot; to represent the hobbits&#39; home.</p>
<p>Background image links must use <code>http</code> or <code>https</code> or be a relative path. Other URL schemes are blocked for security.</p>
<p>The cell image defaults to a simple SVG. Uncheck <strong>Use default cell image</strong> to upload a picture or paste your own SVG.</p>
<p>Enable <em>drag and drop</em> in the <a href="#survey-doc">Survey</a> tab to place traits by moving tokens onto cells. When quotas are also enabled each token shows the remaining uses. Otherwise one token per trait stays in the bank and can be reused.</p>
<p><strong>Incomplete grid policy</strong> controls what happens when participants try to continue without filling every cell. The default &quot;Remind once&quot; option shows a pop-up and lets them skip. &quot;Allow skipping&quot; never warns, while &quot;Require completion&quot; insists all cells are filled. Your chosen policy is saved alongside the other settings and restored when loading a JSON configuration.</p>
<p>To disable specific cells, pass an array of <code>{row, col}</code> objects as the <code>lockedCells</code> parameter when calling <code>renderQuestion</code>. Locked cells appear with a hatched overlay and cannot be selected. They are still included when an experimental scenario assigns traits.</p>
<p><a id="survey-doc"></a></p>
<h2>Survey Tab</h2>
<p>Define dropdown options and whether you want an experimental setup. You might list <code>Hobbits, Dwarves, Elves, Rohirrim</code> as options. The <strong>User interaction</strong> toggle controls whether participants can manipulate the grid themselves. When it is <em>off</em> the editor locks the question into whichever experimental scenario you export; the preview illustrates the static layout that participants will see.</p>
<p>With interaction disabled the following controls become unavailable because they rely on live input: <strong>Use quotas</strong>, <strong>Drag &amp; drop</strong>, <strong>Follow-up QIDs</strong> (for gating later questions), and the custom <strong>Confirm &amp; Next</strong> button. Leave interaction enabled whenever you need those behaviours.</p>
<p><a id="experimental-scenarios"></a></p>
<h3>Building Experimental Scenarios</h3>
<p>Switch the <strong>Design</strong> toggle to <em>Experimental</em> to reveal the scenario builder. Start by entering the comma-separated list of traits that every scenario can draw from. Press <strong>+ Scenario</strong> to add as many rows as you need—each scenario has a title, layout style and comma-separated counts or weights. Use descriptive names like &quot;Riders Arrive&quot; so you can tell scenarios apart when randomizing the preview.</p>
<p>Each scenario offers a <em>layout style</em>:</p>
<ul>
<li><strong>Weighted</strong> draws for each cell using the probabilities, so counts may vary but tend toward <code>4,3,1,1</code> overall.</li>
<li><strong>Shuffle</strong> places exactly four Hobbits, three Dwarves, one Elf and one Rohirrim but shuffles their positions.</li>
<li><strong>Fixed</strong> fills the grid in the listed order (first four cells Hobbits, next three Dwarves, etc.) for a deterministic layout.</li>
</ul>
<p>Probabilities may be entered as percentages (e.g., <code>25%</code>) or fractions (e.g., <code>1/4</code>) and must sum to 1. Toggle <strong>Equal probability</strong> to keep every scenario at the same chance automatically; disable it to edit the probability inputs directly. When the toggle is off you can type probabilities for each scenario, and the editor will normalize them if they do not add up perfectly.</p>
<p>Scenarios can be <strong>duplicated</strong> using the copy button and rearranged by dragging the handle beside each scenario. The order matters when using the <em>Fixed</em> layout style, so drag and drop provides a quick way to refine your experiment. Use the trash button to remove unused scenarios; the editor renumbers everything and preserves names automatically.</p>
<p>Click <strong>Randomize Scenario</strong> in the preview to see different draws using the current probabilities. When you export your question the randomizer uses the same logic, and the selected scenario name is stored alongside the response for downstream analysis.</p>
<p>Turn on <em>Use quotas</em> to limit how many times each dropdown option may be chosen. With drag and drop active the token bank displays the remaining count for each option. If quotas add up to more tokens than cells you&#39;ll see a warning but all tokens remain available.</p>
<h2>Tuning Tab</h2>
<p>Adjust visual spacing with the gap and padding settings. When comparing communities like Hobbits, Dwarves, Elves, or Rohirrim you might increase the gap to make each cell easier to distinguish. Preview width and height (550px by default) can also be set here. Use the <strong>Reset Tuning</strong> button to restore the default gap, padding, font size, cell dimensions and preview size without affecting other tabs.</p>
<h2>Qualtrics How-To Tab</h2>
<p>Provides a step-by-step guide for inserting the generated code into Qualtrics. Consult the <a href="#qualtrics-howto">Markdown instructions</a> explaining how to deploy your survey asking who lives where in Middle-earth.</p>
<h2>Input Validation</h2>
<p>The editor warns about invalid entries such as negative numbers or mismatched probabilities. Errors highlight the offending fields and the live preview is disabled until everything is corrected. This prevents exporting a broken question to Qualtrics.</p>
<h2>Security</h2>
<p>Any HTML you enter for the question text, centre label or custom SVG image is sanitized before being displayed or exported. Script tags, event handlers and <code>javascript:</code> URLs are stripped to prevent unintended behaviour in your survey.</p></div>
      </details>
    </div>
    <div
      id="layout"
      class="tab-content"
      role="tabpanel"
      aria-labelledby="tab-layout"
    >
      <div class="editor-container">
        <div class="input-section">
          <div
            id="errorMessage"
            class="error-message"
            role="alert"
            aria-live="polite"
          ></div>
          <div class="section">
            <label for="questionTextInput">Question text</label>
            <textarea
              id="questionTextInput"
              class="input-field"
              rows="4"
              cols="50"
              placeholder="Who lives where? Fill in the grid:"
            >
Who lives where? Fill in the grid:</textarea
            >
            <div class="inline-group">
              <div class="inline-item">
                <label for="columnInput" class="required"># of columns</label>
                <input
                  type="number"
                  id="columnInput"
                  class="input-field"
                  min="1"
                  max="10"
                  step="1"
                  value="3"
                />
              </div>
              <div class="inline-item">
                <label for="rowInput" class="required"># of rows</label>
                <input
                  type="number"
                  id="rowInput"
                  class="input-field"
                  min="1"
                  max="10"
                  step="1"
                  value="3"
                />
              </div>
            </div>
            <input type="checkbox" id="enableCenterCell" checked />
            <label for="enableCenterCell">Include labeled cell</label>
            <label for="centerCellTextInput">Cell label</label>
            <input
              type="text"
              id="centerCellTextInput"
              class="input-field"
              placeholder="Default: Your House"
            />
            <div id="centerCellPositionInputs" class="inline-group">
              <div class="inline-item">
                <label for="centerCellColumnInput">Cell column</label>
                <input
                  type="number"
                  id="centerCellColumnInput"
                  class="input-field"
                  min="1"
                  step="1"
                />
              </div>
              <div class="inline-item">
                <label for="centerCellRowInput">Cell row</label>
                <input
                  type="number"
                  id="centerCellRowInput"
                  class="input-field"
                  min="1"
                  step="1"
                />
              </div>
            </div>
            <div class="default-cell-toggle">
              <input
                type="checkbox"
                id="defaultCellCheckbox"
                checked
                aria-controls="customCellInputs"
                aria-expanded="false"
              />
              <label for="defaultCellCheckbox">Use default cell image</label>
            </div>
            <div
              id="customCellInputs"
              role="group"
              hidden
              aria-hidden="true"
              aria-labelledby="customCellOptionsHeading"
            >
              <p id="customCellOptionsHeading" class="sr-only">
                Custom cell image options
              </p>
              <label for="cellImageMethod">Cell image source</label>
              <select id="cellImageMethod" class="input-field">
                <option value="file">Upload File</option>
                <option value="svg">Paste SVG</option>
                <option value="url">Image URL</option>
              </select>
              <div id="cellImageFileContainer">
                <label for="cellImageFile">Cell image file</label>
                <input
                  type="file"
                  id="cellImageFile"
                  class="input-field"
                  accept=".svg,image/svg+xml,image/png,image/jpeg"
                />
              </div>
              <div id="cellImageSVGContainer">
                <label for="cellImageSVG">Paste SVG</label>
                <textarea
                  id="cellImageSVG"
                  class="input-field"
                  rows="3"
                  placeholder="&lt;svg&gt;...&lt;/svg&gt;"
                ></textarea>
              </div>
              <div id="cellImageURLContainer">
                <label for="cellImageURL">Image URL</label>
                <input
                  type="url"
                  id="cellImageURL"
                  class="input-field"
                  placeholder="https://example.com/cell.svg"
                />
              </div>
            </div>
            <label for="backgroundImageURL">Background image URL</label>
            <input
              type="url"
              id="backgroundImageURL"
              class="input-field"
              placeholder="https://example.com/map.png"
            />
            <details class="advanced-options">
              <summary>Advanced Options</summary>
              <div class="skip-policy-select">
                <label for="skipBehaviorSelect">Incomplete grid policy</label>
                <select
                  id="skipBehaviorSelect"
                  class="input-field"
                  value="remind"
                >
                  <option value="remind" selected>Remind once (default)</option>
                  <option value="allow">Allow skipping (advanced)</option>
                  <option value="force">Require completion (advanced)</option>
                </select>
              </div>
              <label
                title="Hide follow-up questions until the grid is confirmed"
              >
                <input type="checkbox" id="followUpCheckbox" /> Follow-up QIDs
                (advanced)
              </label>
              <label for="followUpQIDsInput">Follow-up QIDs</label>
              <input
                type="text"
                id="followUpQIDsInput"
                class="input-field"
                placeholder="QID2,QID3"
                aria-describedby="followUpHint followUpStateHint"
              />
              <label for="confirmButtonText">Confirm button text</label>
              <input
                type="text"
                id="confirmButtonText"
                class="input-field"
                value="Confirm grid"
                aria-describedby="followUpStateHint"
              />
              <p id="followUpHint" class="sr-only">
                Enter the Qualtrics QIDs for follow-up questions, separated by
                commas.
              </p>
              <p
                id="followUpStateHint"
                class="sr-only"
                aria-live="polite"
              ></p>
            </details>
          </div>
          <div id="persistentPreview">
            <div id="previewPane" class="preview">
              <h2>Live Preview</h2>
              <div id="warnings" style="color: darkred"></div>
              <div class="survey-question" id="surveyQuestion"></div>
              <div id="scenarioNameIndicator"></div>
              <div class="scenario-buttons">
                <button type="button" onclick="prevScenario()">
                  Previous Scenario
                </button>
                <button type="button" onclick="nextScenario()">
                  Next Scenario
                </button>
                <button type="button" onclick="randomizeScenario()">
                  Randomize Scenario
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="survey"
      class="tab-content"
      role="tabpanel"
      aria-labelledby="tab-survey"
    >
      <div class="editor-container">
        <div class="input-section">
          <div class="section">
            <label for="dropdownOptionsInput" class="required">
              Dropdown options (comma separated)</label
            >
            <input
              type="text"
              id="dropdownOptionsInput"
              class="input-field"
              value="Dwarves, Elves, Hobbits, Rohirrim"
            />
            <div class="option-group">
              <label
                class="option-label"
                title="Limit how many times each option may be selected"
              >
                <input type="checkbox" id="enableQuotas" />
                <span>Use quotas</span>
              </label>
              <div id="quotaInputContainer" class="inline-group"></div>
              <input type="hidden" id="optionQuotaInput" />
              <label
                class="option-label"
                title="Allow participants to fill in the grid themselves"
              >
                <input type="checkbox" id="userInteractionCheckbox" checked />
                <span>
                  Allow participant interaction (uncheck for static experimental
                  grid)
                </span>
              </label>
              <label
                class="option-label"
                title="Drag traits onto cells instead of using dropdowns"
              >
                <input type="checkbox" id="dragDropCheckbox" />
                <span>Enable drag &amp; drop</span>
              </label>
              <p class="option-heading">Design</p>
              <label class="option-label">
                <input
                  type="radio"
                  id="blankNeighborhoodDesignSelector"
                  name="experiment_design"
                  value="blank_neighborhood"
                  checked
                />
                <span>Survey</span>
              </label>
              <label class="option-label">
                <input
                  type="radio"
                  id="experimentalDesignSelector"
                  name="experiment_design"
                  value="experimental_scenarios"
                />
                <span>Experimental</span>
              </label>
            </div>
            <div id="experimentalScenariosContent" style="display: none">
              <label for="experimentalTraits" class="required">
                Experimental traits (comma-separated)</label
              >
              <input type="text" id="experimentalTraits" class="input-field" />
              <label for="experimentalProportions" class="required">
                Experimental scenarios</label
              >
              <a href="#experimental-scenarios" class="help-link">Help</a>
              <div id="scenarioProbabilitySection" style="display: none">
                <label>
                  <input
                    type="checkbox"
                    id="scenarioEqualProbability"
                    checked
                  />
                  Equal probability
                </label>
                <div
                  id="scenarioProbabilityInputs"
                  class="scenario-probabilities"
                  style="display: none"
                ></div>
              </div>

              <div id="experimentalProportions">
                <div id="scenarios-container"></div>
                <button
                  id="addScenarioBtn"
                  type="button"
                  onclick="addScenario()"
                  aria-label="Add scenario"
                >
                  + Scenario
                </button>
                <small
                  id="scenarioLimitWarning"
                  style="display: none; color: red; margin-left: 4px"
                  >Scenario limit reached</small
                >
              </div>

              <template id="scenario-template">
                <div class="scenario" draggable="true">
                  <span class="drag-handle" title="Drag to reorder"
                    >&#x2630;</span
                  >
                  <label class="scenario-label">Scenario:</label><br />
                  <input
                    type="text"
                    name="scenarioName"
                    placeholder="Name (e.g. Majority Chocolate)"
                    class="input-field"
                    aria-label="Scenario name"
                  />
                  <label
                    ><input type="checkbox" name="equalProbability" checked />
                    Equal probability</label
                  >
                  <div class="trait-probabilities" style="display: none"></div>
                  <select
                    name="layoutStyle"
                    class="input-field"
                    aria-label="Layout style"
                  >
                    <option value="weighted" selected>Weighted</option>
                    <option value="shuffle">Shuffle</option>
                    <option value="fixed">Fixed</option>
                  </select>
                  <button type="button" onclick="duplicateScenario(this)">
                    Duplicate
                  </button>
                  <button type="button" onclick="removeScenario(this)">
                    Remove
                  </button>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="tuning"
      class="tab-content"
      role="tabpanel"
      aria-labelledby="tab-tuning"
    >
      <div class="editor-container">
        <div class="input-section">
          <div class="section">
            <label for="gridGapRange">Grid gap (px)</label>
            <div class="range-pair">
              <input
                type="range"
                id="gridGapRange"
                min="0"
                max="100"
                value="10"
              />
              <input
                type="number"
                id="gridGapInput"
                class="input-field"
                min="0"
                max="100"
                value="10"
                aria-label="Grid gap in pixels"
              />
            </div>
            <label for="gridPaddingRange">Grid padding (px)</label>
            <div class="range-pair">
              <input
                type="range"
                id="gridPaddingRange"
                min="0"
                max="100"
                value="0"
              />
              <input
                type="number"
                id="gridPaddingInput"
                class="input-field"
                min="0"
                max="100"
                value="0"
                aria-label="Grid padding in pixels"
              />
            </div>
            <label for="labelFontSizeRange">Label Font Size (rem)</label>
            <div class="range-pair">
              <input
                type="range"
                id="labelFontSizeRange"
                min="0.5"
                max="2"
                step="0.05"
                value="1"
              />
              <input
                type="number"
                id="labelFontSizeInput"
                class="input-field"
                min="0.5"
                max="2"
                step="0.05"
                value="1"
                aria-label="Label font size in rem"
              />
            </div>
            <label for="cellWidthRange">Cell Width (px)</label>
            <div class="range-pair">
              <input
                type="range"
                id="cellWidthRange"
                min="80"
                max="150"
                step="1"
                value="100"
              />
              <input
                type="number"
                id="cellWidthInput"
                class="input-field"
                min="80"
                max="150"
                step="1"
                value="100"
                aria-label="Cell width in pixels"
              />
            </div>
            <label for="cellHeightRange">Cell Height (px)</label>
            <div class="range-pair">
              <input
                type="range"
                id="cellHeightRange"
                min="100"
                max="180"
                step="1"
                value="120"
              />
              <input
                type="number"
                id="cellHeightInput"
                class="input-field"
                min="100"
                max="180"
                step="1"
                value="120"
                aria-label="Cell height in pixels"
              />
            </div>
            <label for="previewWidthInput">Preview width (px)</label>
            <input
              type="number"
              id="previewWidthInput"
              class="input-field"
              min="320"
              max="1024"
              value="550"
            />
            <label for="previewHeightInput">Preview height (px)</label>
            <input
              type="number"
              id="previewHeightInput"
              class="input-field"
              min="480"
              max="900"
              value="550"
            />
          </div>
          <fieldset class="section">
            <legend>Reset</legend>
            <button onclick="resetTuningInputs()" title="Reset tuning values">
              Reset Tuning
            </button>
          </fieldset>
        </div>
      </div>
    </div>

    <div
      id="howto"
      class="tab-content"
      role="tabpanel"
      aria-labelledby="tab-howto"
    >
      <div class="howto-content"><p><a id="qualtrics-howto"></a></p>
<h1>Qualtrics Implementation Guide</h1>
<p><em>Last updated: 2025-07-01</em></p>


<p>This tool lets you design a grid question and export the HTML and JavaScript necessary for a Qualtrics survey question. For a walkthrough of each editing tab see <a href="#help" class="help-link">the help guide</a>.</p>
<h2>Steps to Use</h2>
<ol>
<li>Configure your grid using the <strong>Layout</strong>, <strong>Survey</strong>, and <strong>Tuning</strong> tabs. The editor highlights invalid fields and disables the preview until everything is corrected.</li>
<li>In the <strong>Survey</strong> tab each experimental scenario chooses a layout style:<ul>
<li><strong>Weighted</strong> – traits are assigned using probabilities.</li>
<li><strong>Shuffle</strong> – exact counts are shuffled into random order.</li>
<li><strong>Fixed</strong> – traits remain in the order listed.
Choose the style that matches your experimental design. Scenarios can be <strong>duplicated</strong> and dragged to reorder. Enter the
trait distribution for each scenario in the field labelled
&quot;Trait distribution (e.g., 50%, 30%, 20%)&quot;. Probabilities may be written as percentages or fractions and must sum to 1.</li>
</ul>
</li>
<li>In the <strong>Save &amp; Help</strong> tab click <strong>Copy Qualtrics HTML</strong> and <strong>Copy Qualtrics JavaScript</strong>. Paste the copied HTML into a <em>Descriptive Text</em> question and the JS into that question&#39;s <em>JavaScript</em> editor in Qualtrics. You can also use <strong>Download Qualtrics Files</strong> to save an HTML and JS file for each task in your portfolio. When you export with <strong>User interaction</strong> disabled the static render keeps the native Qualtrics <strong>Next</strong> button visible and immediately records the embedded data values as soon as the page loads.</li>
<li>Add the following <em>Embedded Data</em> fields to your Survey Flow before the question:<ul>
<li><code>neighborhood_question_chosen_labels</code></li>
<li><code>neighborhood_question_experimental_scenario_name</code></li>
</ul>
</li>
</ol>
<ul>
<li><code>neighborhood_question_experimental_scenario_weight</code> (records the scenario&#39;s configured probability value)</li>
<li><code>neighborhood_question_experimental_proportions</code> (trait distribution)</li>
<li><code>neighborhood_question_experimental_labels</code></li>
</ul>
<p>These fields will receive the responses generated when the participant clicks <strong>Next</strong>. In static exports (with interaction disabled) the embedded data is written immediately so the native Qualtrics navigation works without the custom confirmation step.</p>
<p>For a minimal deployment only <code>neighborhood_question_chosen_labels</code> is required. The remaining fields are used when the experimental design option is enabled. <strong>Follow-up QIDs</strong> only hide subsequent questions when interaction remains enabled.</p>
<h2>Page Layout Tips</h2>
<ul>
<li>Place only <strong>one</strong> grid question on each Qualtrics page.</li>
<li>Regular Qualtrics questions may appear below the grid so participants can answer follow-ups while keeping the grid visible.</li>
<li>With <strong>User interaction</strong> enabled the grid displays a custom <strong>Confirm &amp; Next</strong> button that submits responses and advances to the next page. Disable interaction to fall back to the standard Qualtrics <strong>Next</strong> button and a static scenario preview.</li>
<li><strong>Follow-up QIDs</strong> only hide follow-up questions (enter their QIDs) and the Next button when interaction is enabled and participants must confirm the grid.</li>
</ul>
<h2>Experimental Scenarios {#experimental-scenarios}</h2>
<p>Scenario definitions from the <strong>Survey</strong> tab are embedded into the exported JavaScript. When your Qualtrics question loads, one scenario is chosen at random according to its probability. The selected scenario name and probability populate the relevant Embedded Data fields so you know which distribution each participant saw.</p>
<h3>Capturing and Re‑using Responses</h3>
<p>The script exposes an <code>exportSelections()</code> method on <code>NeighborhoodQuestion</code>.
It returns the chosen labels along with any experimental metadata. When the
participant clicks <strong>Next</strong>, these values are automatically stored in the
Embedded Data fields listed above.</p>
<p>To carry responses forward to another grid question, place a hidden input in
that question&#39;s HTML:</p>
<pre><code class="language-html">&lt;input
  type=&quot;hidden&quot;
  id=&quot;neighborhood_prior_selections&quot;
  value=&quot;${e://Field/neighborhood_question_chosen_labels}&quot;
/&gt;
</code></pre>
<p>When the grid initializes it will read this input and pre‑select the prior
labels.</p>
<h3>Quotas and Drag &amp; Drop</h3>
<p>Quotas restrict how many times each dropdown option may be used. Check <strong>Use quotas</strong> in the Survey tab and fill in every quota field. Enable <strong>Drag &amp; drop</strong> if you want participants to place tokens instead of choosing from dropdowns. When both options are on, the token bank shows how many uses remain for each option; otherwise one reusable token per trait is shown. If the quotas add up to more tokens than cells a warning appears but all tokens remain available. After adjusting these settings copy the HTML and JavaScript again. See <a href="#help" class="help-link">the help guide</a> for screenshots and further details.</p>
<h3>Simulating responses</h3>
<p>The generated <code>grid_editor.js</code> exposes three helper functions:
<code>generateRandomResponses(options, n)</code>,
<code>calculatePower(p1, p2, n, alpha = 0.05, reps = 1000, rng = Math.random)</code> and
<code>runPowerCalc()</code>.
Use them from the browser console to explore expected variation or
approximate the statistical power of a two‑group comparison.</p></div>
    </div>

    <div
      id="confirmModal"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
      aria-labelledby="confirmModalTitle"
      aria-describedby="confirmModalDesc"
    >
      <div class="modal-content">
        <h2 id="confirmModalTitle">Incomplete grid</h2>
        <p id="confirmModalDesc">
          Some cells are unfilled. You may need to scroll to see all cells.
          Click Cancel to finish filling in cells or Continue to submit partly
          empty.
        </p>
        <button id="confirmOk">Continue</button>
        <button id="confirmCancel">Cancel</button>
      </div>
    </div>

    <script src="grid_editor.js"></script>
    <!-- Simulation tab is hidden while the feature is redesigned -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const el = document.getElementById("cellImageSVG");
        if (el && typeof DEFAULT_CELL_SVG !== "undefined") {
          el.value = DEFAULT_CELL_SVG;
          el.defaultValue = DEFAULT_CELL_SVG;
        }
        const toggle = document.getElementById("defaultCellCheckbox");
        const custom = document.getElementById("customCellInputs");
        const method = document.getElementById("cellImageMethod");
        const fileC = document.getElementById("cellImageFileContainer");
        const svgC = document.getElementById("cellImageSVGContainer");
        const urlC = document.getElementById("cellImageURLContainer");
        function updateVisibility() {
          if (custom)
            custom.style.display = toggle && toggle.checked ? "none" : "block";
          updateMethod();
        }
        function updateMethod() {
          if (!method) return;
          if (fileC)
            fileC.style.display = method.value === "file" ? "block" : "none";
          if (svgC)
            svgC.style.display = method.value === "svg" ? "block" : "none";
          if (urlC)
            urlC.style.display = method.value === "url" ? "block" : "none";
        }
        if (method) method.addEventListener("change", updateMethod);
        if (toggle) toggle.addEventListener("change", updateVisibility);
        updateVisibility();
      });
      window.addEventListener("error", async (e) => {
        await logError(e.error || e.message);
      });
      window.addEventListener("unhandledrejection", async (e) => {
        await logError(e.reason);
      });
    </script>
    <footer class="about-footer" id="about">
      <p>
        For feedback or collaboration, email
        <a href="mailto:jlsola@unc.edu">jlsola@unc.edu</a>.
      </p>
    </footer>
  </body>
</html>
